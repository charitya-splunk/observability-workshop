<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.125.5"><meta name=generator content="Relearn 6.0.0+tip"><meta name=description content="Learn how to enable Open Telemetry (Auto) Instrumentation for your Java-based application running in Kubernetes. Experience real-time monitoring and troubleshooting to help you maximize application behavior with end-to-end visibility."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Workshop using the Java microservices Pet Clinic demo (Kubernetes-based). :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="Learn how to enable Open Telemetry (Auto) Instrumentation for your Java-based application running in Kubernetes. Experience real-time monitoring and troubleshooting to help you maximize application behavior with end-to-end visibility."><meta property="og:url" content="https://splunk.github.io/observability-workshop/observability-workshop/v5.55/en/other/3-auto-instrumentation/3-java-microservices-k8s/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Workshop using the Java microservices Pet Clinic demo (Kubernetes-based). :: Splunk Observability Cloud Workshops"><meta property="og:description" content="Learn how to enable Open Telemetry (Auto) Instrumentation for your Java-based application running in Kubernetes. Experience real-time monitoring and troubleshooting to help you maximize application behavior with end-to-end visibility."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Workshop using the Java microservices Pet Clinic demo (Kubernetes-based). :: Splunk Observability Cloud Workshops"><meta itemprop=description content="Learn how to enable Open Telemetry (Auto) Instrumentation for your Java-based application running in Kubernetes. Experience real-time monitoring and troubleshooting to help you maximize application behavior with end-to-end visibility."><meta itemprop=dateModified content="2024-03-22T11:21:03+00:00"><meta itemprop=wordCount content="234"><title>Workshop using the Java microservices Pet Clinic demo (Kubernetes-based). :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/observability-workshop/v5.55/en/other/3-auto-instrumentation/3-java-microservices-k8s/index.html rel=canonical type=text/html title="Workshop using the Java microservices Pet Clinic demo (Kubernetes-based). :: Splunk Observability Cloud Workshops"><link href=../../../../images/favicon.ico?1715859593 rel=icon type=image/x-icon sizes=any><link href=../../../../css/fontawesome-all.min.css?1715859607 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fontawesome-all.min.css?1715859607 rel=stylesheet></noscript><link href=../../../../css/nucleus.css?1715859607 rel=stylesheet><link href=../../../../css/auto-complete.css?1715859607 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/auto-complete.css?1715859607 rel=stylesheet></noscript><link href=../../../../css/perfect-scrollbar.min.css?1715859607 rel=stylesheet><link href=../../../../css/fonts.css?1715859607 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fonts.css?1715859607 rel=stylesheet></noscript><link href=../../../../css/theme.css?1715859607 rel=stylesheet><link href=../../../../css/theme-splunk-light.css?1715859607 rel=stylesheet id=R-variant-style><link href=../../../../css/chroma-relearn-light.css?1715859607 rel=stylesheet id=R-variant-chroma-style><link href=../../../../css/variant.css?1715859607 rel=stylesheet><link href=../../../../css/print.css?1715859607 rel=stylesheet media=print><link href=../../../../css/format-print.css?1715859607 rel=stylesheet><script src=../../../../js/variant.js?1715859607></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/observability-workshop/v5.55",window.index_js_url="../../../../en/index.search.js",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"eu0",rumAccessToken:"TR9BBfgYo7qJfqrfgqjoqA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"eu0",rumAccessToken:"TR9BBfgYo7qJfqrfgqjoqA"})</script></script><style>:root{--MAIN-WIDTH-MAX:1000rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/other/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/other/3-auto-instrumentation/index.html><span itemprop=name>Auto-Instrumentation Workshops</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>PetClinic Java Microservices Workshop (Kubernetes)</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../../../../en/other/3-auto-instrumentation/2-nodejs/6-logs/index.html title="Logs - Payment Service (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/10-preparation/index.html title="Preparation of the Pet Clinic application. (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=workshop-using-the-java-microservices-pet-clinic-demo-kubernetes-based>Workshop using the Java microservices Pet Clinic demo (Kubernetes-based).</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Pieter Hagen</span></span><p>The goal of this workshop is to introduce the features of Splunk&rsquo;s Opentelemetry Java Auto instrumentation.
First, we create the workshop scenario, by installing a simple Java microservices application in Kubernetes.
We then walk through the basic steps to set up the OpenTelemetry Collector in Kubernetes and enable auto-instrumentation on the existing Java application running in Kubernetes. This will start sending Opentelemetry signals to the <strong>Splunk Observability Cloud</strong> platform and enable the following components:</p><ul><li>Splunk Infrastructure Monitoring (IM)</li><li>Splunk Auto Instrumentation for Java (APM)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li></ul><ul><li>Splunk Log Observer (LO)</li></ul><p>We will show the steps about how to clone (download) a sample microservices Java application (Spring PetClinic), as well as how to compile, package and deploy/run the application.</p><p>Once the application is up and running, we will examine the default metrics sent by the Opentelemetry Collector in the <strong>Splunk Observability UI</strong> Next, when auto instrumentation is enabled we will start seeing metrics and traces created via the <strong>Auto Instrumentation</strong> for Java that will be used by the <strong>Splunk APM</strong> product.</p><p>We also will examine Always-on Profiling and Database Query performance.</p><p>Lastly, we will configure the Spring PetClinic application to inject trace information into the application logs and send them to <strong>Splunk Cloud</strong>.</p><p><div class="box notices cstyle primary"><div class=box-label><i class="fa-fw fas fa-info"></i> Prerequisites</div><div class=box-content><ul><li>Outbound SSH access to port <code>2222</code>.</li><li>Outbound HTTP access to port <code>81</code>.</li><li>Familiarity with the <code>bash</code> shell and <code>vi/vim/nano</code> editor.</li></ul></div></div><a href=#R-image-ee0bf24890558fa7202e40ed180ba8c5 class=lightbox-link><img alt="Splunk Otel Architecture" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../observability-workshop/observability-workshop/v5.55/en/other/3-auto-instrumentation/3-java-microservices-k8s/images/auto-instrumentation-java-diagram.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ee0bf24890558fa7202e40ed180ba8c5><img alt="Splunk Otel Architecture" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../observability-workshop/observability-workshop/v5.55/en/other/3-auto-instrumentation/3-java-microservices-k8s/images/auto-instrumentation-java-diagram.png></a></p><hr><p>Based on the <a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/examples/enable-operator-and-auto-instrumentation/spring-petclinic-java.md rel=external target=_blank>example</a> <strong>Josh Voravong</strong> has created.</p><footer class=footline><span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Pieter Hagen
</span></span>&nbsp;
<span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Mar 22, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Workshop using the Java microservices Pet Clinic demo (Kubernetes-based).</h1><article class=default><header class=headline></header><h1 id=preparation-of-the-pet-clinic-application>Preparation of the Pet Clinic application.</h1><h2 id=1-validate-the-settings-for-your-workshop>1. Validate the settings for your workshop</h2><p>The instructor will provide you with the login information for the instance that we will be using during the workshop.
When you first log into your instance, you will be greeted by the Splunk Logo as shown below:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>❯ ssh -p 2222 splunk@[IP-ADDRESS]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>███████╗██████╗ ██╗     ██╗   ██╗███╗   ██╗██╗  ██╗    ██╗  
</span></span><span class=line><span class=cl>██╔════╝██╔══██╗██║     ██║   ██║████╗  ██║██║ ██╔╝    ╚██╗ 
</span></span><span class=line><span class=cl>███████╗██████╔╝██║     ██║   ██║██╔██╗ ██║█████╔╝      ╚██╗
</span></span><span class=line><span class=cl>╚════██║██╔═══╝ ██║     ██║   ██║██║╚██╗██║██╔═██╗      ██╔╝
</span></span><span class=line><span class=cl>███████║██║     ███████╗╚██████╔╝██║ ╚████║██║  ██╗    ██╔╝ 
</span></span><span class=line><span class=cl>╚══════╝╚═╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═══╝╚═╝  ╚═╝    ╚═╝  
</span></span><span class=line><span class=cl>Last login: Mon Feb  5 11:04:54 2024 from [Redacted]
</span></span><span class=line><span class=cl>Waiting for cloud-init status...
</span></span><span class=line><span class=cl>Your instance is ready!
</span></span><span class=line><span class=cl>splunk@show-no-config-i-0d1b29d967cb2e6ff:~$ </span></span></code></pre></div><p>If this isn&rsquo;t shown, or you see an error, log out and give it a minute or so, then try to log in again as the instance might not have finished the initial boot sequence. If it still does not show the above Welcome page, reach out to your Instructor.</p><p>Next, let&rsquo;s ensure your instance is configured correctly, we need to confirm that the required environment variables for this workshop are set correctly. In your terminal run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/check_env.sh</span></span></code></pre></div><p>In the output check the following environment variables are present and have actual valid values set:</p><div class=tab-panel data-tab-group=528ba81568c9fe4ac66489a26509c076><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("528ba81568c9fe4ac66489a26509c076","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ACCESS_TOKEN = [Redacted]
</span></span><span class=line><span class=cl>REALM = [Realm]
</span></span><span class=line><span class=cl>RUM_TOKEN = [Redacted]
</span></span><span class=line><span class=cl>HEC_TOKEN = [Redacted]
</span></span><span class=line><span class=cl>HEC_URL = https://[...]/services/collector/event
</span></span><span class=line><span class=cl>INSTANCE = [Your workshop name]</span></span></code></pre></div></div></div></div></div><p>Please make a note of the <code>INSTANCE</code> environment variable value as this is the reference to your workshop instance and we will need it later to filter data in the <strong>Splunk Observability Suite</strong> UI.</p><p>For this workshop, <strong>all</strong> of the above are required. If any have values missing, please contact your instructor.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Delete any existing OpenTelemetry Collectors</div><div class=box-content><p>If you have completed a Splunk Observability workshop using this EC2 instance, please ensure you have deleted the collector running in Kubernetes before continuing with this workshop. This can be done by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></div><h2 id=2-the-splunk-opentelemetry-collector>2. The Splunk OpenTelemetry Collector</h2><p>The Splunk OpenTelemetry Collector is the core component of instrumenting infrastructure and applications. Its role is to collect and send:</p><ul><li>Infrastructure metrics (disk, CPU, memory, etc)</li><li>Application Performance Monitoring (APM) traces</li><li>Profiling data</li><li>Host and Application logs</li></ul><p>To get Observability signals (<strong>Metrics, Traces</strong> and <strong>Logs</strong>) into the <strong>Splunk Observability Cloud</strong> we need to add an OpenTelemetry Collector to our Kubernetes cluster.
For this workshop, we will be using the Splunk Kubernetes Helm Chart for the Opentelemetry collector and installing the collector in <code>Operator</code> mode as this is required for Zero-config.</p><h2 id=3-install-the-opentelemetry-collector-using-helm>3. Install the OpenTelemetry Collector using Helm</h2><p>First, we need to add the Splunk Helm chart repository to Helm and update it so it knows where to find it:</p><div class=tab-panel data-tab-group=a03e4387f13f806a9fb70cdece6a39e2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-repo-add class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a03e4387f13f806a9fb70cdece6a39e2","helm-repo-add")'>
<span class=tab-nav-text>Helm Repo Add</span>
</button>
<button data-tab-item=helm-repo-add-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("a03e4387f13f806a9fb70cdece6a39e2","helm-repo-add-output")'>
<span class=tab-nav-text>Helm Repo Add Output</span></button></div><div class=tab-content-container><div data-tab-item=helm-repo-add class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span class=o>&amp;&amp;</span> helm repo update</span></span></code></pre></div></div></div><div data-tab-item=helm-repo-add-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>Hang tight while we grab the latest from your chart repositories...
</span></span><span class=line><span class=cl>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span class=line><span class=cl>Update Complete. ⎈Happy Helming!⎈</span></span></code></pre></div></div></div></div></div><p>The Splunk Observability Cloud offers wizards in the <strong>Splunk Observability Suite</strong> UI to walk you through the setup of the Collector on Kubernetes, but in the interest of time, we will use a setup created earlier. As we want the auto instrumentation to be available, we will install the OpenTelemetry Collector with the OpenTelemetry Collector Helm chart with some additional options:</p><ul><li><code>--set="operator.enabled=true"</code> - this will install the Opentelemetry operator, that will be used to handle auto instrumentation</li><li><code>--set="certmanager.enabled=true"</code> - This will install the required certificate manager for the operator.</li><li><code>--set="splunkObservability.profilingEnabled=true"</code> - This enabled Code profiling via the operator</li></ul><p>To install the collector run the following commands, do <strong>NOT</strong> edit this:</p><div class=tab-panel data-tab-group=7b62093a5286680b68a93da1dd15bc0b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-install class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7b62093a5286680b68a93da1dd15bc0b","helm-install")'>
<span class=tab-nav-text>Helm Install</span>
</button>
<button data-tab-item=helm-install-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("7b62093a5286680b68a93da1dd15bc0b","helm-install-output")'>
<span class=tab-nav-text>Helm Install Output</span></button></div><div class=tab-content-container><div data-tab-item=helm-install class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;operator.enabled=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;certmanager.enabled=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.logsEnabled=false&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;logsEngine=otel&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.profilingEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;environment=</span><span class=nv>$INSTANCE</span><span class=s2>-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml</span></span></code></pre></div></div></div><div data-tab-item=helm-install-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Tue Jan  2 13:46:16 2024
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: 1
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Platform endpoint &#34;https://http-inputs-o11y-suite-eu0.stg.splunkcloud.com:443/services/collector/event&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm eu0.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[INFO] You&#39;ve enabled the operator&#39;s auto-instrumentation feature (operator.enabled=true), currently considered ALPHA.
</span></span><span class=line><span class=cl>- Instrumentation library maturity varies (e.g., Java is more mature than Go). For library stability, visit: https://opentelemetry.io/docs/instrumentation/#status-and-releases
</span></span><span class=line><span class=cl>  - Some libraries may be enabled by default. For current status, see: https://github.com/open-telemetry/opentelemetry-operator#controlling-instrumentation-capabilities
</span></span><span class=line><span class=cl>  - Splunk provides best-effort support for native OpenTelemetry libraries, and full support for Splunk library distributions. For used libraries, refer to the values.yaml under &#34;operator.instrumentation.spec&#34;.</span></span></code></pre></div></div></div></div></div><p>You can monitor the progress of the deployment by running <code>kubectl get pods</code> which should typically report a new pod is up and running after about 30 seconds.</p><p>Ensure the status is reported as <strong>Running</strong> before continuing.</p><div class=tab-panel data-tab-group=b3353ab85eb7be4927f521d6bb9f82aa><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b3353ab85eb7be4927f521d6bb9f82aa","kubectl-get-pods")'>
<span class=tab-nav-text>Kubectl Get Pods</span>
</button>
<button data-tab-item=kubectl-get-pods-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b3353ab85eb7be4927f521d6bb9f82aa","kubectl-get-pods-output")'>
<span class=tab-nav-text>Kubectl Get Pods Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods<span class=p>|</span>grep splunk-otel </span></span></code></pre></div></div></div><div data-tab-item=kubectl-get-pods-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>splunk-otel-collector-certmanager-cainjector-5c5dc4ff8f-95z49   1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-6d95596898-vjxss              1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-webhook-69f4ff754c-nghxz      1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-6bd5567d95-5f8cj     1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-tspd2                               1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-69d476cb7-j7zwd                  2/2     Running   0          10m</span></span></code></pre></div></div></div></div></div><p>Ensure there are no errors by tailing the logs from the OpenTelemetry Collector pod. The output should look similar to the log output shown in the Output tab below.
Use the label set by the <code>helm</code> install to tail logs (You will need to press <code>ctrl + c</code> to exit). Or use the installed <code>k9s</code> terminal UI for bonus points!</p><div class=tab-panel data-tab-group=92664dc21419f4ddaa36b84b1f9cc99b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-logs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("92664dc21419f4ddaa36b84b1f9cc99b","kubectl-logs")'>
<span class=tab-nav-text>Kubectl Logs</span>
</button>
<button data-tab-item=kubectl-logs-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("92664dc21419f4ddaa36b84b1f9cc99b","kubectl-logs-output")'>
<span class=tab-nav-text>Kubectl Logs Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-logs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector -f --container otel-collector</span></span></code></pre></div></div></div><div data-tab-item=kubectl-logs-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    service/service.go:364  Starting receivers...
</span></span><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/watcher.go:195       Configured Kubernetes MetadataExporter  {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;, &#34;exporter_name&#34;: &#34;signalfx&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    healthcheck/handler.go:128      Health Check state change       {&#34;component_kind&#34;: &#34;extension&#34;, &#34;component_type&#34;: &#34;health_check&#34;, &#34;component_name&#34;: &#34;health_check&#34;, &#34;status&#34;: &#34;ready&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    service/service.go:267  Everything is ready. Begin running and processing data.
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:59       Starting shared informers and wait for initial cache sync.      {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.281Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:75       Completed syncing shared informer caches.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Deleting a failed installation</div><div class=box-content><p>If you make an error installing the OpenTelemetry Collector you can start over by deleting the installation using:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></div><h2 id=4-deploying-the-petclinic-application-with-prebuilt-containers-into-kubernetes>4. Deploying the PetClinic Application with prebuilt containers into Kubernetes</h2><p>The next thing we need to do, well &mldr;, is to set up our application. The first deployment of our application will be using prebuilt containers to give us the base scenario: a regular Java microservices-based application running in Kubernetes that we want to start observing.</p><p>So let&rsquo;s deploy our application:<div class=tab-panel data-tab-group=75e16b9cae25b36d7c1e32e6290447db><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-apply class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("75e16b9cae25b36d7c1e32e6290447db","kubectl-apply")'>
<span class=tab-nav-text>kubectl apply</span>
</button>
<button data-tab-item=kubectl-apply-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("75e16b9cae25b36d7c1e32e6290447db","kubectl-apply-output")'>
<span class=tab-nav-text>kubectl apply Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-apply class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/petclinic-deploy.yaml</span></span></code></pre></div></div></div><div data-tab-item=kubectl-apply-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server created
</span></span><span class=line><span class=cl>service/config-server created
</span></span><span class=line><span class=cl>deployment.apps/discovery-server created
</span></span><span class=line><span class=cl>service/discovery-server created
</span></span><span class=line><span class=cl>deployment.apps/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway-external created
</span></span><span class=line><span class=cl>deployment.apps/customers-service created
</span></span><span class=line><span class=cl>service/customers-service created
</span></span><span class=line><span class=cl>deployment.apps/vets-service created
</span></span><span class=line><span class=cl>service/vets-service created
</span></span><span class=line><span class=cl>deployment.apps/visits-service created
</span></span><span class=line><span class=cl>service/visits-service created
</span></span><span class=line><span class=cl>deployment.apps/admin-server created
</span></span><span class=line><span class=cl>service/admin-server created
</span></span><span class=line><span class=cl>service/petclinic-db created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-db created
</span></span><span class=line><span class=cl>configmap/petclinic-db-initdb-config created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-loadgen-deployment created
</span></span><span class=line><span class=cl>configmap/scriptfile created</span></span></code></pre></div></div></div></div></div></p><p>At this point, we can verify the deployment by checking if the Pods are running, Not that these containers need to be downloaded and started, this may take a minute or so.<div class=tab-panel data-tab-group=d376a54f7f38bc1ef08fecb378051e16><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d376a54f7f38bc1ef08fecb378051e16","kubectl-get-pods")'>
<span class=tab-nav-text>kubectl get pods</span>
</button>
<button data-tab-item=kubectl-get-pods-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("d376a54f7f38bc1ef08fecb378051e16","kubectl-get-pods-output")'>
<span class=tab-nav-text>kubectl get pods Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=kubectl-get-pods-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                            READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-dc744986b-z2gzw               1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-cainjector-69546b87d6-d2fz2   1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-webhook-78b59ffc88-r2j8x      1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-655dcd9b6b-dcvkb     1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-dg2vj                               1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-57cbb8d7b4-dk5wf                 2/2     Running   0          114s
</span></span><span class=line><span class=cl>petclinic-db-64d998bb66-2vzpn                                   1/1     Running   0          58s
</span></span><span class=line><span class=cl>api-gateway-d88bc765-jd5lg                                      1/1     Running   0          58s
</span></span><span class=line><span class=cl>visits-service-7f97b6c579-bh9zj                                 1/1     Running   0          58s
</span></span><span class=line><span class=cl>admin-server-76d8b956c5-mb2zv                                   1/1     Running   0          58s
</span></span><span class=line><span class=cl>customers-service-847db99f79-mzlg2                              1/1     Running   0          58s
</span></span><span class=line><span class=cl>vets-service-7bdcd7dd6d-2tcfd                                   1/1     Running   0          58s
</span></span><span class=line><span class=cl>petclinic-loadgen-deployment-5d69d7f4dd-xxkn4                   1/1     Running   0          58s
</span></span><span class=line><span class=cl>config-server-67f7876d48-qrsr5                                  1/1     Running   0          58s
</span></span><span class=line><span class=cl>discovery-server-554b45cfb-bqhgt                                1/1     Running   0          58s</span></span></code></pre></div></div></div></div></div></p><p>Make sure the output of get pods matches the output as shown above. This may take a minute or so, try again until all services are shown as <strong>RUNNING</strong>.</p><p>Once they are running, the application will take a few minutes to fully start up, create the database and synchronize all the services, so let&rsquo;s use the time to see if our local repository is active.</p><h2 id=5-verify-the-local-docker-repository>5. Verify the local Docker Repository</h2><p>Once we have tested our Zero Auto-Config Instrumentation in the existing containers, we are going to build our containers to show some of the additional instrumentation features of Opentelemetry Java. Only then we will touch the config files or the source code. Once we build these containers, Kubernetes will need to pull these new images from somewhere. To enable this we have created a local repository to store these new containers, so Kubernetes can pull the images locally.</p><p>We can see if the repository is up and running by checking the inventory with the below command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> curl -X GET http://localhost:9999/v2/_catalog </span></span></code></pre></div><p>It should return an empty list</p><p><div class=tab-panel data-tab-group=e7f2aec5aa0fe7a5652e4d9408c838f1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e7f2aec5aa0fe7a5652e4d9408c838f1","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>**{&#34;repositories&#34;:[]}**</span></span></code></pre></div></div></div></div></div>If this is not up, reach out to your Instructor for a replacement instance.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>Robert Castley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Feb 16, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=verifying-both-kubernetes-and-the-petclinic-microservices-application>Verifying both Kubernetes and the PetClinic Microservices application</h1><h2 id=1-verify-the-installation-by-checking-metrics-and-logs>1. Verify the installation by checking Metrics and Logs</h2><p>Once the installation is completed, you can log in to the <strong>Splunk Observability Cloud</strong> with the URL provided by the Instructor.</p><p>First, Navigate to the <strong>Kubernetes Navigator</strong> view in the <strong>Infrastructure</strong> <a href=#R-image-cbc7d509b19fa5874a8aec1c0a38ce90 class=lightbox-link><img alt=infra class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/infra-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cbc7d509b19fa5874a8aec1c0a38ce90><img alt=infra class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/infra-icon.png?classes=inline&height=25px"></a> section to see the metrics from your cluster in the <strong>K8s nodes</strong> pane. Once you are in the Kubernetes Navigator view, change the <em>Time</em> filter to the last 15 Minutes (-15m) to focus on the latest data.</p><p>Select your cluster with the regular filter option at the top of the Navigator and a filter <code>k8s.cluster.name</code> <strong>(1)</strong>. Type or select the cluster name of your workshop instance (you can get the unique part from your cluster name by using the <code>INSTANCE</code> from the output from the shell script you ran earlier). (You can also select your cluster by clicking on its image in the cluster pane.)
You should now only have your cluster visible <strong>(2)</strong>.</p><p><a href=#R-image-617cc8ff13a883cbb636a3ce72c7cddb class=lightbox-link><img alt=Navigator class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/navigator.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-617cc8ff13a883cbb636a3ce72c7cddb><img alt=Navigator class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/navigator.png></a></p><p>You should see metrics <strong>(3)</strong> of your cluster and the log events <strong>(4)</strong> chart should start to be populated with log line events coming from your cluster. Click on one of the bars to peek at the log lines coming in from your cluster.</p><p><a href=#R-image-568e8218e914456b48fb450cd7ec80ed class=lightbox-link><img alt=logs class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/k8s-peek-at-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-568e8218e914456b48fb450cd7ec80ed><img alt=logs class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/k8s-peek-at-logs.png></a></p><p>Also, a <code>Mysql</code> pane <strong>(5)</strong> should appear, when you click on that pane, you can see the MySQL-related metrics from your database.</p><p><a href=#R-image-3f7e8d94ad6281f46aadd1f760e592e6 class=lightbox-link><img alt="MySQL metrics" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/mysql-metrics.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3f7e8d94ad6281f46aadd1f760e592e6><img alt="MySQL metrics" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/mysql-metrics.png></a></p><p>Once you see data flowing in from your host (<code>metrics and logs</code>) and MySQL shows <code>metrics</code> as well we can move on to the actual PetClinic application.</p><h2 id=2-check-the-petshop-website>2. Check the Petshop Website</h2><p>To test the application you need to obtain the public IP address of the instance you are running on. You can do this by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl ifconfig.me</span></span></code></pre></div><p>You will see an IP address returned, make a note of this as we will need it to validate that the application is running.</p><p>You can validate if the application is running by visiting <code>http://&lt;IP_ADDRESS>:81</code> (replace <code>&lt;IP_ADDRESS></code> with the IP address you obtained earlier). You should see the PetClinic application running.</p><p><a href=#R-image-64a218f06ebed41e4430921bfe706dfd class=lightbox-link><img alt="Pet shop" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/petclinic.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-64a218f06ebed41e4430921bfe706dfd><img alt="Pet shop" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/petclinic.png></a></p><p>Make sure the application is working correctly by visiting the <strong>All Owners</strong> <strong>(1)</strong> and <strong>Veterinarians</strong> **(2)**tabs, you should get a list of names in each case.</p><p><a href=#R-image-60bce6c9905349c0a582300365d4c81f class=lightbox-link><img alt=owners class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/pet-clininc-owners.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-60bce6c9905349c0a582300365d4c81f><img alt=owners class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/20-verify-setup/../images/pet-clininc-owners.png></a></p><p>If you&rsquo;re familiar with the Standard version, you will notice a slightly longer response time due to the architecture used.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>Robert Castley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Feb 16, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=setting-up-zero-configuration-auto-instrumentation-for-apm>Setting up Zero configuration Auto instrumentation for APM</h1><h2 id=1-introduction>1. Introduction</h2><p>In the previous chapter, we enabled the OpenTelemetry Collector for Kubernetes on our cluster and configured it to send metrics both Kubernetes and Mysql metrics to the <strong>Splunk Observability Cloud</strong>. The next section will enable auto-instrumentation for our Java apps running in the pods in our cluster.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Zero Config Auto Instrumentation</div><div class=box-content><p>It is important to understand that Zero Config Auto instrumentation is designed to get Trace/Span & Profiling data out of your existing application, without requiring you to change your code or requiring to rebuild.</p></div></div><p>For this workshop, we will be using the Zero config option of the Opentelemetry Collector in Kubernetes.
This means that the Collector monitors your pods running in Kubernetes, and if they match certain criteria, they will enable auto-instrumentation on the pod.</p><p>For Java, it is looking for the Kubernetes TAG <code>instrumentation.opentelemetry.io/inject-java\</code> set to <code>true</code> or to the location of the Otel collector, like <code>default/splunk-otel-collector</code>. The last one will work across namespaces, so this is what we will use in our examples.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Using the deployment.yaml</div><div class=box-content><p>If you want your pods to send traces automatically, you can add the annotation to the <code>deployment.yaml</code> as shown below. This will add the instrumentation library during the initial deployment. To speed things up we have done that for the management pods: <code>Admin-server, Config-server & Discovery server</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apiVersion: apps/v1
</span></span><span class=line><span class=cl>kind: Deployment
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: admin-server
</span></span><span class=line><span class=cl>  labels: 
</span></span><span class=line><span class=cl>    app.kubernetes.io/part-of: spring-petclinic
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  selector:
</span></span><span class=line><span class=cl>    matchLabels:
</span></span><span class=line><span class=cl>      app: admin-server
</span></span><span class=line><span class=cl>  template:
</span></span><span class=line><span class=cl>    metadata:
</span></span><span class=line><span class=cl>      labels:
</span></span><span class=line><span class=cl>        app: admin-server
</span></span><span class=line><span class=cl>      annotations:
</span></span><span class=line><span class=cl>        instrumentation.opentelemetry.io/inject-java: <span class=s2>&#34;default/splunk-otel-collector&#34;</span></span></span></code></pre></div></div></div><h2 id=2-setting-up-java-auto-instrumentation-on-the-api-gateway-pod>2. Setting up Java auto instrumentation on the api-gateway pod</h2><p>Let&rsquo;s look at how zero-config works with a single pod, the <code>api-gateway</code>. If you enable Zero configuration for a pod, the Collector will attach an init-Container to your existing pod, and restart the pod to activate it.</p><p>To show what happens when you enable Auto instrumentation, let&rsquo;s do a <em>For & After</em> of the content of a pod, the <code>api-gateway</code> in this case:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>The resulting output should say:</p><p><div class=tab-panel data-tab-group=892f0b4a7d0fb88f354189d04971c816><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("892f0b4a7d0fb88f354189d04971c816","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div></div></div></div></div>This container is pulled from a remote repository <code>quay.io</code> and was not built to send traces to the <strong>Splunk Observability Cloud</strong>.
Let&rsquo;s enable the Java auto instrumentation on the api-gateway service first by adding the <code>inject-java</code> tag to Kubernetes with the <code>kubectl patch deployment</code> command.</p><p><div class=tab-panel data-tab-group=fc68430da2ec8f63197b4f1ff16fb35e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-api-gateway-service class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fc68430da2ec8f63197b4f1ff16fb35e","patch-api-gateway-service")'>
<span class=tab-nav-text>Patch api-gateway service</span>
</button>
<button data-tab-item=kubectl-patch-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("fc68430da2ec8f63197b4f1ff16fb35e","kubectl-patch-output")'>
<span class=tab-nav-text>kubectl patch Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-api-gateway-service class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl patch deployment api-gateway -p <span class=s1>&#39;{&#34;spec&#34;: {&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;instrumentation.opentelemetry.io/inject-java&#34;:&#34;default/splunk-otel-collector&#34;}}}} }&#39;</span></span></span></code></pre></div></div></div><div data-tab-item=kubectl-patch-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/api-gateway patched</span></span></code></pre></div></div></div></div></div>Let&rsquo;s recheck the container(s) in your pod for the after look:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>Next to the original pod from before, you should see an initContainer named <strong>opentelemetry-auto-instrumentation</strong>. (If you get two api-gateway containers, the original one is still terminating, so give it a few seconds):</p><div class=tab-panel data-tab-group=e03cc00d78e7bd929d984bf141ed8764><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e03cc00d78e7bd929d984bf141ed8764","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.30.0
</span></span><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div></div></div></div></div><h2 id=3-enable-java-auto-instrumentation-on-all-pods>3. Enable Java auto instrumentation on all pods</h2><p>Now let&rsquo;s patch all other services so we can see the full interaction between all services with <code>app.kubernetes.io/part-of=spring-petclinic</code> as the inject annotation.
remember: <strong>This automatically causes pods to restart.</strong></p><p>Note, there will be no change for the <em>config-server, discovery-server, admin-server & api-gateway</em> as we patched these earlier.</p><div class=tab-panel data-tab-group=11cb378828a6a0c59063ffab0553a462><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-all-petclinic-services class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("11cb378828a6a0c59063ffab0553a462","patch-all-petclinic-services")'>
<span class=tab-nav-text>Patch all Petclinic services</span>
</button>
<button data-tab-item=kubectl-patch-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("11cb378828a6a0c59063ffab0553a462","kubectl-patch-output")'>
<span class=tab-nav-text>kubectl patch Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-all-petclinic-services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments -l app.kubernetes.io/part-of<span class=o>=</span>spring-petclinic -o name <span class=p>|</span> xargs -I % kubectl patch % -p <span class=s2>&#34;{\&#34;spec\&#34;: {\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;instrumentation.opentelemetry.io/inject-java\&#34;:\&#34;default/splunk-otel-collector\&#34;}}}}}&#34;</span></span></span></code></pre></div></div></div><div data-tab-item=kubectl-patch-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/admin-server patched
</span></span><span class=line><span class=cl>deployment.apps/customers-service patched
</span></span><span class=line><span class=cl>deployment.apps/visits-service patched
</span></span><span class=line><span class=cl>deployment.apps/discovery-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/vets-service patched
</span></span><span class=line><span class=cl>deployment.apps/api-gateway patched (no change)</span></span></code></pre></div></div></div></div></div><h2 id=3-check-the-result-in-splunk-apm>3. Check the result in Splunk APM</h2><p>Once the containers are patched they will be restarted, let&rsquo;s go back to the <strong>Splunk Observability Cloud</strong> with the URL provided by the Instructor to check our cluster in the Kubernetes Navigator.</p><p>After a couple of minutes or so you should see that the Pods are being restarted by the operator and the Zero config container will be added. This will look similar to the screenshot below:</p><p><a href=#R-image-8a1af366cbe9ff4c9bd65e736f42729e class=lightbox-link><img alt=restart class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/k8s-navigator-restarted-pods.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8a1af366cbe9ff4c9bd65e736f42729e><img alt=restart class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/k8s-navigator-restarted-pods.png></a></p><p>Wait for the pods to turn green again (you may want to refresh the screen), then navigate to the <strong>APM</strong> <a href=#R-image-3fcfdc54870b141c4351b14ca0982132 class=lightbox-link><img alt=APM class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/apm-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3fcfdc54870b141c4351b14ca0982132><img alt=APM class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/apm-icon.png?classes=inline&height=25px"></a> section to look at the information provided by the traces generated from your service in the <strong>Explore</strong> Pane. Use the filter option to change the <em>environment</em> filter <strong>(1)</strong> and search for the name of your workshop instance in the dropdown box, it should be the [INSTANCE]-workshop. (where <code>INSTANCE</code> is the value from the shell script you run earlier). Make sure it is the only one selected.</p><p><a href=#R-image-f95d720d5c5c51ad215223aec78cc651 class=lightbox-link><img alt=apm class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/zero-config-first-services-overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f95d720d5c5c51ad215223aec78cc651><img alt=apm class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/zero-config-first-services-overview.png></a></p><p>You should see the name <strong>(2)</strong> of the api-gateway service and metrics in the Latency and Request & Errors charts. (You can ignore the Critical Alert, as it was caused by the sudden request increase generated by the load generator, It will become the norm in a bit and go away). You should also see the rest of the service appear.</p><p>Next, click on <strong>Explore</strong> <strong>(3)</strong> to see the services in the automatically generated dependency map and select the api-gateway service.
<a href=#R-image-022422c1b5240ead933d38814878f04b class=lightbox-link><img alt="apm map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/zero-config-first-services-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-022422c1b5240ead933d38814878f04b><img alt="apm map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/zero-config-first-services-map.png></a></p><p>The example above shows all the interactions between all our services. You may still be showing the map in the interim state as it will take the Petclinic Microservice application a few minutes to start up and fully synchronize to make your map to look like the one above. Reducing the time will help, if you pick a custom time of 2 minutes, the initial startup-related errors (Red Dots) will disappear from the view.</p><p>In the meantime let&rsquo;s examine the metrics that are available for each service that is instrumented and visit the request, error, and duration (RED) metrics Dashboard</p><h2 id=5-examine-default-red-metrics>5. Examine default R.E.D. Metrics</h2><p>Splunk APM provides a set of built-in dashboards that present charts and visualized metrics to help you see problems occurring in real time and quickly determine whether the problem is associated with a service, a specific endpoint, or the underlying infrastructure. To look at this dashboard for the selected <code>api-gateway</code>, make sure you have the <code>api-gateway</code> service selected in the Dependency map as show above, then click on the *<strong>View Dashboard</strong> Link <strong>(1)</strong> at the top of the right-hand pane.</p><p>This will bring you to the services dashboard:</p><p><a href=#R-image-f76cbc3321881a89c4f5ab828bff7030 class=lightbox-link><img alt="metrics dashboard" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/zero-config-first-services-metrics.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f76cbc3321881a89c4f5ab828bff7030><img alt="metrics dashboard" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/30-auto-instrumentation/../images/zero-config-first-services-metrics.png></a></p><p>This dashboard, which is available for each of your instrumented services, offers an overview of the key <code>request, error, and duration (RED)</code> metrics based on Monitoring MetricSets created from endpoint spans for your services, endpoints, and Business Workflows. They also present related host and Kubernetes metrics to help you determine whether problems are related to the underlying infrastructure, as in the above image.
As the dashboards allow you to go back in time with the <em>Time picker</em> window <strong>(1)</strong>, it&rsquo;s the perfect spot to identify the behavior you wish to be alerted on, and with a click on one of the bell icons <strong>(2)</strong> available in each chart, you can set up an alert to do just that.</p><p>If you scroll down the page, you get host and Kubernetes metrics related to your service as well.
Let&rsquo;s move on to look at some of the traces generated by the Zero Config Auto instrumentation.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>Robert Castley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Feb 16, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apm-features-available-with-zero-config-auto-instrumentation>Splunk APM features available with Zero Config Auto-Instrumentation</h1><h2 id=1-introduction>1. Introduction</h2><p>As we have seen in the previous chapter, once you have enabled Zero Config Auto Instrumentation and started to run invocations though your application, traces will be send to <strong>Splunk Observability Cloud Suite</strong>
With these Traces we Splunk will automatically generate Dependency maps and RED Metrics. In this next section we are going to examine the traces itself and what information they provide to help you understand the behaviour of your services all without touching your code.</p><p>Make sure you are in the APM Explore page either by going back in the browser or navigate to the <strong>APM</strong> <a href=#R-image-b06177f7aed3cd59d5edd769b373388e class=lightbox-link><img alt=APM class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/apm-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b06177f7aed3cd59d5edd769b373388e><img alt=APM class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/apm-icon.png?classes=inline&height=25px"></a> section in the Menu bar, then click on the <strong>Explore</strong> tile.</p><h2 id=2-examine-a-trace-from-the-apm-dependency-map>2. Examine a Trace from the APM Dependency map</h2><p>For this exercise we are going to use a common scenario you would use if the service operation was showing high latency, or errors for example.</p><p>Select the <strong>Customer Service</strong> in the Dependency map <strong>(1)</strong>, then make sure the <code>customers-service</code> is selected in the <strong>Services</strong> dropdown box <strong>(2)</strong>. Next, select <code>GET /Owners</code> from the Operations Drop down <strong>(3)</strong>.</p><p><a href=#R-image-fde1dca509b31d6645adab610ed04712 class=lightbox-link><img alt="select a trace" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/select-workflow.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fde1dca509b31d6645adab610ed04712><img alt="select a trace" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/select-workflow.png></a></p><p>This should give you the workflow wit A filter on <code>GET /owners</code> <strong>(1)</strong> as shown below. To pick a trace, select a line in the <code>Service Requests & Errors</code> chart <strong>(2)</strong>, when the dot appear click to get a list of sample traces:</p><p><a href=#R-image-900c82908f581c47a813abcb0c531a8b class=lightbox-link><img alt=workflow-trace-pick class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/selecting-a-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-900c82908f581c47a813abcb0c531a8b><img alt=workflow-trace-pick class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/selecting-a-trace.png></a></p><p>Once you have the list of sample traces, Clicking on the blue <strong>(3)</strong> Trace ID Link. (Make sure it has at thesame three services mentioned in the Service Column.)</p><p>This bring us the the Trace selected in the Waterfall view:</p><p><a href=#R-image-bbe54fa414d32692497d87414cfbb6b7 class=lightbox-link><img alt=waterfall class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/waterfall-view.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bbe54fa414d32692497d87414cfbb6b7><img alt=waterfall class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/waterfall-view.png></a></p><p>Here we find several sections:</p><ul><li>The actual Waterfall Pane <strong>(1)</strong>, where you see the trace and all the instrumented functions visible as spans, with their duration representation and order/relationship showing.</li><li>The Trace Info Pane <strong>(2)</strong>, by default it is showing the selected Span information. (Highlighted with a box around the Span in the Waterfall Pane.)</li><li>The Span Pane <strong>(3)</strong>, here you can find all the Tags that have been send in the selected Span, You can scroll down to see all of them.</li><li>The process Pane, with tags related to the process that created the Span (Scroll down to see as it is not in the screenshot.)</li><li>The Trace Properties at the top of the right hand pane, default it is collapsed as shown.</li></ul><p>First lets examine a Span:</p><h2 id=3-spans-and-zero-config-auto-instrumentation-features>3. Spans and Zero Config Auto-Instrumentation features</h2><p>While we examine our spans, lets look at a number features that you get out of the box without code modifications when using Zero config Auto-Instrumentation on top of tracing:</p><p>Due to tha fact there are several different routes
First, in the Waterfall Pane, make sure the <code>customers-service:SELECT petclinic.owners</code> or similar span is selected as shown in the screenshot below:</p><p><a href=#R-image-b4fabc2a106350ddd8e5967db1c352ec class=lightbox-link><img alt=db-query class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/db-query.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b4fabc2a106350ddd8e5967db1c352ec><img alt=db-query class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/40-traces-spans-tags/../images/db-query.png></a></p><ul><li>The basic latency information showing as a bar for the instrumented function or call, in our example, it took 6.3 Milliseconds.</li><li>Number of similar Spans <strong>(1)</strong>, only visible if a the span is repeated multiple time. In this case there are 10 repeats in our example. (You can show/hide them all by clicking on the <code>10x</code> and all span will show in order)</li><li>Inferred Services, Calls done to external systems that are not instrumented, show up as a gray &lsquo;inferred&rsquo; span. The Inferred Service or span in our case here is a call to the Mysql Database <code>mysql:petclinic SELECT petclinic</code> <strong>(2)</strong> as shown below our selected span.</li><li>Span Tags in the Tag Pane, Standard tags produced by the auto instrumentation agent. In this case the span is calling a Database, so it includes the <code>db.statement</code> tag <strong>(3)</strong>. This tag will hold the DB query statement and is used by the Database call performed during this span. This will be used by the DB-Query Performance feature. We look at DB-Query Performance in the next section.</li><li>Always-on Profiling, <strong>IF</strong> the system is configured to, and has captured Profiling data during a Spans life cycle, it will show the number of Call Stacks captured in the Spans time line. (15 Call Stacks for the <code>customers-service:SELECT petclinic.owners</code> Span show above). We will look at Profiling in the next section.</li></ul><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>Pieter Hagen</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Feb 16, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apm-always-on-profiling--database-query-performance>Splunk APM Always-on Profiling & Database Query Performance</h1><h2 id=1-introduction>1. Introduction</h2><p>As we have seen in the previous chapter, you can trace your interactions between the various services using APM without touching your code, which will allow you to identify issues faster. However as seen, besides tracing, Splunk Zero Config for Auto-Instrumentations offers additional features out of the box that can help you finding issues faster. In this section we are going to look at 2 of them:</p><ul><li>Always-on Profiling and Java Metrics</li><li>Database Query Performance</li></ul><p>If you want to dive deeper into Always-on Profiling or DB-Query performance, we have a separate Ninja Workshop called <em><strong>Debug Problems</strong></em> that you can follow for more detailed info.</p><h2 id=2-alwayson-profiling-and-metrics>2. AlwaysOn Profiling and Metrics</h2><p>When we installed the Splunk Distribution of the OpenTelemetry Collector using the Helm chart earlier, we configured it to enable <strong>AlwaysOn Profiling</strong> and <strong>Metrics</strong>. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.</p><p>When you deploy the PetClinic application and set the annotation, the collector automatically detects the application and instruments it for traces and profiling. We can verify this by examining the startup logs of one of the Java containers we are instrumenting by running the following script:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.  ~/workshop/petclinic/scripts/get_logs.sh</span></span></code></pre></div><p>The logs should show what flags were picked up by the Java Auto instrumentation agent:</p><div class=tab-panel data-tab-group=2704ec254fda390c2aad888a8410a2ea><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2704ec254fda390c2aad888a8410a2ea","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2024/02/15 09:42:00 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:01 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:02 Connected to tcp://discovery-server:8761
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS:  -javaagent:/otel-auto-instrumentation-java/javaagent.jar
</span></span><span class=line><span class=cl>Picked up _JAVA_OPTIONS: -Dspring.profiles.active=docker,mysql -Dsplunk.profiler.call.stack.interval=150
</span></span><span class=line><span class=cl>OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:056 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: splunk-1.30.1-otel-1.32.1
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:768 +0000] [main] INFO com.splunk.javaagent.shaded.io.micrometer.core.instrument.push.PushMeterRegistry - publishing metrics for SignalFxMeterRegistry every 30s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - Profiler configuration:
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:480 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                  splunk.profiler.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                splunk.profiler.directory : /tmp
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -       splunk.profiler.recording.duration : 20s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:506 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -               splunk.profiler.keep-files : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:510 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -            splunk.profiler.logs-endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -              otel.exporter.otlp.endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -           splunk.profiler.memory.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:515 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -             splunk.profiler.tlab.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -        splunk.profiler.memory.event.rate : 150/s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.call.stack.interval : PT0.15S
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -  splunk.profiler.include.internal.stacks : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.tracing.stacks.only : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:518 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.</span></span></code></pre></div></div></div></div></div><p>We are interested in the section written by the <code>com.splunk.opentelemetry.profiler.ConfigurationLogger</code> or the <strong>Profiling Configuration</strong></p><p>We can see the various settings you can control, some that are useful depending on your use case like the <code>splunk.profiler.directory</code> - The location where the agent writes the call stacks before sending them to Splunk. This may be different depending how you configure your containers.
Another parameter you may want to change is <code>splunk.profiler.call.stack.interval</code> This is how often the system takes a CPU Stack trace. You may want to reduce this if you have short spans like we have in our application. (we kept the default as the spans in this demo application are extremely short, so Span may not always have a CPU Call Stack related to it.)</p><p>You can find how to set these parameters <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/java/configuration/advanced-java-otel-configuration.html#profiling-configuration-java rel=external target=_blank>here</a>. Below, is how you set a higher collection rate for call stack in your <code>deployment.yaml</code>, exactly how to pass any JAVA option to the the Java application running in your container:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> env: 
</span></span><span class=line><span class=cl>    - name: JAVA_OPTIONS
</span></span><span class=line><span class=cl>      value: &#34;-Dsplunk.profiler.call.stack.interval=150&#34;</span></span></code></pre></div><p>If you don&rsquo;t see those lines as a result from the script, the startup may have taken to long and generated to many connection errors, try looking at the logs directly with kubectl or the k9s utility that is installed.</p><h2 id=2-looking-at-profiling-data-in-the-trace-waterfall>2. Looking at Profiling Data in the Trace Waterfall</h2><p>Make sure you have your original (or similar) Trace & Span <strong>(1)</strong> selected in the APM Waterfall view and select <strong>Memory Stack Traces (2)</strong> from the right hand pane:</p><p><a href=#R-image-19469e9057e1f6afcecbcbc07c715684 class=lightbox-link><img alt="profiling from span" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/flamechart-in-waterfall.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-19469e9057e1f6afcecbcbc07c715684><img alt="profiling from span" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/flamechart-in-waterfall.png></a></p><p>The pane should show you the Memory Stack Trace Flame Graph <strong>(3)</strong>, you can scroll down and/or make the pane for a better view wider by dragging the right side of the pane.</p><p>As AlwaysOn Profiling is constantly taking snapshots, or stack traces, of your application’s code and reading through thousands of stack traces is not practical, AlwaysOn Profiling aggregates and summarizes profiling data, providing a convenient way to explore Call Stacks in a view called the <strong>Flame Graph</strong>. It represents a summary of all stack traces captured from your application. You can use the Flame Graph to discover which lines of code might be causing performance issues and to confirm whether the changes you make to the code have the intended effect.</p><p>To dive deeper in the Always-on Profiling, select Span <strong>(3)</strong> in the Profiling Pane under <strong>Memory Stack Traces</strong>
This will bring you to the Always-on Profiling main screen, with the Memory view pre selected:</p><p><a href=#R-image-ba72529d06327a0d067ed38d41d3b24d class=lightbox-link><img alt="Profiling main" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/profiling-memory.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ba72529d06327a0d067ed38d41d3b24d><img alt="Profiling main" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/profiling-memory.png></a></p><ul><li>Java Memory Metric Charts <strong>(1)</strong>, Allow you to <code>Monitor Heap Memory, Application Activity</code> like <code>Memory Allocation Rate</code> and <code>Garbage Collecting</code> Metrics.</li><li>Ability to focus/see metrics and Stack Traces only related to the Span <strong>(2)</strong>, This will filter out background activities running in the Java application if required.</li><li>Java Function calls identified.<strong>(3)</strong>, allowing you to drill down into the Methods called from that function.</li><li>The Flame Graph <strong>(4)</strong>, with the visualization of hierarchical based on the stack traces of the profiled service.</li></ul><p>Once you have identified the relevant Function or Method you are interested in, <code>com.mysql.cj.protocol.a.NativePacketPayload.readBytes</code> in our example but yor may differ, so pick the top one <strong>(1)</strong> and find it at the e bottom of the Flame Graph <strong>(2)</strong>. Click on it in the Flame Graph, it will show a pane as shown in the image below, where you can see the Thread information <strong>(3)</strong> by clicking on the blue <em>Show Thread Info</em> link. If you click on the <em>Copy Stack Trace</em> <strong>(4)</strong> button, you grab the actual stack trace that you can use in your coding platform to go to the actual lines of code use at this point (depending of course on your preferred Coding platform)</p><p><a href=#R-image-77d9648b57983e2ae597f08c768aae90 class=lightbox-link><img alt="stack trace" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/grab-stack-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-77d9648b57983e2ae597f08c768aae90><img alt="stack trace" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/grab-stack-trace.png></a></p><p>For more detail on Profiling, check the the <strong>Debug Problems workshop</strong>, or check the documents <a href=https://docs.splunk.com/observability/en/apm/profiling/intro-profiling.html#introduction-to-alwayson-profiling-for-splunk-apm rel=external target=_blank>here</a></p><h2 id=3-database-query-performance>3. Database Query Performance</h2><p>With Database Query Performance, you can monitor the impact of your database queries on service availability directly in Splunk APM. This way, you can quickly identify long-running, unoptimized, or heavy queries and mitigate issues they might be causing, without having to instrument your databases.</p><p>To look at the performance of your database queries, make sure you are in the APM <strong>Explore</strong> page either by going back in the browser or navigate to the APM APM section in the Menu bar, then click on the <strong>Explore</strong> tile.
Select the inferred database service <code>mysql:petclinic</code> Inferred Database server in the Dependency map <strong>(1)</strong>, then scroll the right hand pane to find the <strong>Database Query Performance</strong> Pane <strong>(2)</strong>.</p><p><a href=#R-image-9c1956d2e44d8b2f57dce008c69c81f9 class=lightbox-link><img alt="db-query from map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/db-query-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9c1956d2e44d8b2f57dce008c69c81f9><img alt="db-query from map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/db-query-map.png></a></p><p>If the service you have selected in the map is indeed an (inferred) database server, this pane will populate with the top 90% (P90) database calls based on duration. To dive deeper into the db-query performance function click somewhere on the word <strong>Database Query Performance</strong> at the top of the pane.</p><p>This will bring us to the DB-query Performance overview screen:</p><p><a href=#R-image-acb036dd70a14382cefbd00c821e27cd class=lightbox-link><img alt="db-query full" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/db-query-full.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-acb036dd70a14382cefbd00c821e27cd><img alt="db-query full" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/db-query-full.png></a></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Database Query Normalization</div><div class=box-content><p>By default, Splunk APM instrumentation sanitizes database queries to remove or mask sensible data, such as secrets or personal identifiable information (PII) from the db.statements. You can find how to turn off database query normalization <a href=https://docs.splunk.com/observability/en/apm/db-query-perf/db-perf-troubleshooting.html#turn-off-database-query-normalization rel=external target=_blank>here</a>.</p></div></div><p>This screen will show us all the Database queries <strong>(1)</strong> done towards our database from you application, based on the Traces & Spans send to the Splunk Observability Cloud. Note that you can compare them across a time block or sort them on Total Time, P90 Latency & Requests <strong>(2)</strong>.</p><p>For each Database query in the list, we see the hightest latency, the total number of calls during the time window, and the number of request per second <strong>(3)</strong>. This allows you to identify places where you might optimise your queries.</p><p>You can select traces containing Database Calls via the two charts in the right hand pane <strong>(5)</strong>. Use the Tag Spotlight pane <strong>(6)</strong> to drill down what tag are related to the database calls, based on endpoints or tags.</p><p>If you click on a specific Query <strong>(1)</strong> you get a detailed query Details pane appear <strong>(2)</strong>, you can use for more detailed investigations:
<a href=#R-image-c50ccfb9122d83041653bd95622f4fd5 class=lightbox-link><img alt=details class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/query-details.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c50ccfb9122d83041653bd95622f4fd5><img alt=details class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/../images/query-details.png></a></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>Robert Castley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Feb 16, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=log-observer>Log Observer</h1><h2 id=1-introduction>1. Introduction</h2><p>Until this point, we have not touched or changed our code, yet we did receive Trace & Profiling/DB Query performance information.
If we want to get more out of our Java application, we can introduce a small change to our application log setup.</p><p>This change will configure the Spring PetClinic application to use an Otel-based format to write logs, This will allow the (Auto)-instrumentation to add Otel relevant information into the logs.</p><p>The Splunk Log Observer component is used to view the logs and with this information can automatically relate log information with APM Services and Traces. This feature called <strong>Related Content</strong> will also work with Infrastructure.</p><p>Lets grab the actual code for the application now.</p><h2 id=2-downloading-the-spring-microservices-petclinic-application>2. Downloading the Spring Microservices PetClinic Application</h2><p>For this exercise, we will use the Spring microservices PetClinic application. This is a very popular sample Java application built with the Spring framework (Springboot) and we are using a version witch actual microservices.</p><p>First, clone the PetClinic GitHub repository, as we will need this later in the workshop to compile, build, package and containerize the application:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~<span class=p>;</span>git clone https://github.com/hagen-p/spring-petclinic-microservices.git</span></span></code></pre></div><p>Then change into the spring-petclinic directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/spring-petclinic-microservices</span></span></code></pre></div><h2 id=3-update-logback-config-for-the-services>3. Update Logback config for the services</h2><p>The Spring PetClinic application can be configured to use several different Java logging libraries. In this scenario, the application is using <code>logback</code>. To make sure we get the OTel information in the logs we need to update a file named <code>logback.xml</code> with the log structure, and add an Otel dependency to the <code>pom.xml</code> of each of the services in the petclinic microservices folders.</p><p>First, let&rsquo;s set the Log Structure/Format:</p><p>Spring boot will allow you to set a global template, but for ease of use, we will replace the existing content of the <code>logback-spring.xml</code> files of each service with the following XML content using a prepared script:
Note the following entries that will be added:</p><ul><li>trace_id</li><li>span_id</li><li>trace_flags</li><li>service.name</li><li>deployment.environment
These fields allow the <strong>Splunk</strong> Observability Cloud Suite** to display <strong>Related Content</strong> when used in a pattern shown below:</li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>  <span class=nt>&lt;pattern&gt;</span>
</span></span><span class=line><span class=cl>    logback: %d{HH:mm:ss.SSS} [%thread] severity=%-5level %logger{36} - trace_id=%X{trace_id} span_id=%X{span_id} service.name=%property{otel.resource.service.name} trace_flags=%X{trace_flags} - %msg %kvp{DOUBLE}%n
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/pattern&gt;</span></span></span></code></pre></div><p>So let&rsquo;s run the script that will update the files with the log structure with the format above:</p><div class=tab-panel data-tab-group=b8cda5e561ae70fdbe5c21937ce19d6f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=update-logback-files class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b8cda5e561ae70fdbe5c21937ce19d6f","update-logback-files")'>
<span class=tab-nav-text>Update Logback files</span>
</button>
<button data-tab-item=replace-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b8cda5e561ae70fdbe5c21937ce19d6f","replace-output")'>
<span class=tab-nav-text>Replace Output</span></button></div><div class=tab-content-container><div data-tab-item=update-logback-files class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/update_logback.sh</span></span></code></pre></div></div></div><div data-tab-item=replace-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-admin-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-api-gateway/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-config-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-customers-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-discovery-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-vets-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-visits-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Script execution completed.</span></span></code></pre></div></div></div></div></div><p>We can verify if the replacement has been successful by examining the spring-logback.xml file from one of the services</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /home/splunk/spring-petclinic-microservices/spring-petclinic-customers-service/src/main/resources/logback-spring.xml</span></span></code></pre></div><h2 id=4-reconfigure-and-build-the-services-locally>4. Reconfigure and build the services locally</h2><p>Before we can build the new services with the updated log format we need to add the Opentelemetry dependency tht handles field injection to the <code>Pom.xml</code> of our services:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/add_otel.sh</span></span></code></pre></div><p>The Services are now ready to be built, so run the script that will use the <code>maven</code> command to compile/build/package the PetClinic microservices (Note the -P buildDocker, this will build the new containers):<div class=tab-panel data-tab-group=77c3672be9ed030f63f5547e4559ff3a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=running-maven class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("77c3672be9ed030f63f5547e4559ff3a","running-maven")'>
<span class=tab-nav-text>Running maven</span>
</button>
<button data-tab-item=maven-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("77c3672be9ed030f63f5547e4559ff3a","maven-output")'>
<span class=tab-nav-text>Maven Output</span></button></div><div class=tab-content-container><div data-tab-item=running-maven class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw clean install -D skipTests -P buildDocker</span></span></code></pre></div></div></div><div data-tab-item=maven-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Successfully tagged quay.io/phagen/spring-petclinic-api-gateway:latest
</span></span><span class=line><span class=cl>[INFO] Built quay.io/phagen/spring-petclinic-api-gateway
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Reactor Summary:
</span></span><span class=line><span class=cl>[INFO] 
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-microservices 0.0.1 ............... SUCCESS [  0.770 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-admin-server ...................... SUCCESS [01:03 min]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-customers-service ................. SUCCESS [ 29.031 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-vets-service ...................... SUCCESS [ 22.145 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-visits-service .................... SUCCESS [ 20.451 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-config-server ..................... SUCCESS [ 12.260 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-discovery-server .................. SUCCESS [ 14.174 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-api-gateway 0.0.1 ................. SUCCESS [ 29.832 s]
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] BUILD SUCCESS
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Total time: 03:14 min
</span></span><span class=line><span class=cl>[INFO] Finished at: 2024-01-02T12:43:20Z
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------</span></span></code></pre></div></div></div></div></div></p><p>Given that Kubernetes needs to pull these freshly built images from somewhere, we are going to store them in the repository we tested earlier. To do this, run the script that will push the newly built containers into our local repository:</p><div class=tab-panel data-tab-group=1c4eaaa9ad3c34fd90fb3e61f9395d84><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=pushing-containers class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1c4eaaa9ad3c34fd90fb3e61f9395d84","pushing-containers")'>
<span class=tab-nav-text>pushing Containers</span>
</button>
<button data-tab-item=docker-push-output-partial class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("1c4eaaa9ad3c34fd90fb3e61f9395d84","docker-push-output-partial")'>
<span class=tab-nav-text>Docker Push Output (partial)</span></button></div><div class=tab-content-container><div data-tab-item=pushing-containers class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/push_docker.sh </span></span></code></pre></div></div></div><div data-tab-item=docker-push-output-partial class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The push refers to repository [localhost:5000/spring-petclinic-vets-service]
</span></span><span class=line><span class=cl>0391386bcb2a: Preparing 
</span></span><span class=line><span class=cl>bbb67f51a186: Preparing 
</span></span><span class=line><span class=cl>105351d0ada3: Preparing 
</span></span><span class=line><span class=cl>49cfeae6cb9f: Preparing 
</span></span><span class=line><span class=cl>b4da5101fcde: Preparing 
</span></span><span class=line><span class=cl>49cfeae6cb9f: Pushed 
</span></span><span class=line><span class=cl>e742c14be110: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>540aa741fede: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>a1dfe59d4939: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>1e99e92c46bf: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>f5aa38537736: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>d2210512edb4: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>8e87ff28f1b5: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>local: digest: sha256:42337b2a4ff7d0ac9b7c2cf3c70aa20b7b52d092f1e05d351e031dd7fad956fc size: 3040
</span></span><span class=line><span class=cl>The push refers to repository [localhost:5000/spring-petclinic-customers-service]
</span></span><span class=line><span class=cl>15d54d9adca8: Preparing 
</span></span><span class=line><span class=cl>886f6def5b35: Preparing 
</span></span><span class=line><span class=cl>1575ae90e858: Preparing 
</span></span><span class=line><span class=cl>ccc884d92d18: Preparing 
</span></span><span class=line><span class=cl>b4da5101fcde: Preparing 
</span></span><span class=line><span class=cl>ccc884d92d18: Pushed 
</span></span><span class=line><span class=cl>e742c14be110: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>540aa741fede: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>a1dfe59d4939: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>1e99e92c46bf: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>f5aa38537736: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>d2210512edb4: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>8e87ff28f1b5: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>local: digest: sha256:3601c6e7f58224001946058fb0400483fbb8f1b0ea8a6dbaf403c62b4c1908be size: 3042</span></span></code></pre></div></div></div></div></div><p>The containers should now be stored in the local repository, lets confirm by checking the catalog,</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> curl -X GET http://localhost:9999/v2/_catalog </span></span></code></pre></div><p>The result should be :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{&#34;repositories&#34;:[&#34;spring-petclinic-admin-server&#34;,&#34;spring-petclinic-api-gateway&#34;,&#34;spring-petclinic-config-server&#34;,&#34;spring-petclinic-customers-service&#34;,&#34;spring-petclinic-discovery-server&#34;,&#34;spring-petclinic-vets-service&#34;,&#34;spring-petclinic-visits-service&#34;]}</span></span></code></pre></div><h2 id=5-deploy-new-services-to-kubernetes>5. Deploy new services to Kubernetes</h2><p>To see the changes in effect, we need to redeploy the services, First, let&rsquo;s change the location of the images from the external repo to the local one by running the following script:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/set_local.sh</span></span></code></pre></div><p>The result is a new file on disk called <strong>petclinic-local.yaml</strong>. Let&rsquo;s switch to the local versions by using the new version of the <code>deployment yaml</code>. First delete the old containers from the original deployment with:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete -f ~/workshop/petclinic/petclinic-local.yaml</span></span></code></pre></div><p>followed by:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/petclinic-local.yaml</span></span></code></pre></div><p>This will cause the containers to be replaced with the local version, you can verify this by checking the containers:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>The resulting output should say <code>localhost:9999</code> :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  Image:         localhost:9999/spring-petclinic-api-gateway:local</span></span></code></pre></div><p>However, as we only patched the deployment before, the new deployment does not have the right annotations for zero config auto-instrumentation, so lets fix that now by running the patch command again:</p><p>Note, there will be no change for the <em>config-server & discovery-server</em> as they do hav e the annotation included in the deployment.</p><div class=tab-panel data-tab-group=e645e3b5268cb796a7de59ddafad253c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-all-petclinic-services class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e645e3b5268cb796a7de59ddafad253c","patch-all-petclinic-services")'>
<span class=tab-nav-text>Patch all Petclinic services</span>
</button>
<button data-tab-item=kubectl-patch-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("e645e3b5268cb796a7de59ddafad253c","kubectl-patch-output")'>
<span class=tab-nav-text>kubectl patch Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-all-petclinic-services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments -l app.kubernetes.io/part-of<span class=o>=</span>spring-petclinic -o name <span class=p>|</span> xargs -I % kubectl patch % -p <span class=s2>&#34;{\&#34;spec\&#34;: {\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;instrumentation.opentelemetry.io/inject-java\&#34;:\&#34;default/splunk-otel-collector\&#34;}}}}}&#34;</span></span></span></code></pre></div></div></div><div data-tab-item=kubectl-patch-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/admin-server patched
</span></span><span class=line><span class=cl>deployment.apps/customers-service patched
</span></span><span class=line><span class=cl>deployment.apps/visits-service patched
</span></span><span class=line><span class=cl>deployment.apps/discovery-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/vets-service patched
</span></span><span class=line><span class=cl>deployment.apps/api-gateway patched</span></span></code></pre></div></div></div></div></div><p>Lets check the <code>api-gateway</code> container again</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>The resulting output should say (again if you see double, its the old container being terminated, give it a few seconds):</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.30.0
</span></span><span class=line><span class=cl>  Image:         localhost:9999/spring-petclinic-api-gateway:local</span></span></code></pre></div><h2 id=6-view-logs>6. View Logs</h2><p>Once the containers are patched they will be restarted, let&rsquo;s go back to the <strong>Splunk Observability Cloud</strong> with the URL provided by the Instructor to check our cluster in the Kubernetes Navigator.</p><p>After a couple of minutes or so you should see that the Pods are being restarted by the operator and the Zero config container will be added. This will look similar to the screenshot below:</p><p><a href=#R-image-2cf120da383dac423385d482d1b57a7b class=lightbox-link><img alt=restart class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/k8s-navigator-restarted-pods.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2cf120da383dac423385d482d1b57a7b><img alt=restart class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/k8s-navigator-restarted-pods.png></a></p><p>Wait for the pods to turn green again.(You may want to refresh the screen), then from the left-hand menu click on <strong>Log Observer</strong> <a href=#R-image-d077ea3b2aa071b9eb7f77aa6270ad1f class=lightbox-link><img alt=Logo class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/logo-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d077ea3b2aa071b9eb7f77aa6270ad1f><img alt=Logo class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/logo-icon.png?classes=inline&height=25px"></a> and ensure <strong>Index</strong> is set to <strong>splunk4rookies-workshop</strong>.</p><p>Next, click <strong>Add Filter</strong> search for the field <code>deployment.environment</code> and select the value of rou Workshop (Remember the INSTANCE value ?) and click <code>=</code> (include). You should now see only the log messages from your PetClinic application.</p><p>Next search for the field <code>service_name</code> select the value <code>customers-service</code> and click <code>=</code> (include). Now the log files should be reduce to just the lines from your <code>customers-service</code>.</p><p>Wait for Log Lines to show up with an injected trace-id like trace_id=08b5ce63e46ddd0ce07cf8cfd2d6161a as show below <strong>(1)</strong>:</p><p><a href=#R-image-76a860f0c81b79d11b6a2dc94f186b59 class=lightbox-link><img alt="Log Observer" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/log-observer-trace-info.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-76a860f0c81b79d11b6a2dc94f186b59><img alt="Log Observer" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/log-observer-trace-info.png></a></p><p>Click on a line with an injected trace_id, this should be all log lines created by your services that are part of a trace <strong>(1)</strong>.
A Side pane opens where you can see the related information about your logs. including the relevant Trace and Span Id&rsquo;s <strong>(2)</strong>.</p><p>Also, at the bottom next to APM, there should be a number, this is the number of related AP Content items for this log line. click on the APM pane <strong>(1)</strong> as show below:
<a href=#R-image-ea1fd45872e52c19dc20d23a6aa43483 class=lightbox-link><img alt=RC class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/log-apm-rc.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ea1fd45872e52c19dc20d23a6aa43483><img alt=RC class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/log-apm-rc.png></a></p><ul><li>The <em>Map for customers-service</em> <strong>(2)</strong> brings us to the APM dependency map with the workflow focused on Customer Services, allowing you to quick understand how this log line is related to the overall flow of service interaction.</li><li>The <em>Trace for 34c98cbf7b300ef3dedab49da71a6ce3</em> <strong>(3)</strong> will bring us to the waterfall in APM for this specific trace that this log line was generated in.</li></ul><p>As a last exercise, click on the Trace for Link, this will bering you to the waterfall for this specific trace:</p><p><a href=#R-image-b9eed7a16cb007d6f7727c9b181e17a7 class=lightbox-link><img alt="waterfall logs" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/waterfall-with-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b9eed7a16cb007d6f7727c9b181e17a7><img alt="waterfall logs" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/waterfall-with-logs.png></a></p><p>Note that you now have Logs Related Content Pane <strong>(1)</strong> appear, clicking on this will bring you back to log observer with all the logs line that are part of this Trace.
This will help you to quickly find relevant log lines for an interaction or a problem.</p><h2 id=7-summary>7. Summary</h2><p>This is the end of the workshop and we have certainly covered a lot of ground. At this point, you should have metrics, traces, logs, database query performance and code profiling being reported into Splunk Observability Cloud.</p><p><strong>Congratulations!</strong></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>Robert Castley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Feb 16, 2024</span></span></footer></article></section></div></main></div><script src=../../../../js/clipboard.min.js?1715859607 defer></script><script src=../../../../js/perfect-scrollbar.min.js?1715859607 defer></script><script src=../../../../js/theme.js?1715859607 defer></script></body></html>