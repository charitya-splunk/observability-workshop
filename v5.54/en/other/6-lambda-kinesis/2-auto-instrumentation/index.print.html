<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.125.5"><meta name=generator content="Relearn 6.0.0+tip"><meta name=description content="Auto-Instrumentation Navigate to the auto directory that contains auto-instrumentation code.
​ Command cd ~/o11y-lambda-lab/auto Inspect the contents of the files in this directory. Take a look at the serverless.yml template.
​ Command cat serverless.yml Workshop Question Can you identify which AWS entities are being created by this template? Can you identify where OpenTelemetry instrumentation is being set up? Can you determine which instrumentation information is being provided by the Environment Variables?"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Auto-Instrumentation :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="Auto-Instrumentation Navigate to the auto directory that contains auto-instrumentation code.
​ Command cd ~/o11y-lambda-lab/auto Inspect the contents of the files in this directory. Take a look at the serverless.yml template.
​ Command cat serverless.yml Workshop Question Can you identify which AWS entities are being created by this template? Can you identify where OpenTelemetry instrumentation is being set up? Can you determine which instrumentation information is being provided by the Environment Variables?"><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.54/en/other/6-lambda-kinesis/2-auto-instrumentation/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Auto-Instrumentation :: Splunk Observability Cloud Workshops"><meta property="og:description" content="Auto-Instrumentation Navigate to the auto directory that contains auto-instrumentation code.
​ Command cd ~/o11y-lambda-lab/auto Inspect the contents of the files in this directory. Take a look at the serverless.yml template.
​ Command cat serverless.yml Workshop Question Can you identify which AWS entities are being created by this template? Can you identify where OpenTelemetry instrumentation is being set up? Can you determine which instrumentation information is being provided by the Environment Variables?"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="Ninja Workshops"><meta property="article:modified_time" content="2023-12-21T14:15:53+00:00"><meta itemprop=name content="Auto-Instrumentation :: Splunk Observability Cloud Workshops"><meta itemprop=description content="Auto-Instrumentation Navigate to the auto directory that contains auto-instrumentation code.
​ Command cd ~/o11y-lambda-lab/auto Inspect the contents of the files in this directory. Take a look at the serverless.yml template.
​ Command cat serverless.yml Workshop Question Can you identify which AWS entities are being created by this template? Can you identify where OpenTelemetry instrumentation is being set up? Can you determine which instrumentation information is being provided by the Environment Variables?"><meta itemprop=dateModified content="2023-12-21T14:15:53+00:00"><meta itemprop=wordCount content="532"><title>Auto-Instrumentation :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.54/en/other/6-lambda-kinesis/2-auto-instrumentation/index.html rel=canonical type=text/html title="Auto-Instrumentation :: Splunk Observability Cloud Workshops"><link href=../../../../images/favicon.ico?1715858742 rel=icon type=image/x-icon sizes=any><link href=../../../../css/fontawesome-all.min.css?1715858756 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fontawesome-all.min.css?1715858756 rel=stylesheet></noscript><link href=../../../../css/nucleus.css?1715858756 rel=stylesheet><link href=../../../../css/auto-complete.css?1715858756 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/auto-complete.css?1715858756 rel=stylesheet></noscript><link href=../../../../css/perfect-scrollbar.min.css?1715858756 rel=stylesheet><link href=../../../../css/fonts.css?1715858756 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fonts.css?1715858756 rel=stylesheet></noscript><link href=../../../../css/theme.css?1715858756 rel=stylesheet><link href=../../../../css/theme-splunk-light.css?1715858756 rel=stylesheet id=R-variant-style><link href=../../../../css/chroma-relearn-light.css?1715858756 rel=stylesheet id=R-variant-chroma-style><link href=../../../../css/variant.css?1715858756 rel=stylesheet><link href=../../../../css/print.css?1715858756 rel=stylesheet media=print><link href=../../../../css/format-print.css?1715858756 rel=stylesheet><script src=../../../../js/variant.js?1715858756></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.54",window.index_js_url="../../../../en/index.search.js",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"eu0",rumAccessToken:"TR9BBfgYo7qJfqrfgqjoqA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"eu0",rumAccessToken:"TR9BBfgYo7qJfqrfgqjoqA"})</script></script><style>:root{--MAIN-WIDTH-MAX:1000rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../../en/other/6-lambda-kinesis/2-auto-instrumentation/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/other/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/other/6-lambda-kinesis/index.html><span itemprop=name>Lambda Tracing and Kinesis</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>2. Auto-Instrumentation</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../../../../en/other/6-lambda-kinesis/1-setup/index.html title="Setup (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../../../../en/other/6-lambda-kinesis/3-lambdas-in-splunk/index.html title="Lambdas in Splunk APM (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=auto-instrumentation>Auto-Instrumentation</h1><h2 id=auto-instrumentation>Auto-Instrumentation</h2><p>Navigate to the auto directory that contains auto-instrumentation code.</p><div class=tab-panel data-tab-group=3409fe4839b5b57992638176e30a22f2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3409fe4839b5b57992638176e30a22f2","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>cd ~/o11y-lambda-lab/auto</code></pre></div></div></div></div></div><p>Inspect the contents of the files in this directory. Take a look at the serverless.yml template.</p><div class=tab-panel data-tab-group=14158f487dcd822b50a100ca3b27d927><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("14158f487dcd822b50a100ca3b27d927","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>cat serverless.yml</code></pre></div></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><ul><li>Can you identify which AWS entities are being created by this template?</li><li>Can you identify where OpenTelemetry instrumentation is being set up?</li><li>Can you determine which instrumentation information is being provided by the Environment Variables?</li></ul></div></div><p>You should see the Splunk OpenTelemetry Lambda layer being added to each fuction.</p><div class="highlight wrap-code"><pre tabindex=0><code>layers:
      - arn:aws:lambda:us-east-1:254067382080:layer:splunk-apm:70</code></pre></div><p>You can see the relevant layer ARNs (Amazon Resource Name) and latest versions for each AWS region here: <a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md rel=external target=_blank>https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md</a></p><p>You should also see a section where the Environment variables that are being set.</p><div class="highlight wrap-code"><pre tabindex=0><code>environment:
  AWS_LAMBDA_EXEC_WRAPPER: /opt/nodejs-otel-handler
  OTEL_RESOURCE_ATTRIBUTES: deployment.environment=${self:custom.prefix}-apm-lambda
  OTEL_SERVICE_NAME: consumer-lambda
  SPLUNK_ACCESS_TOKEN: ${self:custom.accessToken}
  SPLUNK_REALM: ${self:custom.realm}</code></pre></div><p>Using the environment variables we are configuring and enriching our auto-instrumentation.</p><p>Here we provide minimum information, such as NodeJS wrapper location in the Splunk APM Layer, environment name, service name, and our Splunk Org credentials. We are sending trace data directly to Splunk Observability Cloud. You could alternatively export traces to an OpenTelemetry Collector set up in Gateway mode.</p><p>Take a look at the function code.</p><div class=tab-panel data-tab-group=805fa1ca801a298c7289952f37250082><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("805fa1ca801a298c7289952f37250082","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>cat handler.js</code></pre></div></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><ul><li>Can you identify the code for producer function?</li><li>Can you identify the code for consumer function?</li></ul></div></div><p>Notice there is no mention of Splunk or OpenTelemetry in the code. We are adding the instrumentation using the Lambda layer and Environment Variables only.</p><h2 id=deploy-your-lambdas>Deploy your Lambdas</h2><p>Run the following command to deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=23daf0f11243412876dcad97e41416ac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=deploy-command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("23daf0f11243412876dcad97e41416ac","deploy-command")'>
<span class=tab-nav-text>Deploy Command</span>
</button>
<button data-tab-item=expected-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("23daf0f11243412876dcad97e41416ac","expected-output")'>
<span class=tab-nav-text>Expected Output</span></button></div><div class=tab-content-container><div data-tab-item=deploy-command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>sls deploy</code></pre></div></div></div><div data-tab-item=expected-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>Deploying hostname-lambda-lab to stage dev (us-east-1)
...
...
endpoint: POST - https://randomstring.execute-api.us-east-1.amazonaws.com/dev/producer
functions:
  producer: hostname-lambda-lab-dev-producer (1.6 kB)
  consumer: hostname-lambda-lab-dev-consumer (1.6 kB)</code></pre></div></div></div></div></div><p>This command will follow the instructions in your serverless.yml template to create your Lambda functions and your Kinesis stream. Note it may take a 1-2 minutes to execute.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>serverless.yml is in fact a CloudFormation template. CloudFormation is an infrastructure as code service from AWS. You can read more about it here - <a href=https://aws.amazon.com/cloudformation/ rel=external target=_blank>https://aws.amazon.com/cloudformation/</a></div></div><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=f424f3be9e7e22c271d8838391d1f6a9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f424f3be9e7e22c271d8838391d1f6a9","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>sls info</code></pre></div></div></div></div></div><p>Take note of your endpoint value:
<a href=#R-image-4d991462822a0c9392194d1130788b5d class=lightbox-link><img alt=2-auto-1-endpoint-value class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../../../en/other/6-lambda-kinesis/2-auto-instrumentation/../images/2-auto-1-endpoint-value.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4d991462822a0c9392194d1130788b5d><img alt=2-auto-1-endpoint-value class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../../../en/other/6-lambda-kinesis/2-auto-instrumentation/../images/2-auto-1-endpoint-value.png></a></p><h2 id=send-some-traffic>Send some Traffic</h2><p>Use the curl command to send a payload to your producer function. Note the command option -d is followed by your message payload.</p><p>Try changing the value of name to your name and telling the Lambda function about your superpower. Replace YOUR_ENDPOINT with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=4a679e1621ad7d03260a454903dc7fce><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4a679e1621ad7d03260a454903dc7fce","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>curl -d &#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39; YOUR_ENDPOINT</code></pre></div></div></div></div></div><p>For example:</p><div class="highlight wrap-code"><pre tabindex=0><code>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer</code></pre></div><p>You should see the following output if your message is successful:</p><div class="highlight wrap-code"><pre tabindex=0><code>{&#34;message&#34;:&#34;Message placed in the Event Stream: hostname-eventSteam&#34;}</code></pre></div><p>If unsuccessful, you will see:</p><div class="highlight wrap-code"><pre tabindex=0><code>{&#34;message&#34;: &#34;Internal server error&#34;}</code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: re-send that messate 5+ times. You should keep seeing a success message after each send.</p><p>Check the lambda logs output:</p><p>Producer function logs:</p><div class=tab-panel data-tab-group=16b32d507498b68365acd21ebc33ba20><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=producer-function-logs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("16b32d507498b68365acd21ebc33ba20","producer-function-logs")'>
<span class=tab-nav-text>Producer Function Logs</span></button></div><div class=tab-content-container><div data-tab-item=producer-function-logs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>sls logs -f producer</code></pre></div></div></div></div></div><p>Consumer function logs:</p><div class=tab-panel data-tab-group=27d5a2676088d7644290c2df8ff2b45f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=consumer-function-logs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("27d5a2676088d7644290c2df8ff2b45f","consumer-function-logs")'>
<span class=tab-nav-text>Consumer Function Logs</span></button></div><div class=tab-content-container><div data-tab-item=consumer-function-logs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code>sls logs -f consumer</code></pre></div></div></div></div></div><p>Examine the logs carefully.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-question"></i> Workshop Question</div><div class=box-content><p>Do you see OpenTelemetry being loaded? Look out for lines with splunk-extension-wrapper.</p></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>Robert Castley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Dec 21, 2023</span></span></footer></article></div></main></div><script src=../../../../js/clipboard.min.js?1715858756 defer></script><script src=../../../../js/perfect-scrollbar.min.js?1715858756 defer></script><script src=../../../../js/theme.js?1715858756 defer></script></body></html>