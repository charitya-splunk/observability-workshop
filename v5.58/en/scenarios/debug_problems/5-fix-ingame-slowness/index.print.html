<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.125.5"><meta name=generator content="Relearn 6.0.0+tip"><meta name=description content="Now that our game startup slowness has been resolved, let’s play several rounds of the Door Game and ensure the rest of the game performs quickly.
As you play the game, do you notice any other slowness? Let’s look at the data in Splunk Observability Cloud to put some numbers on what we’re seeing.
Review Game Performance in Splunk Observability Cloud Navigate to APM then click on Traces on the right-hand side of the screen."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Fix In Game Slowness :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="Now that our game startup slowness has been resolved, let’s play several rounds of the Door Game and ensure the rest of the game performs quickly.
As you play the game, do you notice any other slowness? Let’s look at the data in Splunk Observability Cloud to put some numbers on what we’re seeing.
Review Game Performance in Splunk Observability Cloud Navigate to APM then click on Traces on the right-hand side of the screen."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.58/en/scenarios/debug_problems/5-fix-ingame-slowness/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Fix In Game Slowness :: Splunk Observability Cloud Workshops"><meta property="og:description" content="Now that our game startup slowness has been resolved, let’s play several rounds of the Door Game and ensure the rest of the game performs quickly.
As you play the game, do you notice any other slowness? Let’s look at the data in Splunk Observability Cloud to put some numbers on what we’re seeing.
Review Game Performance in Splunk Observability Cloud Navigate to APM then click on Traces on the right-hand side of the screen."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="Scenarios"><meta property="article:modified_time" content="2024-03-27T10:00:41-07:00"><meta itemprop=name content="Fix In Game Slowness :: Splunk Observability Cloud Workshops"><meta itemprop=description content="Now that our game startup slowness has been resolved, let’s play several rounds of the Door Game and ensure the rest of the game performs quickly.
As you play the game, do you notice any other slowness? Let’s look at the data in Splunk Observability Cloud to put some numbers on what we’re seeing.
Review Game Performance in Splunk Observability Cloud Navigate to APM then click on Traces on the right-hand side of the screen."><meta itemprop=dateModified content="2024-03-27T10:00:41-07:00"><meta itemprop=wordCount content="738"><title>Fix In Game Slowness :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.58/en/scenarios/debug_problems/5-fix-ingame-slowness/index.html rel=canonical type=text/html title="Fix In Game Slowness :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.58/images/favicon.ico?1715860666 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.58/css/fontawesome-all.min.css?1715860682 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.58/css/fontawesome-all.min.css?1715860682 rel=stylesheet></noscript><link href=/observability-workshop/v5.58/css/nucleus.css?1715860682 rel=stylesheet><link href=/observability-workshop/v5.58/css/auto-complete.css?1715860682 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.58/css/auto-complete.css?1715860682 rel=stylesheet></noscript><link href=/observability-workshop/v5.58/css/perfect-scrollbar.min.css?1715860682 rel=stylesheet><link href=/observability-workshop/v5.58/css/fonts.css?1715860682 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.58/css/fonts.css?1715860682 rel=stylesheet></noscript><link href=/observability-workshop/v5.58/css/theme.css?1715860682 rel=stylesheet><link href=/observability-workshop/v5.58/css/theme-splunk-light.css?1715860682 rel=stylesheet id=R-variant-style><link href=/observability-workshop/v5.58/css/chroma-relearn-light.css?1715860682 rel=stylesheet id=R-variant-chroma-style><link href=/observability-workshop/v5.58/css/variant.css?1715860682 rel=stylesheet><link href=/observability-workshop/v5.58/css/print.css?1715860682 rel=stylesheet media=print><link href=/observability-workshop/v5.58/css/format-print.css?1715860682 rel=stylesheet><script src=/observability-workshop/v5.58/js/variant.js?1715860682></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../..",window.relearn.relBaseUri="../../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.58",window.index_js_url="/observability-workshop/v5.58/en/index.search.js",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"eu0",rumAccessToken:"TR9BBfgYo7qJfqrfgqjoqA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"eu0",rumAccessToken:"TR9BBfgYo7qJfqrfgqjoqA"})</script></script><style>:root{--MAIN-WIDTH-MAX:1000rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v5.58/en/scenarios/debug_problems/5-fix-ingame-slowness/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.58/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.58/en/scenarios/index.html><span itemprop=name>Scenarios</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.58/en/scenarios/debug_problems/index.html><span itemprop=name>Debug Problems in Microservices</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>5 Fix In Game Slowness</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.58/en/scenarios/debug_problems/4-fix-app-startup-slowness/index.html title="Fix Application Startup Slowness (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.58/en/scenarios/debug_problems/6-summary/index.html title="Summary (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=fix-in-game-slowness>Fix In Game Slowness</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>Now that our game startup slowness has been resolved, let&rsquo;s play several rounds of the Door Game and ensure the rest of the game performs quickly.</p><p>As you play the game, do you notice any other slowness? Let&rsquo;s look at the data in <strong>Splunk Observability</strong> Cloud to put some numbers on what we&rsquo;re seeing.</p><h3 id=review-game-performance-in-splunk-observability-cloud>Review Game Performance in Splunk Observability Cloud</h3><p>Navigate to APM then click on Traces on the right-hand side of the screen. Sort the traces by Duration in descending order:</p><p><a href=#R-image-9af4145ef182026544fb6424281b4254 class=lightbox-link><img alt="Slow Traces" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.58/en/scenarios/debug_problems/5-fix-ingame-slowness/../images/slow_trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9af4145ef182026544fb6424281b4254><img alt="Slow Traces" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.58/en/scenarios/debug_problems/5-fix-ingame-slowness/../images/slow_trace.png></a></p><p>We can see that a few of the traces with an operation of <code>GET /game/:uid/picked/:picked/outcome</code> have a duration of just over five seconds. This explains why we&rsquo;re still seeing some slowness when we play the app (note that the slowness is no longer on the game startup operation, <code>GET /new-game</code>, but rather a different operation used while actually playing the game).</p><p>Let&rsquo;s click on one of the slow traces and take a closer look. Since profiling is still enabled, call stacks have been captured as part of this trace. Click on the child span in the waterfall view, then click CPU Stack Traces:</p><p><a href=#R-image-933b49b741956a3f64890d6eb3085ff1 class=lightbox-link><img alt="View Stack on Span" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.58/en/scenarios/debug_problems/5-fix-ingame-slowness/../images/view_stack_on_span.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-933b49b741956a3f64890d6eb3085ff1><img alt="View Stack on Span" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.58/en/scenarios/debug_problems/5-fix-ingame-slowness/../images/view_stack_on_span.png></a></p><p>At the bottom of the call stack, we can see that the thread was busy sleeping:</p><div class="highlight wrap-code"><pre tabindex=0><code class=language-log data-lang=log>com.splunk.profiling.workshop.ServiceMain$$Lambda$.handle(Unknown Source:0)
com.splunk.profiling.workshop.ServiceMain.lambda$main$(ServiceMain.java:34)
com.splunk.profiling.workshop.DoorGame.getOutcome(DoorGame.java:41)
com.splunk.profiling.workshop.DoorChecker.isWinner(DoorChecker.java:14)
com.splunk.profiling.workshop.DoorChecker.checkDoorTwo(DoorChecker.java:30)
com.splunk.profiling.workshop.DoorChecker.precheck(DoorChecker.java:36)
com.splunk.profiling.workshop.Util.sleep(Util.java:9)
java.util.concurrent.TimeUnit.sleep(Unknown Source:0)
java.lang.Thread.sleep(Unknown Source:0)
java.lang.Thread.sleep(Native Method:0)</code></pre></div><p>The call stack tells us a story &ndash; reading from the bottom up, it lets us describe
what is happening inside the service code. A developer, even one unfamiliar with the
source code, should be able to look at this call stack to craft a narrative like:</p><blockquote><p>We are getting the outcome of a game. We leverage the DoorChecker to
see if something is the winner, but the check for door two somehow issues
a precheck() that, for some reason, is deciding to sleep for a long time.</p></blockquote><p>Our workshop application is left intentionally simple &ndash; a real-world service might see the
thread being sampled during a database call or calling into an un-traced external service.
It is also possible that a slow span is executing a complicated business process,
in which case maybe none of the stack traces relate to each other at all.</p><p>The longer a method or process is, the greater chance we will have call stacks
sampled during its execution.</p><h3 id=lets-fix-that-bug>Let&rsquo;s Fix That Bug</h3><p>By using the profiling tool, we were able to determine that our application is slow
when issuing the <code>DoorChecker.precheck()</code> method from inside <code>DoorChecker.checkDoorTwo()</code>.
Let&rsquo;s open the <code>doorgame/src/main/java/com/splunk/profiling/workshop/DoorChecker.java</code> source file in our editor.</p><p>By quickly glancing through the file, we see that there are methods for checking
each door, and all of them call <code>precheck()</code>. In a real service, we might be uncomfortable
simply removing the <code>precheck()</code> call because there could be unseen/unaccounted side
effects.</p><p>Down on line 29 we see the following:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>checkDoorTwo</span><span class=p>(</span><span class=n>GameInfo</span><span class=w> </span><span class=n>gameInfo</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>precheck</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>gameInfo</span><span class=p>.</span><span class=na>isWinner</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>precheck</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>doorNum</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>extra</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=na>pow</span><span class=p>(</span><span class=n>70</span><span class=p>,</span><span class=w> </span><span class=n>doorNum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>300</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>extra</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></div><p>With our developer hat on, we notice that the door number is zero based, so
the first door is 0, the second is 1, and the 3rd is 2 (this is conventional).
The <code>extra</code> value is used as extra/additional sleep time, and it is computed by taking
<code>70^doorNum</code> (<code>Math.pow</code> performs an exponent calculation). That&rsquo;s odd, because this means:</p><ul><li>door 0 => 70^0 => 1ms</li><li>door 1 => 70^1 => 70ms</li><li>door 2 => 70^2 => 4900ms</li></ul><p>We&rsquo;ve found the root cause of our slow bug! This also explains why the first two doors
weren&rsquo;t ever very slow.</p><p>We have a quick chat with our product manager and team lead, and we agree that the <code>precheck()</code>
method must stay but that the extra padding isn&rsquo;t required. Let&rsquo;s remove the <code>extra</code> variable
and make <code>precheck</code> now read like this:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>precheck</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>doorNum</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleep</span><span class=p>(</span><span class=n>300</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></div><p>Now all doors will have a consistent behavior. Save your work and then rebuild and redeploy the application using the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> workshop/profiling
</span></span><span class=line><span class=cl>./5-redeploy-doorgame.sh</span></span></code></pre></div><p>Once the application has been redeployed successfully, visit The Door Game again to confirm that your fix is in place:
<code>http://&lt;your IP address>:81</code></p><h2 id=what-did-we-accomplish>What did we accomplish?</h2><ul><li>We found another performance issue with our application that impacts game play.</li><li>We used the CPU call stacks included in the trace to understand application behavior.</li><li>We learned how the call stack can tell us a story and point us to suspect lines of code.</li><li>We identified the slow code and fixed it to make it faster.</li></ul><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>dmitchsplunk</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Mar 27, 2024</span></span></footer></article></div></main></div><script src=/observability-workshop/v5.58/js/clipboard.min.js?1715860682 defer></script><script src=/observability-workshop/v5.58/js/perfect-scrollbar.min.js?1715860682 defer></script><script src=/observability-workshop/v5.58/js/theme.js?1715860682 defer></script></body></html>