<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta name=generator content="Relearn 5.23.2+tip"><meta name=description content="Splunk Observability Workshops"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Ninja Workshops (Work In Progress) :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="Splunk Observability Workshops"><meta property="og:title" content="Ninja Workshops (Work In Progress) :: Splunk Observability Cloud Workshops"><meta property="og:description" content="Splunk Observability Workshops"><meta property="og:type" content="website"><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.35/en/other/wip/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><title>Ninja Workshops (Work In Progress) :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v5.35/en/other/wip/index.html rel=canonical type=text/html title="Ninja Workshops (Work In Progress) :: Splunk Observability Cloud Workshops"><link href=../../../en/other/wip/index.xml rel=alternate type=application/rss+xml title="Ninja Workshops (Work In Progress) :: Splunk Observability Cloud Workshops"><link href=../../../images/favicon.ico?1702664718 rel=icon type=image/x-icon sizes=any><link href=../../../css/fontawesome-all.min.css?1702664723 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/fontawesome-all.min.css?1702664723 rel=stylesheet></noscript><link href=../../../css/nucleus.css?1702664723 rel=stylesheet><link href=../../../css/auto-complete.css?1702664723 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/auto-complete.css?1702664723 rel=stylesheet></noscript><link href=../../../css/perfect-scrollbar.min.css?1702664723 rel=stylesheet><link href=../../../css/fonts.css?1702664723 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/fonts.css?1702664723 rel=stylesheet></noscript><link href=../../../css/theme.css?1702664723 rel=stylesheet><link href=../../../css/theme-splunk-light.css?1702664723 rel=stylesheet id=R-variant-style><link href=../../../css/variant.css?1702664723 rel=stylesheet><link href=../../../css/print.css?1702664723 rel=stylesheet media=print><link href=../../../css/format-print.css?1702664723 rel=stylesheet><link href=../../../css/ie.css?1702664723 rel=stylesheet><script src=../../../js/url.js?1702664723></script>
<script src=../../../js/variant.js?1702664723></script>
<script>window.index_js_url="../../../en/index.search.js";var root_url="../../../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://splunk.github.io/observability-workshop/v5.35/",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script>
<script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script>
<script>SplunkRum.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rum",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g",app:"observability-workshop",version:"1",environment:"observability-workshop-env"}),SplunkSessionRecorder.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rumreplay",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g"})</script><style>@media screen and (min-width:1000px){#R-body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1000px;width:100%}}:root{--MENU-WIDTH-L:21rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../en/other/wip/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)">
<i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../en/other/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Ninja Workshops (Work In Progress)</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable home" tabindex=-1><div class=flex-block-wrapper><article class=home><header class=headline></header><h1 id=ninja-workshops-work-in-progress>Ninja Workshops (Work In Progress)</h1><div class="children children-h5 children-sort-"><h5><a href=../../../en/other/wip/pet-clinic/index.html>Workshop using the Java microservices Pet Clinic demo.(Docker based).</a></h5><p>The goal is to walk through the basic steps to configure the following components of the Splunk Observability Cloud platform:
Splunk Infrastructure Monitoring (IM) Splunk Auto Instrumentation for Java (APM) Database Query Performance AlwaysOn Profiling Splunk Real User Monitoring (RUM) RUM to APM Correlation Splunk Log Observer (LO) We will also show the steps about how to clone (download) a sample micro services Java application (Spring PetClinic), as well as how to compile, package and run the application.</p></div><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Ninja Workshops (Work In Progress)</h1><article class=default><header class=headline></header><h1 id=workshop-using--the-java-microservices-pet-clinic-demodocker-based>Workshop using the Java microservices Pet Clinic demo.(Docker based).</h1><p>The goal is to walk through the basic steps to configure the following components of the <strong>Splunk Observability Cloud</strong> platform:</p><ul><li>Splunk Infrastructure Monitoring (IM)</li><li>Splunk Auto Instrumentation for Java (APM)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li><li>Splunk Real User Monitoring (RUM)</li><li>RUM to APM Correlation</li><li>Splunk Log Observer (LO)</li></ul><p>We will also show the steps about how to clone (download) a sample micro services Java application (Spring PetClinic), as well as how to compile, package and run the application.</p><p>Once the application is up and running, we will instantly start seeing metrics and traces via the <strong>Auto Instrumentation</strong> for Java that will be used by the <strong>Splunk APM</strong> product.</p><p>After that, we will instrument PetClinic&rsquo;s end user interface (HTML pages rendered by the application) with the <strong>Splunk OpenTelemetry Javascript Libraries (RUM)</strong> that will generate RUM traces around all the individual clicks and page loads executed by an end user.</p><p>Lastly, we will configure the Spring PetClinic application to write application logs to the filesystem and also configure the Splunk OpenTelemetry Collector to read (tail) the logs and send them to <strong>Splunk Cloud</strong>.</p><div class="box notices cstyle primary"><div class=box-label><i class="fa-fw fas fa-info"></i> Prerequisites</div><div class=box-content><ul><li>Outbound SSH access to port <code>2222</code>.</li><li>Outbound HTTP access to port <code>8083</code>.</li><li>Familiarity with the <code>bash</code> shell and <code>vi/vim</code> editor.</li></ul></div></div><p><a href=#R-image-59b25d63c902ccdb8afbcea51cd00432 class=lightbox-link><img src=../../../en/other/wip/pet-clinic/images/petclinic-exercise.png alt="PetClinic Exercise" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-59b25d63c902ccdb8afbcea51cd00432><img src=../../../en/other/wip/pet-clinic/images/petclinic-exercise.png alt="PetClinic Exercise" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Workshop using the Java microservices Pet Clinic demo.(Docker based).</h1><article class=default><header class=headline></header><h1 id=preparation-of-the-pet-clinic-application>Preparation of the Pet Clinic application.</h1><h2 id=1-spring-petclinic-application-build>1. Spring PetClinic Application build</h2><p>The first thing we need to set up is&mldr; well, an application. For this exercise, we will use the Spring PetClinic application. This is a very popular sample Java application built with the Spring framework (Springboot). We are using the Micro services version of it.</p><p>First, clone the PetClinic GitHub repository, and then we will compile, build, package and containerize the application:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/hagen-p/spring-petclinic-microservices.git</span></span></code></pre></div><p>Change into the <code>spring-petclinic</code> directory (and checkout a specific commit):</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> spring-petclinic-microservices</span></span></code></pre></div><p>Next, run the script that will use the <code>maven</code> command to compile/build/package the PetClinic Micro services into Docker containers:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ./scripts/build.sh</span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>This will take a few minutes the first time you run, <code>maven</code> will download a lot of dependencies before it compiles the application. Future builds will be a lot quicker.</p></div></div><h2 id=2-check-docker-images>2. Check Docker Images</h2><p>Once the build completes, you need to verify if the containers are indeed build:</p><div class=tab-panel data-tab-group=507a325fb68e263c52c029383866d443><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=check-docker-containers class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("507a325fb68e263c52c029383866d443","check-docker-containers")'>
<span class=tab-nav-text>Check Docker Containers</span></button>
<button data-tab-item=docker-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("507a325fb68e263c52c029383866d443","docker-output")'>
<span class=tab-nav-text>Docker Output</span></button></div><div class=tab-content-container><div data-tab-item=check-docker-containers class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images</span></span></code></pre></div></div></div><div data-tab-item=docker-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>splunk@show-no-config-i-027057abec7c0c6d3:~/spring-petclinic-microservices$ docker images
</span></span><span class=line><span class=cl>REPOSITORY                                          TAG       IMAGE ID       CREATED              SIZE
</span></span><span class=line><span class=cl>quay.io/phagen/spring-petclinic-api-gateway         latest    f954254824ed   7 seconds ago        510MB
</span></span><span class=line><span class=cl>&lt;none&gt;                                              &lt;none&gt;    5dbbb7d1fbb2   9 seconds ago        563MB
</span></span><span class=line><span class=cl>quay.io/phagen/spring-petclinic-discovery-server    latest    0761e73d679d   26 seconds ago       500MB
</span></span><span class=line><span class=cl>&lt;none&gt;                                              &lt;none&gt;    d71dc0ff96f4   28 seconds ago       544MB
</span></span><span class=line><span class=cl>quay.io/phagen/spring-petclinic-config-server       latest    81a0ab6495c2   39 seconds ago       488MB
</span></span><span class=line><span class=cl>&lt;none&gt;                                              &lt;none&gt;    69d60a035bb9   40 seconds ago       519MB
</span></span><span class=line><span class=cl>quay.io/phagen/spring-petclinic-visits-service      latest    ca306495bf11   50 seconds ago       526MB
</span></span><span class=line><span class=cl>&lt;none&gt;                                              &lt;none&gt;    b60155eb8ab4   52 seconds ago       596MB
</span></span><span class=line><span class=cl>quay.io/phagen/spring-petclinic-vets-service        latest    29f1b1909b8b   About a minute ago   527MB
</span></span><span class=line><span class=cl>&lt;none&gt;                                              &lt;none&gt;    b07e8de54c99   About a minute ago   598MB
</span></span><span class=line><span class=cl>quay.io/phagen/spring-petclinic-customers-service   latest    5b21e448c91e   About a minute ago   526MB
</span></span><span class=line><span class=cl>&lt;none&gt;                                              &lt;none&gt;    722fa001614c   About a minute ago   596MB
</span></span><span class=line><span class=cl>quay.io/phagen/spring-petclinic-admin-server        latest    4a1906a91210   About a minute ago   498MB
</span></span><span class=line><span class=cl>&lt;none&gt;                                              &lt;none&gt;    96f61c7bb66a   About a minute ago   540MB
</span></span><span class=line><span class=cl>eclipse-temurin                                     17        807dd649ff14   13 days ago          407MB</span></span></code></pre></div></div></div></div></div><p>To test the application you need to obtain the public IP address of the instance you are running on. You can do this by running the following command:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl ifconfig.me</span></span></code></pre></div><p>You will see an IP address returned, make a note of this as we will need it to validate that the application is running.</p><p>We also need to obtain the <code>INSTANCE</code> environment variable value, as this is what is being used as the <code>otel.service.name</code> attribute. You can do this by running the following command:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$INSTANCE</span></span></span></code></pre></div><p>Also, make a note of this value as we will need it to filter the data in the UI.</p><p>You can now run the application with the following command. Notice that we are passing the <code>mysql</code> profile to the application, this will tell the application to use the MySQL database we started earlier. We are also setting the <code>otel.service.name</code> to a logical service name that will also be used in the UI for filtering:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p>You can validate if the application is running by visiting <code>http://&lt;IP_ADDRESS>:8083</code> (replace <code>&lt;IP_ADDRESS></code> with the IP address you obtained earlier). You should see the PetClinic application running.</p><h2 id=2-alwayson-profiling-and-metrics>2. AlwaysOn Profiling and Metrics</h2><p>When we installed the collector we configured it to enable <strong>AlwaysOn Profiling</strong> and <strong>Metrics</strong>. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.</p><p>When you start the PetClinic application you will see the collector automatically detect the application and instrument it for traces and profiling.</p><div class=tab-panel data-tab-group=ac363295fc84024eb75df71b5c09f83e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("ac363295fc84024eb75df71b5c09f83e","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS: -javaagent:/usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar -Dsplunk.profiler.enabled=true -Dsplunk.profiler.memory.enabled=true
</span></span><span class=line><span class=cl>OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:04:661 +0100] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: splunk-1.25.0-otel-1.27.0
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:05:294 +0100] [main] INFO com.splunk.javaagent.shaded.io.micrometer.core.instrument.push.PushMeterRegistry - publishing metrics for SignalFxMeterRegistry every 30s
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:043 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:044 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - Profiler configuration:
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:047 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                  splunk.profiler.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:048 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                splunk.profiler.directory : /tmp
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:049 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -       splunk.profiler.recording.duration : 20s
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:050 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -               splunk.profiler.keep-files : false
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:051 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -            splunk.profiler.logs-endpoint : null
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:053 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -              otel.exporter.otlp.endpoint : null
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:054 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -           splunk.profiler.memory.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:055 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -             splunk.profiler.tlab.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:056 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -        splunk.profiler.memory.event.rate : 150/s
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:057 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.call.stack.interval : PT10S
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:058 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -  splunk.profiler.include.internal.stacks : false
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:059 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.tracing.stacks.only : false
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:059 +0100] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2023-06-26 13:32:07:060 +0100] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.</span></span></code></pre></div></div></div></div></div><h2 id=3-review-profiling-data-collection>3. Review Profiling Data Collection</h2><p>You can now visit the Splunk APM UI and examine the application components, traces, profiling, DB Query performance and metrics. From the left-hand menu <strong>APM</strong> → <strong>Explore</strong>, click the environment dropdown and select your environment e.g. <code>&lt;INSTANCE>-petclinic</code> (where<code>&lt;INSTANCE></code> is replaced with the value you noted down earlier).</p><p><a href=#R-image-c2a7717e8310120350827f078945cfe8 class=lightbox-link><img src=../../../en/other/wip/pet-clinic/10-preparation/../images/apm-environment.png alt="APM Environment" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c2a7717e8310120350827f078945cfe8><img src=../../../en/other/wip/pet-clinic/10-preparation/../images/apm-environment.png alt="APM Environment" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Once your validation is complete you can stop the application by pressing <code>Ctrl-c</code>.</p><h2 id=4-adding-resource-attributes-to-spans>4. Adding Resource Attributes to Spans</h2><p>Resource attributes can be added to every reported span. For example <code>version=0.314</code>. A comma-separated list of resource attributes can also be defined e.g. <code>key1=val1,key2=val2</code>.</p><p>Let&rsquo;s launch the PetClinic again using new resource attributes. Note, that adding resource attributes to the run command will override what was defined when we installed the collector. Let&rsquo;s add two new resource attributes <code>deployment.environment=$INSTANCE-petclinic-env,version=0.314</code>:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p>Back in the Splunk APM UI we can drill down on a recent trace and see the new <code>version</code> attribute in a span.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=installing-the-opentelemetry-collector>Installing the OpenTelemetry Collector</h1><h2 id=1-introduction>1. Introduction</h2><p>The Splunk OpenTelemetry Collector is the core component of instrumenting infrastructure and applications. Its role is to collect and send:</p><ul><li>Infrastructure metrics (disk, CPU, memory, etc)</li><li>Application Performance Monitoring (APM) traces</li><li>Profiling data</li><li>Host and application logs</li></ul><p>Splunk Observability Cloud offers a wizard to walk you through the setup of the Collector on both your infrastructure and applications.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Delete any existing OpenTelemetry Collectors</div><div class=box-content><p>If you have completed a Splunk Observability workshop using this EC2 instance, please ensure you have deleted the collector running in Kubernetes before continuing. This can be done by running the following command:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></div><h2 id=2-confirm-environment-variables>2. Confirm environment variables</h2><p>To ensure your instance is configured correctly, we need to confirm that the required environment variables for this workshop are set correctly. In your terminal run the following command:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>env</span></span></code></pre></div><p>In the output check the following environment variables are present and have values set:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ACCESS_TOKEN
</span></span><span class=line><span class=cl>REALM
</span></span><span class=line><span class=cl>RUM_TOKEN
</span></span><span class=line><span class=cl>HEC_TOKEN
</span></span><span class=line><span class=cl>HEC_URL</span></span></code></pre></div><p>For this workshop, <strong>all</strong> of the above are required. If any are missing, please contact your instructor.</p><h2 id=3-install-the-opentelemetry-collector>3. Install the OpenTelemetry Collector</h2><p>We can then go ahead and install the Collector. Some additional parameters are passed to the install script, they are:</p><ul><li><code>--with-instrumentation</code> - This will install the agent from the Splunk distribution of OpenTelemetry Java, which is then loaded automatically when the PetClinic Java application starts up. No configuration is required!</li><li><code>--deployment-environment</code> - Sets the resource attribute <code>deployment.environment</code> to the value passed. This is used to filter views in the UI.</li><li><code>--enable-profiler</code> - Enables the profiler for the Java application. This will generate CPU profiles for the application.</li><li><code>--enable-profiler-memory</code> - Enables the profiler for the Java application. This will generate memory profiles for the application.</li><li><code>--enable-metrics</code> - Enables the exporting of Micrometer metrics</li><li><code>--hec-token</code> - Sets the HEC token for the collector to use</li><li><code>--hec-url</code> - Sets the HEC URL for the collector to use</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo sh /tmp/splunk-otel-collector.sh --realm <span class=nv>$REALM</span> -- <span class=nv>$ACCESS_TOKEN</span> --mode agent --without-fluentd --with-instrumentation --deployment-environment <span class=nv>$INSTANCE</span>-petclinic --enable-profiler --enable-profiler-memory --enable-metrics --hec-token <span class=nv>$HEC_TOKEN</span> --hec-url <span class=nv>$HEC_URL</span></span></span></code></pre></div><p>When prompted to restart services, select &lsquo;OK&rsquo; and press enter.</p><p>Next, we will patch the collector to expose the hostname of the instance and not the AWS instance ID. This will make it easier to filter data in the UI. Run the following command to patch the collector:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo sed -i <span class=s1>&#39;s/gcp, ecs, ec2, azure, system/system, gcp, ecs, ec2, azure/g&#39;</span> /etc/otel/collector/agent_config.yaml</span></span></code></pre></div><p>Once the <code>agent_config.yaml</code> has been patched, you will need to restart the collector:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart splunk-otel-collector</span></span></code></pre></div><p>Once the installation is completed, you can navigate to the <strong>Hosts with agent installed</strong> dashboard to see the data from your host, <strong>Dashboards → Hosts with agent installed</strong>.</p><p>Use the dashboard filter and select <code>host.name</code> and type or select the hostname of your workshop instance (you can get this from the command prompt in your terminal session). Once you see data flowing for your host, we are then ready to get started with the APM component.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=real-user-monitoring>Real User Monitoring</h1><h2 id=1-enable-rum>1. Enable RUM</h2><p>For the Real User Monitoring (RUM) instrumentation, we will add the Open Telemetry Javascript <a href=https://github.com/signalfx/splunk-otel-js-web target=_blank><strong>https://github.com/signalfx/splunk-otel-js-web</strong></a> snippet in the pages, we will use the wizard again <strong>Data Management → Add Integration → RUM Instrumentation → Browser Instrumentation</strong>.</p><p>Your instructor will inform you which token to use from the dropdown, click <strong>Next</strong>. Enter <strong>App name</strong> and <strong>Environment</strong> using the following syntax:</p><ul><li><code>&lt;INSTANCE>-petclinic-service</code> - replacing <code>&lt;INSTANCE></code> with the value you noted down earlier.</li><li><code>&lt;INSTANCE>-petclinic-env</code> - replacing <code>&lt;INSTANCE></code> with the value you noted down earlier.</li></ul><p>The wizard will then show a snippet of HTML code that needs to be placed at the top of the pages in the <code>&lt;head></code> section. The following is an example of the (do not use this snippet, use the one generated by the wizard):</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IMPORTANT: Replace the <span class=p>&lt;</span><span class=nt>version</span><span class=p>&gt;</span> placeholder in the src URL with a
</span></span><span class=line><span class=cl>version from https://github.com/signalfx/splunk-otel-js-web/releases
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*/
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>realm</span><span class=o>:</span> <span class=s2>&#34;eu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=s2>&#34;&lt;redacted&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>applicationName</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-env&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div><p>The Spring PetClinic application uses a single HTML page as the &ldquo;layout&rdquo; page, that is reused across all pages of the application. This is the perfect location to insert the Splunk RUM Instrumentation Library as it will be loaded in all pages automatically.</p><p>Let&rsquo;s then edit the layout page:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi src/main/resources/templates/fragments/layout.html</span></span></code></pre></div><p>Next, insert the snippet we generated above in the <code>&lt;head></code> section of the page. Make sure you don&rsquo;t include the comment and replace <code>&lt;version></code> in the source URL to <code>latest</code> e.g.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>th:fragment</span><span class=o>=</span><span class=s>&#34;layout (template, menu)&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>realm</span><span class=o>:</span> <span class=s2>&#34;eu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=s2>&#34;&lt;redacted&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>applicationName</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-env&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...</span></span></code></pre></div><h2 id=2-rebuild-petclinic>2. Rebuild PetClinic</h2><p>With the code changes complete, we need to rebuild the application and run it again. Run the <code>maven</code> command to compile/build/package PetClinic:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span>true</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p>Then let&rsquo;s visit the application using a browser to generate real-user traffic <code>http://&lt;IP_ADDRESS>:8083</code>.</p><p>In RUM, filter down into the environment as defined in the RUM snippet above and click through to the dashboard.</p><p>When you drill down into a RUM trace you will see a link to APM in the spans. Clicking on the trace ID will take you to the corresponding APM trace for the current RUM trace.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=log-observer>Log Observer</h1><h2 id=1-introduction>1. Introduction</h2><p>For the Splunk Log Observer component, we will configure the Spring PetClinic application to write logs to a file and configure the Splunk OpenTelemetry Collector to read (tail) that log file and send the logs to Splunk Cloud.</p><h2 id=2-opentelemetry-filelog-configuration>2. OpenTelemetry Filelog Configuration</h2><p>We need to configure the Splunk OpenTelemetry Collector to tail the Spring PetClinic log file and send the log data to Splunk Cloud.</p><p>The Splunk OpenTelemetry Collector uses <strong>Fluentd</strong> by default but we will change the configuration to use the OpenTelemetry <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/filelogreceiver/README.md target=_blank><strong>Filelog Receiver</strong></a> to consume the logs. We will need to edit the collectors&rsquo; configuration file:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/otel/collector/agent_config.yaml</span></span></code></pre></div><p>Under the <code>receivers:</code> section create the Filelog Receiver (make sure to indent correctly):</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>filelog</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>/tmp/spring-petclinic.log]</span></span></span></code></pre></div><p>Then under the <code>service:</code> section, find the <code>logs:</code> pipeline, replace <code>fluentforward</code> with<code>filelog</code> (again, make sure to indent correctly):</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>filelog, otlp]</span></span></span></code></pre></div><p>Save the file and exit the editor. Next, we need to validate that the HEC Token and HEC URL are configured for the collector to use. We will inspect the <code>/etc/otel/collector/splunk-otel-collector.conf</code> file:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo cat /etc/otel/collector/splunk-otel-collector.conf</span></span></code></pre></div><p>Make sure <code>SPLUNK_HEC_URL</code> and <code>SPLUNK_HEC_TOKEN</code> have values set. If they are not set, please reach out to your instructor. With the configuration change complete and validated, we can now restart the collector:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart splunk-otel-collector</span></span></code></pre></div><h2 id=3-logback-settings>3. Logback Settings</h2><p>The Spring PetClinic application can be configured to use several different Java logging libraries. In this scenario, we are going to use <code>logback</code>. We just need to create a file named <code>logback.xml</code> in the configuration folder:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi ~/spring-petclinic/src/main/resources/logback.xml</span></span></code></pre></div><p>Copy and paste the following XML content:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE xml&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>scan=</span><span class=s>&#34;true&#34;</span> <span class=na>scanPeriod=</span><span class=s>&#34;30 seconds&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;contextListener</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.classic.jul.LevelChangePropagator&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;resetJUL&gt;</span>true<span class=nt>&lt;/resetJUL&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/contextListener&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;logger</span> <span class=na>name=</span><span class=s>&#34;org.springframework.samples.petclinic&#34;</span> <span class=na>level=</span><span class=s>&#34;info&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;appender</span> <span class=na>name=</span><span class=s>&#34;file&#34;</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.core.rolling.RollingFileAppender&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;file&gt;</span>/tmp/spring-petclinic.log<span class=nt>&lt;/file&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;rollingPolicy</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;fileNamePattern&gt;</span>springLogFile.%d{yyyy-MM-dd}.log<span class=nt>&lt;/fileNamePattern&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;maxHistory&gt;</span>5<span class=nt>&lt;/maxHistory&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;totalSizeCap&gt;</span>1GB<span class=nt>&lt;/totalSizeCap&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/rollingPolicy&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;encoder&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;pattern&gt;</span>
</span></span><span class=line><span class=cl>        %d{yyyy-MM-dd HH:mm:ss} - %logger{36} - %msg trace_id=%X{trace_id} span_id=%X{span_id} trace_flags=%X{trace_flags} %n service.name=%property{otel.resource.service.name}, deployment.environment=%property{otel.resource.deployment.environment}: %m%n
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/encoder&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/appender&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;root</span> <span class=na>level=</span><span class=s>&#34;info&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;appender-ref</span> <span class=na>ref=</span><span class=s>&#34;file&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/root&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span></span></span></code></pre></div><p>Now we need to rebuild the application and run it again:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span>true</span></span></code></pre></div><p>Once the rebuild has been completed we can then run the application again:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><h2 id=4-view-logs>4. View Logs</h2><p>From the left-hand menu click on <strong>Log Observer</strong> and ensure <strong>Index</strong> is set to <strong>splunk4rookies-workshop</strong>.</p><p>Next, click <strong>Add Filter</strong> search for the field <code>service_name</code> select the value <code>&lt;INSTANCE>-petclinic-service</code> and click <code>=</code> (include). You should now see only the log messages from your PetClinic application.</p><p><a href=#R-image-496c2363356ebe523aa5eeff1d41073a class=lightbox-link><img src=../../../en/other/wip/pet-clinic/40-log-observer-connect/../images/log-observer.png alt="Log Observer" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-496c2363356ebe523aa5eeff1d41073a><img src=../../../en/other/wip/pet-clinic/40-log-observer-connect/../images/log-observer.png alt="Log Observer" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><h2 id=4-summary>4. Summary</h2><p>This is the end of the workshop and we have certainly covered a lot of ground. At this point, you should have metrics, traces (APM & RUM), logs, database query performance and code profiling being reported into Splunk Observability Cloud.</p><p><strong>Congratulations!</strong></p><footer class=footline></footer></article></section></section></div></main></div><script src=../../../js/clipboard.min.js?1702664724 defer></script>
<script src=../../../js/perfect-scrollbar.min.js?1702664724 defer></script>
<script src=../../../js/theme.js?1702664724 defer></script></body></html>