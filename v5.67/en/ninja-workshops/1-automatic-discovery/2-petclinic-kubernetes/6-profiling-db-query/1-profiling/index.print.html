<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.125.5"><meta name=generator content="Relearn 6.4.0+tip"><meta name=description content="When we installed the Splunk Distribution of the OpenTelemetry Collector using the Helm chart earlier, we configured it to enable AlwaysOn Profiling and Metrics. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.
When you deploy the PetClinic application and set the annotation, the collector automatically detects the application and instruments it for traces and profiling. We can verify this by examining the startup logs of one of the Java containers we are instrumenting by running the following script:"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Always-On Profiling & Metrics :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="When we installed the Splunk Distribution of the OpenTelemetry Collector using the Helm chart earlier, we configured it to enable AlwaysOn Profiling and Metrics. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.
When you deploy the PetClinic application and set the annotation, the collector automatically detects the application and instruments it for traces and profiling. We can verify this by examining the startup logs of one of the Java containers we are instrumenting by running the following script:"><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.67/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/1-profiling/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Always-On Profiling & Metrics :: Splunk Observability Cloud Workshops"><meta property="og:description" content="When we installed the Splunk Distribution of the OpenTelemetry Collector using the Helm chart earlier, we configured it to enable AlwaysOn Profiling and Metrics. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.
When you deploy the PetClinic application and set the annotation, the collector automatically detects the application and instruments it for traces and profiling. We can verify this by examining the startup logs of one of the Java containers we are instrumenting by running the following script:"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="Ninja Workshops"><meta property="article:modified_time" content="2024-09-19T16:47:03+01:00"><meta itemprop=name content="Always-On Profiling & Metrics :: Splunk Observability Cloud Workshops"><meta itemprop=description content="When we installed the Splunk Distribution of the OpenTelemetry Collector using the Helm chart earlier, we configured it to enable AlwaysOn Profiling and Metrics. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.
When you deploy the PetClinic application and set the annotation, the collector automatically detects the application and instruments it for traces and profiling. We can verify this by examining the startup logs of one of the Java containers we are instrumenting by running the following script:"><meta itemprop=dateModified content="2024-09-19T16:47:03+01:00"><meta itemprop=wordCount content="583"><title>Always-On Profiling & Metrics :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.67/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/1-profiling/index.html rel=canonical type=text/html title="Always-On Profiling & Metrics :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.67/images/favicon.ico?1726779098 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.67/css/fontawesome-all.min.css?1726779098 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.67/css/fontawesome-all.min.css?1726779098 rel=stylesheet></noscript><link href=/observability-workshop/v5.67/css/nucleus.css?1726779098 rel=stylesheet><link href=/observability-workshop/v5.67/css/auto-complete.css?1726779098 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.67/css/auto-complete.css?1726779098 rel=stylesheet></noscript><link href=/observability-workshop/v5.67/css/perfect-scrollbar.min.css?1726779098 rel=stylesheet><link href=/observability-workshop/v5.67/css/fonts.css?1726779098 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.67/css/fonts.css?1726779098 rel=stylesheet></noscript><link href=/observability-workshop/v5.67/css/theme.css?1726779098 rel=stylesheet><link href=/observability-workshop/v5.67/css/theme-splunk-light.css?1726779098 rel=stylesheet id=R-variant-style><link href=/observability-workshop/v5.67/css/chroma-relearn-light.css?1726779098 rel=stylesheet id=R-variant-chroma-style><link href=/observability-workshop/v5.67/css/variant.css?1726779098 rel=stylesheet><link href=/observability-workshop/v5.67/css/print.css?1726779098 rel=stylesheet media=print><link href=/observability-workshop/v5.67/css/format-print.css?1726779098 rel=stylesheet><script src=/observability-workshop/v5.67/js/variant.js?1726779098></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../../../..",window.relearn.relBaseUri="../../../../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.67",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.index_js_url="/observability-workshop/v5.67/en/index.search.js?1726779098",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v5.67/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/1-profiling/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.67/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.67/en/ninja-workshops/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.67/en/ninja-workshops/1-automatic-discovery/index.html><span itemprop=name>Automatic Discovery Workshops</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.67/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/index.html><span itemprop=name>PetClinic Kubernetes Workshop</span></a><meta itemprop=position content="4">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.67/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/index.html><span itemprop=name>6. Advanced Features</span></a><meta itemprop=position content="5">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>1. Always-On Profiling</span><meta itemprop=position content="6"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.67/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/index.html title="Always-On Profiling & DB Query Performance (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.67/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/2-waterfall/index.html title="Always-On Profiling in the Trace Waterfall (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=always-on-profiling--metrics>Always-On Profiling & Metrics</h1><p>When we installed the Splunk Distribution of the OpenTelemetry Collector using the Helm chart earlier, we configured it to enable <strong>AlwaysOn Profiling</strong> and <strong>Metrics</strong>. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.</p><p>When you deploy the PetClinic application and set the annotation, the collector automatically detects the application and instruments it for traces and profiling. We can verify this by examining the startup logs of one of the Java containers we are instrumenting by running the following script:</p><p>The logs should show what flags were picked up by the Java automatic discovery and configuration:</p><p><div class=tab-panel data-tab-group=db4742e7c93ee2735581e2f7a11007ef><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=run-the-script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("db4742e7c93ee2735581e2f7a11007ef","run-the-script")'>
<span class=tab-nav-text>Run the script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("db4742e7c93ee2735581e2f7a11007ef","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=run-the-script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code class=language-logs data-lang=logs>.  ~/workshop/petclinic/scripts/get_logs.sh</code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2024/02/15 09:42:00 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:01 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:02 Connected to tcp://discovery-server:8761
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS:  -javaagent:/otel-auto-instrumentation-java/javaagent.jar
</span></span><span class=line><span class=cl>Picked up _JAVA_OPTIONS: -Dspring.profiles.active=docker,mysql -Dsplunk.profiler.call.stack.interval=150
</span></span><span class=line><span class=cl>OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:056 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: splunk-1.30.1-otel-1.32.1
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:768 +0000] [main] INFO com.splunk.javaagent.shaded.io.micrometer.core.instrument.push.PushMeterRegistry - publishing metrics for SignalFxMeterRegistry every 30s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - Profiler configuration:
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:480 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                  splunk.profiler.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                splunk.profiler.directory : /tmp
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -       splunk.profiler.recording.duration : 20s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:506 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -               splunk.profiler.keep-files : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:510 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -            splunk.profiler.logs-endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -              otel.exporter.otlp.endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -           splunk.profiler.memory.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:515 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -             splunk.profiler.tlab.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -        splunk.profiler.memory.event.rate : 150/s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.call.stack.interval : PT0.15S
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -  splunk.profiler.include.internal.stacks : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.tracing.stacks.only : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:518 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.</span></span></code></pre></div></div></div></div></div>We are interested in the section written by the <code>com.splunk.opentelemetry.profiler.ConfigurationLogger</code> or the <strong>Profiling Configuration</strong>.</p><p>We can see the various settings you can control, some that are useful depending on your use case like the <code>splunk.profiler.directory</code> - The location where the agent writes the call stacks before sending them to Splunk. This may be different depending on how you configure your containers.</p><p>Another parameter you may want to change is <code>splunk.profiler.call.stack.interval</code> This is how often the system takes a CPU Stack trace. You may want to reduce this if you have short spans like we have in our application. (we kept the default as the spans in this demo application are extremely short, so Span may not always have a CPU Call Stack related to it.)</p><p>You can find how to set these parameters <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/java/configuration/advanced-java-otel-configuration.html#profiling-configuration-java rel=external target=_blank>here</a>. Below, is how you set a higher collection rate for call stack in your <code>deployment.yaml</code>, exactly how to pass any JAVA option to the Java application running in your container:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>JAVA_OPTIONS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xdebug -Dsplunk.profiler.call.stack.interval=150&#34;</span></span></span></code></pre></div><p>If you don&rsquo;t see those lines as a result of the script, the startup may have taken too long and generated too many connection errors, try looking at the logs directly with <code>kubectl</code> or the <code>k9s</code> utility that is installed.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article></div></main></div><script src=/observability-workshop/v5.67/js/clipboard.min.js?1726779098 defer></script><script src=/observability-workshop/v5.67/js/perfect-scrollbar.min.js?1726779098 defer></script><script src=/observability-workshop/v5.67/js/theme.js?1726779098 defer></script></body></html>