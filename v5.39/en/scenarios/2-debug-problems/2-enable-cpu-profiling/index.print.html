<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta name=generator content="Relearn 5.23.2+tip"><meta name=description content="Splunk Observability Workshops"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Enable CPU Profiling :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="Let&rsquo;s learn how to enable the CPU profiler, verify its operation, and use the results in Splunk Observability Cloud to find out why our application sometimes runs slowly.
Update the application configuration We will need to pass an additional configuration argument to the Splunk OpenTelemetry Java agent in order to enable the profiler. The configuration is documented here in detail, but for now we just need one single setting:
SPLUNK_PROFILER_ENABLED=&#34;true&#34;"><meta property="og:title" content="Enable CPU Profiling :: Splunk Observability Cloud Workshops"><meta property="og:description" content="Let&rsquo;s learn how to enable the CPU profiler, verify its operation, and use the results in Splunk Observability Cloud to find out why our application sometimes runs slowly.
Update the application configuration We will need to pass an additional configuration argument to the Splunk OpenTelemetry Java agent in order to enable the profiler. The configuration is documented here in detail, but for now we just need one single setting:
SPLUNK_PROFILER_ENABLED=&#34;true&#34;"><meta property="og:type" content="article"><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.39/en/scenarios/2-debug-problems/2-enable-cpu-profiling/index.html"><meta property="article:section" content="Debug Problems :: Splunk Observability Cloud Workshops"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><title>Enable CPU Profiling :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v5.39/en/scenarios/2-debug-problems/2-enable-cpu-profiling/index.html rel=canonical type=text/html title="Enable CPU Profiling :: Splunk Observability Cloud Workshops"><link href=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/index.xml rel=alternate type=application/rss+xml title="Enable CPU Profiling :: Splunk Observability Cloud Workshops"><link href=../../../../images/favicon.ico?1707220482 rel=icon type=image/x-icon sizes=any><link href=../../../../css/fontawesome-all.min.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fontawesome-all.min.css?1707220489 rel=stylesheet></noscript><link href=../../../../css/nucleus.css?1707220489 rel=stylesheet><link href=../../../../css/auto-complete.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/auto-complete.css?1707220489 rel=stylesheet></noscript><link href=../../../../css/perfect-scrollbar.min.css?1707220489 rel=stylesheet><link href=../../../../css/fonts.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fonts.css?1707220489 rel=stylesheet></noscript><link href=../../../../css/theme.css?1707220489 rel=stylesheet><link href=../../../../css/theme-splunk-light.css?1707220489 rel=stylesheet id=R-variant-style><link href=../../../../css/variant.css?1707220489 rel=stylesheet><link href=../../../../css/print.css?1707220489 rel=stylesheet media=print><link href=../../../../css/format-print.css?1707220489 rel=stylesheet><link href=../../../../css/ie.css?1707220489 rel=stylesheet><script src=../../../../js/url.js?1707220489></script>
<script src=../../../../js/variant.js?1707220489></script>
<script>window.index_js_url="../../../../en/index.search.js";var root_url="../../../../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://splunk.github.io/observability-workshop/v5.39/",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script>
<script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script>
<script>SplunkRum.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rum",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g",app:"observability-workshop",version:"1",environment:"observability-workshop-env"}),SplunkSessionRecorder.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rumreplay",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g"})</script><style>@media screen and (min-width:1000px){#R-body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1400px;width:100%}}:root{--MENU-WIDTH-L:22.5rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)">
<i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/scenarios/index.html><span itemprop=name>Scenarios</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/scenarios/2-debug-problems/index.html><span itemprop=name>Debug Problems</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Enable CPU Profiling</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=enable-cpu-profiling>Enable CPU Profiling</h1><p>Let&rsquo;s learn how to enable the CPU profiler, verify its operation,
and use the results in Splunk Observability Cloud to find out why our application sometimes runs slowly.</p><h3 id=update-the-application-configuration>Update the application configuration</h3><p>We will need to pass an additional configuration argument to the Splunk OpenTelemetry Java agent in order to
enable the profiler. The configuration is <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/java/instrumentation/instrument-java-application.html#activate-alwayson-profiling target=_blank>documented here</a>
in detail, but for now we just need one single setting:</p><p><code>SPLUNK_PROFILER_ENABLED="true"</code></p><p>Since our application is deployed in Kubernetes, we can update the Kubernetes manifest file to set this environment variable. Open the <code>doorgame/doorgame.yaml</code> file for editing, and ensure the value of the <code>SPLUNK_PROFILER_ENABLED</code> environment variable is set to &ldquo;true&rdquo;:</p><div class="wrap-code highlight"><pre tabindex=0><code>- name: SPLUNK_PROFILER_ENABLED
  value: &#34;true&#34;</code></pre></div><p>Next, let&rsquo;s redeploy the Door Game application by running the following command:</p><div class="wrap-code highlight"><pre tabindex=0><code>cd workshop/profiling
./4-redeploy-doorgame.sh</code></pre></div><p>After a few minutes, a new pod will be deployed with the updated application settings.</p><h3 id=confirm-operation>Confirm operation</h3><p>To ensure the profiler is enabled, let&rsquo;s review the application logs with the following commands:</p><div class="wrap-code highlight"><pre tabindex=0><code>kubectl logs -l app=doorgame --tail=100 | grep JfrActivator</code></pre></div><p>You should see a line in the application log output that shows the profiler is active:</p><div class="wrap-code highlight"><pre tabindex=0><code>[otel.javaagent 2024-02-05 19:01:12:416 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.```</code></pre></div><p>This confirms that the profiler is enabled and sending data to the OpenTelemetry collector deployed in our Kubernetes cluster, which in turn sends profiling data to Splunk Observability Cloud.</p><h3 id=profiling-in-apm>Profiling in APM</h3><p>Visit <code>http://&lt;your IP address>:81</code> and play a few more rounds of The Door Game.</p><p>Then head on over to Splunk Observability Cloud, click on APM,
and click on the <code>doorgame</code> service at the bottom of the screen.</p><p>In the rightmost column you should see the &ldquo;AlwaysOn Profiling&rdquo;
card that looks similar to this:</p><p><a href=#R-image-aafa86b0445a6e16bd895f87b9a9194f class=lightbox-link><img src=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/always-on-profiling.png alt="AlwaysOn Profiling" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-aafa86b0445a6e16bd895f87b9a9194f><img src=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/always-on-profiling.png alt="AlwaysOn Profiling" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Click the card title to go to the AlwaysOn Profiling view. It will look something
like this:</p><p><a href=#R-image-43250c6d80c1809fc90c03a64eca1043 class=lightbox-link><img src=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/flamegraph_and_table.png alt="Flamegraph and table" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-43250c6d80c1809fc90c03a64eca1043><img src=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/flamegraph_and_table.png alt="Flamegraph and table" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>By default, we show both the table and <a href=https://www.brendangregg.com/flamegraphs.html target=_blank>flamegraph</a>.
Take some time to explore this view by doing some of the following:</p><ul><li>toggle between flamegraph and table views</li><li>click a table item and notice the change in flamegraph</li><li>navigate the flamegraph by clicking on a stack frame to zoom in, and a parent frame to zoom out</li><li>add a search term like <code>splunk</code> or <code>jetty</code> to highlight some matching stack frames</li></ul><p>We should note that the sample app is greatly underutilized and most of the time
is spent waiting for user input and service requests. As a result, the flame graph
should be somewhat less interesting than a high-volume, real-world production service.</p><h3 id=traces-with-call-stacks>Traces with Call Stacks</h3><p>Now that we&rsquo;ve seen the profiling view, let&rsquo;s go back to the trace list view. We want to find a
trace that was long enough so that we increase the chance of having sampled call stacks.
If you haven&rsquo;t already, you should play The Door Game enough to stick with door 3
(either by choosing it initially and staying, or choosing another door and switching when given the chance).
You&rsquo;ll notice that it&rsquo;s slow, and it should show up at around 5s in the trace list view:</p><p><a href=#R-image-84c5fb1c30da069660e4aacbc31f4b98 class=lightbox-link><img src=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/slow_trace.png alt="Slow Trace" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-84c5fb1c30da069660e4aacbc31f4b98><img src=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/slow_trace.png alt="Slow Trace" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Identify the slow trace in the trace list view and click it to view the
individual trace. In the single trace view, you should see that the innermost span
<code>DoorGame.getOutcome</code> is responsible for the entire slow duration of the span.
There should be 2 call stacks sampled during the execution of that span.</p><p><a href=#R-image-bbed99edcbac5285b64620a5008cc69e class=lightbox-link><img src=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/span_with_stacks.png alt="Span with Stacks" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bbed99edcbac5285b64620a5008cc69e><img src=../../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/span_with_stacks.png alt="Span with Stacks" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>If you&rsquo;re up for the challenge, expand the span and explore the Java stack frames on your own
before we tackle it in the next section.</p><h2 id=what-did-we-accomplish>What did we accomplish?</h2><p>We&rsquo;ve come a long way already!</p><ul><li>We learned how to enable the profiler in the Splunk OpenTelemetry Java instrumentation agent.</li><li>We learned how to verify in the agent output that the profiler is enabled.</li><li>We have explored several profiling related workflows in APM:<ul><li>How to navigate to AlwaysOn Profiling from the troubleshooting view</li><li>How to explore the flamegraph and method call duration table through navigation and filtering</li><li>How to identify when a span has sampled call stacks associated with it</li></ul></li></ul><p>In the next section, we&rsquo;ll explore the profiling data further to determine what&rsquo;s causing the slowness, and then apply a fix to our application to resolve the issue.</p><footer class=footline></footer></article></div></main></div><script src=../../../../js/clipboard.min.js?1707220491 defer></script>
<script src=../../../../js/perfect-scrollbar.min.js?1707220491 defer></script>
<script src=../../../../js/theme.js?1707220491 defer></script></body></html>