<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta name=generator content="Relearn 5.23.2+tip"><meta name=description content="Splunk Observability Workshops"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Find and Fix Application Slowness :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="In this section, we pick up where we left off last time. We will use the profiling tool to explore our slow span and link it back to the source code that caused the slowness. We will update the code to improve the performance of this span, and we will use the APM profiling tools to verify that our change is successful.
Exploring the Span At the end of the previous section, we have identified a span that was taking more than 5 seconds to complete."><meta property="og:title" content="Find and Fix Application Slowness :: Splunk Observability Cloud Workshops"><meta property="og:description" content="In this section, we pick up where we left off last time. We will use the profiling tool to explore our slow span and link it back to the source code that caused the slowness. We will update the code to improve the performance of this span, and we will use the APM profiling tools to verify that our change is successful.
Exploring the Span At the end of the previous section, we have identified a span that was taking more than 5 seconds to complete."><meta property="og:type" content="article"><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.39/en/scenarios/2-debug-problems/3-find-and-fix-slowness/index.html"><meta property="article:section" content="Debug Problems :: Splunk Observability Cloud Workshops"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><title>Find and Fix Application Slowness :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v5.39/en/scenarios/2-debug-problems/3-find-and-fix-slowness/index.html rel=canonical type=text/html title="Find and Fix Application Slowness :: Splunk Observability Cloud Workshops"><link href=../../../../en/scenarios/2-debug-problems/3-find-and-fix-slowness/index.xml rel=alternate type=application/rss+xml title="Find and Fix Application Slowness :: Splunk Observability Cloud Workshops"><link href=../../../../images/favicon.ico?1707220482 rel=icon type=image/x-icon sizes=any><link href=../../../../css/fontawesome-all.min.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fontawesome-all.min.css?1707220489 rel=stylesheet></noscript><link href=../../../../css/nucleus.css?1707220489 rel=stylesheet><link href=../../../../css/auto-complete.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/auto-complete.css?1707220489 rel=stylesheet></noscript><link href=../../../../css/perfect-scrollbar.min.css?1707220489 rel=stylesheet><link href=../../../../css/fonts.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fonts.css?1707220489 rel=stylesheet></noscript><link href=../../../../css/theme.css?1707220489 rel=stylesheet><link href=../../../../css/theme-splunk-light.css?1707220489 rel=stylesheet id=R-variant-style><link href=../../../../css/variant.css?1707220489 rel=stylesheet><link href=../../../../css/print.css?1707220489 rel=stylesheet media=print><link href=../../../../css/format-print.css?1707220489 rel=stylesheet><link href=../../../../css/ie.css?1707220489 rel=stylesheet><script src=../../../../js/url.js?1707220489></script>
<script src=../../../../js/variant.js?1707220489></script>
<script>window.index_js_url="../../../../en/index.search.js";var root_url="../../../../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://splunk.github.io/observability-workshop/v5.39/",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script>
<script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script>
<script>SplunkRum.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rum",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g",app:"observability-workshop",version:"1",environment:"observability-workshop-env"}),SplunkSessionRecorder.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rumreplay",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g"})</script><style>@media screen and (min-width:1000px){#R-body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1400px;width:100%}}:root{--MENU-WIDTH-L:22.5rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../../en/scenarios/2-debug-problems/3-find-and-fix-slowness/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)">
<i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/scenarios/index.html><span itemprop=name>Scenarios</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/scenarios/2-debug-problems/index.html><span itemprop=name>Debug Problems</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Find and Fix Application Slowness</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=find-and-fix-application-slowness>Find and Fix Application Slowness</h1><p>In this section, we pick up where we left off last time.
We will use the profiling tool to explore our slow span and link it
back to the source code that caused the slowness. We will update the code to improve
the performance of this span, and we will use the APM profiling tools to verify
that our change is successful.</p><h3 id=exploring-the-span>Exploring the Span</h3><p>At the end of the previous section, we have identified a span that was taking more
than 5 seconds to complete. We observed that the span showed that it was linked
to 2 or more sampled call stacks. Let&rsquo;s proceed by clicking on the span to expand its details.</p><p><a href=#R-image-e4890502e469221fefa4ff8888bfa5ab class=lightbox-link><img src=../../../../en/scenarios/2-debug-problems/3-find-and-fix-slowness/../images/view_stack_on_span.png alt="View Stack on Span" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e4890502e469221fefa4ff8888bfa5ab><img src=../../../../en/scenarios/2-debug-problems/3-find-and-fix-slowness/../images/view_stack_on_span.png alt="View Stack on Span" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>When a span does not have CPU call stack data, we would normally just see the span details.
(you can drill into the parent stack to see this in action). When we expand the child span, however,
we have the option to see &ldquo;CPU Call Stack&rdquo; data as well.</p><p>At the bottom of the call stack, we can see that the thread was busy sleeping:</p><div class="wrap-code highlight"><pre tabindex=0><code>com.splunk.profiling.workshop.ServiceMain$$Lambda$.handle(Unknown Source:0)
com.splunk.profiling.workshop.ServiceMain.lambda$main$(ServiceMain.java:34)
com.splunk.profiling.workshop.DoorGame.getOutcome(DoorGame.java:41)
com.splunk.profiling.workshop.DoorChecker.isWinner(DoorChecker.java:14)
com.splunk.profiling.workshop.DoorChecker.checkDoorTwo(DoorChecker.java:30)
com.splunk.profiling.workshop.DoorChecker.precheck(DoorChecker.java:36)
com.splunk.profiling.workshop.Util.sleep(Util.java:9)
java.util.concurrent.TimeUnit.sleep(Unknown Source:0)
java.lang.Thread.sleep(Unknown Source:0)
java.lang.Thread.sleep(Native Method:0)</code></pre></div><p>The call stack tells us a story &ndash; reading from the bottom up, it lets us describe
what is happening inside the service code. A developer, even one unfamiliar with the
source code, should be able to look at this call stack to craft a narrative like:</p><blockquote><p>We are getting the outcome of a game. We leverage the DoorChecker to
see if something is the winner, but the check for door two somehow issues
a precheck() that, for some reason, is deciding to sleep for a long time.</p></blockquote><p>Our workshop application is left intentionally simple &ndash; a real-world service might see the
thread being sampled during a database call or calling into an un-traced external service.
It is also possible that a slow span is executing a complicated business process,
in which case maybe none of the stack traces relate to each other at all.</p><p>The longer a method or process is, the greater chance we will have call stacks
sampled during its execution.</p><h3 id=lets-fix-that-bug>Let&rsquo;s Fix That Bug</h3><p>By using the profiling tool, we were able to determine that our application is slow
when issuing the <code>DoorChecker.precheck()</code> method from inside <code>DoorChecker.checkDoorTwo()</code>.
Let&rsquo;s open the <code>doorgame/src/main/java/com/splunk/profiling/workshop/DoorChecker.java</code> source file in our editor.</p><p>By quickly glancing through the file, we see that there are methods for checking
each door, and all of them call <code>precheck()</code>. In a real service, we might be uncomfortable
simply removing the <code>precheck()</code> call because there could be unseen/unaccounted side
effects.</p><p>Down on line 29 we see the following:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>checkDoorTwo</span><span class=o>(</span><span class=n>GameInfo</span> <span class=n>gameInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>precheck</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gameInfo</span><span class=o>.</span><span class=na>isWinner</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>precheck</span><span class=o>(</span><span class=kt>int</span> <span class=n>doorNum</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>extra</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span><span class=n>Math</span><span class=o>.</span><span class=na>pow</span><span class=o>(</span><span class=mi>70</span><span class=o>,</span> <span class=n>doorNum</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=o>(</span><span class=mi>300</span> <span class=o>+</span> <span class=n>extra</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span></span></span></code></pre></div><p>With our developer hat on, we notice that the door number is zero based, so
the first door is 0, the second is 1, and the 3rd is 2 (this is conventional).
The <code>extra</code> value is used as extra/additional sleep time, and it is computed by taking
<code>70^doorNum</code> (<code>Math.pow</code> performs an exponent calculation). That&rsquo;s odd, because this means:</p><ul><li>door 0 => 70^0 => 1ms</li><li>door 1 => 70^1 => 70ms</li><li>door 2 => 70^2 => 4900ms</li></ul><p>We&rsquo;ve found the root cause of our slow bug! This also explains why the first two doors
weren&rsquo;t ever very slow.</p><p>We have a quick chat with our product manager and team lead, and we agree that the <code>precheck()</code>
method must stay but that the extra padding isn&rsquo;t required. Let&rsquo;s remove the <code>extra</code> variable
and make <code>precheck</code> now read like this:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>precheck</span><span class=o>(</span><span class=kt>int</span> <span class=n>doorNum</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=o>(</span><span class=mi>300</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span></span></span></code></pre></div><p>Now all doors will have a consistent behavior. Save your work and then rebuild and redeploy the application using the following command:</p><div class="wrap-code highlight"><pre tabindex=0><code>cd workshop/profiling
./4-redeploy-doorgame.sh</code></pre></div><p>Once the application has been redeployed successfully, visit The Door Game again to confirm that your fix is in place:
<code>http://&lt;your IP address>:81</code></p><h2 id=what-did-we-accomplish>What did we accomplish?</h2><ul><li>We learned how to view a series of call stacks captured during a Span.</li><li>We learned how the call stack can tell us a story and point us to suspect lines of code.</li><li>We identified the slow code and fixed it to make it faster.</li></ul><p>In the next section, we&rsquo;ll explore how to enable the memory profiling component of AlwaysOn Profiling, which can tell us which objects are consuming the most heap memory.</p><footer class=footline></footer></article></div></main></div><script src=../../../../js/clipboard.min.js?1707220491 defer></script>
<script src=../../../../js/perfect-scrollbar.min.js?1707220491 defer></script>
<script src=../../../../js/theme.js?1707220491 defer></script></body></html>