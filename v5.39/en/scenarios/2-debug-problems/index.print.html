<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta name=generator content="Relearn 5.23.2+tip"><meta name=description content="Splunk Observability Workshops"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Debug Problems :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="Splunk Observability Workshops"><meta property="og:title" content="Debug Problems :: Splunk Observability Cloud Workshops"><meta property="og:description" content="Splunk Observability Workshops"><meta property="og:type" content="website"><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.39/en/scenarios/2-debug-problems/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><title>Debug Problems :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v5.39/en/scenarios/2-debug-problems/index.html rel=canonical type=text/html title="Debug Problems :: Splunk Observability Cloud Workshops"><link href=../../../en/scenarios/2-debug-problems/index.xml rel=alternate type=application/rss+xml title="Debug Problems :: Splunk Observability Cloud Workshops"><link href=../../../images/favicon.ico?1707220482 rel=icon type=image/x-icon sizes=any><link href=../../../css/fontawesome-all.min.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/fontawesome-all.min.css?1707220489 rel=stylesheet></noscript><link href=../../../css/nucleus.css?1707220489 rel=stylesheet><link href=../../../css/auto-complete.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/auto-complete.css?1707220489 rel=stylesheet></noscript><link href=../../../css/perfect-scrollbar.min.css?1707220489 rel=stylesheet><link href=../../../css/fonts.css?1707220489 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../css/fonts.css?1707220489 rel=stylesheet></noscript><link href=../../../css/theme.css?1707220489 rel=stylesheet><link href=../../../css/theme-splunk-light.css?1707220489 rel=stylesheet id=R-variant-style><link href=../../../css/variant.css?1707220489 rel=stylesheet><link href=../../../css/print.css?1707220489 rel=stylesheet media=print><link href=../../../css/format-print.css?1707220489 rel=stylesheet><link href=../../../css/ie.css?1707220489 rel=stylesheet><script src=../../../js/url.js?1707220489></script>
<script src=../../../js/variant.js?1707220489></script>
<script>window.index_js_url="../../../en/index.search.js";var root_url="../../../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://splunk.github.io/observability-workshop/v5.39/",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script>
<script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script>
<script>SplunkRum.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rum",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g",app:"observability-workshop",version:"1",environment:"observability-workshop-env"}),SplunkSessionRecorder.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rumreplay",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g"})</script><style>@media screen and (min-width:1000px){#R-body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1400px;width:100%}}:root{--MENU-WIDTH-L:22.5rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../en/scenarios/2-debug-problems/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)">
<i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../en/scenarios/index.html><span itemprop=name>Scenarios</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Debug Problems</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 2</div><h1 id=debug-problems>Debug Problems</h1><p>Details TBD</p><p>Workshops :</p><ul><li><a href=https://splunk.github.io/observability-workshop/latest/en/s4r/index.html target=_blank>Splunk4rookies - Observability</a></li><li><a href=https://splunk.github.io/observability-workshop/latest/en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/ target=_blank>APM Auto instrumentation - Java Based</a>
or</li><li><a href=https://splunk.github.io/observability-workshop/latest/en/other/3-auto-instrumentation/2-nodejs/index.html target=_blank>APM Auto instrumentation -Node Based</a></li><li><a href=https://splunk.github.io/observability-workshop/latest//en/other/7-mttr-custom-tags/ target=_blank>Improve MTTR With Custom Tags - Java based</a></li></ul><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Debug Problems</h1><article class=default><header class=headline></header><h1 id=build-the-sample-application>Build the Sample Application</h1><span class="badge cstyle default badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content style=background-color:#ed0090>10 minutes</span></span><h2 id=introduction>Introduction</h2><p>For this workshop, we&rsquo;ll be using a Java-based application called <code>The Door Game</code>. It will be hosted in Kubernetes.</p><h2 id=pre-requisites>Pre-requisites</h2><p>You will start with an EC2 instance and perform some <a href=#initial-steps>initial steps</a> in order to get to the following state:</p><ul><li>Install Kubernetes (k3s) and Docker</li><li>Deploy the <strong>Splunk distribution of the OpenTelemetry Collector</strong></li><li>Build and deploy the <code>doorgame</code> application container</li></ul><h2 id=initial-steps>Initial Steps</h2><p>The initial setup can be completed by executing the following steps on the command line of your EC2 instance.</p><p>You&rsquo;ll be asked to enter a name for your environment. Please use <code>profiling-workshop-yourname</code> (where <code>yourname</code> is replaced by your actual name).</p><div class="wrap-code highlight"><pre tabindex=0><code>cd workshop/profiling

./1-docker-setup.sh

# Exit and ssh back to this instance

# return to the same directory as before 
cd workshop/profiling

# ensure Docker is running 
sudo systemctl start docker

./2-deploy-otel-collector.sh
./3-deploy-doorgame.sh</code></pre></div><h2 id=lets-play-the-door-game>Let&rsquo;s Play The Door Game!</h2><p>Now that the application is deployed, let&rsquo;s play with it and generate some observability data.</p><p>Get the external IP address for your application instance using the following command:</p><div class="wrap-code highlight"><pre tabindex=0><code>kubectl describe svc doorgame | grep &#34;LoadBalancer Ingress&#34;</code></pre></div><p>The output should look like the following:</p><div class="wrap-code highlight"><pre tabindex=0><code>LoadBalancer Ingress:     52.23.184.60</code></pre></div><p>You should be able to access The Door Game application by pointing your browser to port 81 of the provided IP address. For example:</p><div class="wrap-code highlight"><pre tabindex=0><code>http://52.23.184.60:81</code></pre></div><p>You should be met with The Door Game intro screen:</p><p><a href=#R-image-6c277ac391aad6238257485e4e4e37cf class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/door_game_initial_screen.png alt="Door Game Welcome Screen" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6c277ac391aad6238257485e4e4e37cf><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/door_game_initial_screen.png alt="Door Game Welcome Screen" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Click <code>Let's Play</code> then choose a door:</p><p><a href=#R-image-ff5b026cf02ed20be44d8d35deb74892 class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/door_game_choose_door.png alt="Door Game Choose Door Screen" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ff5b026cf02ed20be44d8d35deb74892><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/door_game_choose_door.png alt="Door Game Choose Door Screen" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Play through a couple of times to get the feel for the application flow&mldr; and then play many times to ensure there are enough spans to create usable Profiling data&mldr;</p><h2 id=view-your-application-in-splunk-observability-cloud>View your application in Splunk Observability Cloud</h2><p>Now that the setup is complete, let&rsquo;s confirm that it&rsquo;s sending data to <strong>Splunk Observability Cloud</strong>. Note that when the application is deployed for the first time, it may take a few minutes for the data to appear.</p><p>Navigate to APM, then use the Environment dropdown to select your environment (i.e. <code>profiling-workshop-name</code>).</p><p>If everything was deployed correctly, you should see <code>doorgame</code> displayed in the list of services:</p><p><a href=#R-image-a7502fada60f99bd619e1048d95955be class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/apm_overview.png alt="APM Overview" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a7502fada60f99bd619e1048d95955be><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/apm_overview.png alt="APM Overview" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Click on <strong>Explore</strong> on the right-hand side to view the service map. We should the <code>doorgame</code> application on the service map:</p><p><a href=#R-image-290a75e51affe274b53a770d2df34665 class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/service_map.png alt="Service Map" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-290a75e51affe274b53a770d2df34665><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/service_map.png alt="Service Map" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Next, click on <strong>Traces</strong> on the right-hand side to see the traces captured for this application. You&rsquo;ll see that some traces run relatively fast (i.e. just a few milliseconds), whereas others take a few seconds.</p><p><a href=#R-image-f456e01acf85850e2f591291ab94b92a class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/traces.png alt=Traces class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f456e01acf85850e2f591291ab94b92a><img src=../../../en/scenarios/2-debug-problems/1-build-application/../images/traces.png alt=Traces class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=enable-cpu-profiling>Enable CPU Profiling</h1><p>Let&rsquo;s learn how to enable the CPU profiler, verify its operation,
and use the results in Splunk Observability Cloud to find out why our application sometimes runs slowly.</p><h3 id=update-the-application-configuration>Update the application configuration</h3><p>We will need to pass an additional configuration argument to the Splunk OpenTelemetry Java agent in order to
enable the profiler. The configuration is <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/java/instrumentation/instrument-java-application.html#activate-alwayson-profiling target=_blank>documented here</a>
in detail, but for now we just need one single setting:</p><p><code>SPLUNK_PROFILER_ENABLED="true"</code></p><p>Since our application is deployed in Kubernetes, we can update the Kubernetes manifest file to set this environment variable. Open the <code>doorgame/doorgame.yaml</code> file for editing, and ensure the value of the <code>SPLUNK_PROFILER_ENABLED</code> environment variable is set to &ldquo;true&rdquo;:</p><div class="wrap-code highlight"><pre tabindex=0><code>- name: SPLUNK_PROFILER_ENABLED
  value: &#34;true&#34;</code></pre></div><p>Next, let&rsquo;s redeploy the Door Game application by running the following command:</p><div class="wrap-code highlight"><pre tabindex=0><code>cd workshop/profiling
./4-redeploy-doorgame.sh</code></pre></div><p>After a few minutes, a new pod will be deployed with the updated application settings.</p><h3 id=confirm-operation>Confirm operation</h3><p>To ensure the profiler is enabled, let&rsquo;s review the application logs with the following commands:</p><div class="wrap-code highlight"><pre tabindex=0><code>kubectl logs -l app=doorgame --tail=100 | grep JfrActivator</code></pre></div><p>You should see a line in the application log output that shows the profiler is active:</p><div class="wrap-code highlight"><pre tabindex=0><code>[otel.javaagent 2024-02-05 19:01:12:416 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.```</code></pre></div><p>This confirms that the profiler is enabled and sending data to the OpenTelemetry collector deployed in our Kubernetes cluster, which in turn sends profiling data to Splunk Observability Cloud.</p><h3 id=profiling-in-apm>Profiling in APM</h3><p>Visit <code>http://&lt;your IP address>:81</code> and play a few more rounds of The Door Game.</p><p>Then head on over to Splunk Observability Cloud, click on APM,
and click on the <code>doorgame</code> service at the bottom of the screen.</p><p>In the rightmost column you should see the &ldquo;AlwaysOn Profiling&rdquo;
card that looks similar to this:</p><p><a href=#R-image-aafa86b0445a6e16bd895f87b9a9194f class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/always-on-profiling.png alt="AlwaysOn Profiling" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-aafa86b0445a6e16bd895f87b9a9194f><img src=../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/always-on-profiling.png alt="AlwaysOn Profiling" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Click the card title to go to the AlwaysOn Profiling view. It will look something
like this:</p><p><a href=#R-image-43250c6d80c1809fc90c03a64eca1043 class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/flamegraph_and_table.png alt="Flamegraph and table" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-43250c6d80c1809fc90c03a64eca1043><img src=../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/flamegraph_and_table.png alt="Flamegraph and table" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>By default, we show both the table and <a href=https://www.brendangregg.com/flamegraphs.html target=_blank>flamegraph</a>.
Take some time to explore this view by doing some of the following:</p><ul><li>toggle between flamegraph and table views</li><li>click a table item and notice the change in flamegraph</li><li>navigate the flamegraph by clicking on a stack frame to zoom in, and a parent frame to zoom out</li><li>add a search term like <code>splunk</code> or <code>jetty</code> to highlight some matching stack frames</li></ul><p>We should note that the sample app is greatly underutilized and most of the time
is spent waiting for user input and service requests. As a result, the flame graph
should be somewhat less interesting than a high-volume, real-world production service.</p><h3 id=traces-with-call-stacks>Traces with Call Stacks</h3><p>Now that we&rsquo;ve seen the profiling view, let&rsquo;s go back to the trace list view. We want to find a
trace that was long enough so that we increase the chance of having sampled call stacks.
If you haven&rsquo;t already, you should play The Door Game enough to stick with door 3
(either by choosing it initially and staying, or choosing another door and switching when given the chance).
You&rsquo;ll notice that it&rsquo;s slow, and it should show up at around 5s in the trace list view:</p><p><a href=#R-image-84c5fb1c30da069660e4aacbc31f4b98 class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/slow_trace.png alt="Slow Trace" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-84c5fb1c30da069660e4aacbc31f4b98><img src=../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/slow_trace.png alt="Slow Trace" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Identify the slow trace in the trace list view and click it to view the
individual trace. In the single trace view, you should see that the innermost span
<code>DoorGame.getOutcome</code> is responsible for the entire slow duration of the span.
There should be 2 call stacks sampled during the execution of that span.</p><p><a href=#R-image-bbed99edcbac5285b64620a5008cc69e class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/span_with_stacks.png alt="Span with Stacks" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bbed99edcbac5285b64620a5008cc69e><img src=../../../en/scenarios/2-debug-problems/2-enable-cpu-profiling/../images/span_with_stacks.png alt="Span with Stacks" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>If you&rsquo;re up for the challenge, expand the span and explore the Java stack frames on your own
before we tackle it in the next section.</p><h2 id=what-did-we-accomplish>What did we accomplish?</h2><p>We&rsquo;ve come a long way already!</p><ul><li>We learned how to enable the profiler in the Splunk OpenTelemetry Java instrumentation agent.</li><li>We learned how to verify in the agent output that the profiler is enabled.</li><li>We have explored several profiling related workflows in APM:<ul><li>How to navigate to AlwaysOn Profiling from the troubleshooting view</li><li>How to explore the flamegraph and method call duration table through navigation and filtering</li><li>How to identify when a span has sampled call stacks associated with it</li></ul></li></ul><p>In the next section, we&rsquo;ll explore the profiling data further to determine what&rsquo;s causing the slowness, and then apply a fix to our application to resolve the issue.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=find-and-fix-application-slowness>Find and Fix Application Slowness</h1><p>In this section, we pick up where we left off last time.
We will use the profiling tool to explore our slow span and link it
back to the source code that caused the slowness. We will update the code to improve
the performance of this span, and we will use the APM profiling tools to verify
that our change is successful.</p><h3 id=exploring-the-span>Exploring the Span</h3><p>At the end of the previous section, we have identified a span that was taking more
than 5 seconds to complete. We observed that the span showed that it was linked
to 2 or more sampled call stacks. Let&rsquo;s proceed by clicking on the span to expand its details.</p><p><a href=#R-image-e4890502e469221fefa4ff8888bfa5ab class=lightbox-link><img src=../../../en/scenarios/2-debug-problems/3-find-and-fix-slowness/../images/view_stack_on_span.png alt="View Stack on Span" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e4890502e469221fefa4ff8888bfa5ab><img src=../../../en/scenarios/2-debug-problems/3-find-and-fix-slowness/../images/view_stack_on_span.png alt="View Stack on Span" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>When a span does not have CPU call stack data, we would normally just see the span details.
(you can drill into the parent stack to see this in action). When we expand the child span, however,
we have the option to see &ldquo;CPU Call Stack&rdquo; data as well.</p><p>At the bottom of the call stack, we can see that the thread was busy sleeping:</p><div class="wrap-code highlight"><pre tabindex=0><code>com.splunk.profiling.workshop.ServiceMain$$Lambda$.handle(Unknown Source:0)
com.splunk.profiling.workshop.ServiceMain.lambda$main$(ServiceMain.java:34)
com.splunk.profiling.workshop.DoorGame.getOutcome(DoorGame.java:41)
com.splunk.profiling.workshop.DoorChecker.isWinner(DoorChecker.java:14)
com.splunk.profiling.workshop.DoorChecker.checkDoorTwo(DoorChecker.java:30)
com.splunk.profiling.workshop.DoorChecker.precheck(DoorChecker.java:36)
com.splunk.profiling.workshop.Util.sleep(Util.java:9)
java.util.concurrent.TimeUnit.sleep(Unknown Source:0)
java.lang.Thread.sleep(Unknown Source:0)
java.lang.Thread.sleep(Native Method:0)</code></pre></div><p>The call stack tells us a story &ndash; reading from the bottom up, it lets us describe
what is happening inside the service code. A developer, even one unfamiliar with the
source code, should be able to look at this call stack to craft a narrative like:</p><blockquote><p>We are getting the outcome of a game. We leverage the DoorChecker to
see if something is the winner, but the check for door two somehow issues
a precheck() that, for some reason, is deciding to sleep for a long time.</p></blockquote><p>Our workshop application is left intentionally simple &ndash; a real-world service might see the
thread being sampled during a database call or calling into an un-traced external service.
It is also possible that a slow span is executing a complicated business process,
in which case maybe none of the stack traces relate to each other at all.</p><p>The longer a method or process is, the greater chance we will have call stacks
sampled during its execution.</p><h3 id=lets-fix-that-bug>Let&rsquo;s Fix That Bug</h3><p>By using the profiling tool, we were able to determine that our application is slow
when issuing the <code>DoorChecker.precheck()</code> method from inside <code>DoorChecker.checkDoorTwo()</code>.
Let&rsquo;s open the <code>doorgame/src/main/java/com/splunk/profiling/workshop/DoorChecker.java</code> source file in our editor.</p><p>By quickly glancing through the file, we see that there are methods for checking
each door, and all of them call <code>precheck()</code>. In a real service, we might be uncomfortable
simply removing the <code>precheck()</code> call because there could be unseen/unaccounted side
effects.</p><p>Down on line 29 we see the following:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>checkDoorTwo</span><span class=o>(</span><span class=n>GameInfo</span> <span class=n>gameInfo</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>precheck</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gameInfo</span><span class=o>.</span><span class=na>isWinner</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>precheck</span><span class=o>(</span><span class=kt>int</span> <span class=n>doorNum</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>extra</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span><span class=n>Math</span><span class=o>.</span><span class=na>pow</span><span class=o>(</span><span class=mi>70</span><span class=o>,</span> <span class=n>doorNum</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=o>(</span><span class=mi>300</span> <span class=o>+</span> <span class=n>extra</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span></span></span></code></pre></div><p>With our developer hat on, we notice that the door number is zero based, so
the first door is 0, the second is 1, and the 3rd is 2 (this is conventional).
The <code>extra</code> value is used as extra/additional sleep time, and it is computed by taking
<code>70^doorNum</code> (<code>Math.pow</code> performs an exponent calculation). That&rsquo;s odd, because this means:</p><ul><li>door 0 => 70^0 => 1ms</li><li>door 1 => 70^1 => 70ms</li><li>door 2 => 70^2 => 4900ms</li></ul><p>We&rsquo;ve found the root cause of our slow bug! This also explains why the first two doors
weren&rsquo;t ever very slow.</p><p>We have a quick chat with our product manager and team lead, and we agree that the <code>precheck()</code>
method must stay but that the extra padding isn&rsquo;t required. Let&rsquo;s remove the <code>extra</code> variable
and make <code>precheck</code> now read like this:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>precheck</span><span class=o>(</span><span class=kt>int</span> <span class=n>doorNum</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=o>(</span><span class=mi>300</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span></span></span></code></pre></div><p>Now all doors will have a consistent behavior. Save your work and then rebuild and redeploy the application using the following command:</p><div class="wrap-code highlight"><pre tabindex=0><code>cd workshop/profiling
./4-redeploy-doorgame.sh</code></pre></div><p>Once the application has been redeployed successfully, visit The Door Game again to confirm that your fix is in place:
<code>http://&lt;your IP address>:81</code></p><h2 id=what-did-we-accomplish>What did we accomplish?</h2><ul><li>We learned how to view a series of call stacks captured during a Span.</li><li>We learned how the call stack can tell us a story and point us to suspect lines of code.</li><li>We identified the slow code and fixed it to make it faster.</li></ul><p>In the next section, we&rsquo;ll explore how to enable the memory profiling component of AlwaysOn Profiling, which can tell us which objects are consuming the most heap memory.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=enable-memory-profiling>Enable Memory Profiling</h1><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=find-and-fix-memory-issues>Find and Fix Memory Issues</h1><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=find-and-fix-database-issues>Find and Fix Database Issues</h1><footer class=footline></footer></article></section></div></main></div><script src=../../../js/clipboard.min.js?1707220492 defer></script>
<script src=../../../js/perfect-scrollbar.min.js?1707220492 defer></script>
<script src=../../../js/theme.js?1707220492 defer></script></body></html>