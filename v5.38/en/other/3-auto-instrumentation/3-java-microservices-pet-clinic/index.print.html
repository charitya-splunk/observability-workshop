<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta name=generator content="Relearn 5.23.2+tip"><meta name=description content="Learn how to enable Open Telemetry (Auto) Instrumentation for your Java-based application running in Kubernetes. Experience real-time monitoring and troubleshooting to help you maximize application behavior with end-to-end visibility."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Workshop using the Java microservices Pet Clinic demo (Kubernetes based). :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="Learn how to enable Open Telemetry (Auto) Instrumentation for your Java-based application running in Kubernetes. Experience real-time monitoring and troubleshooting to help you maximize application behavior with end-to-end visibility."><meta property="og:title" content="Workshop using the Java microservices Pet Clinic demo (Kubernetes based). :: Splunk Observability Cloud Workshops"><meta property="og:description" content="Learn how to enable Open Telemetry (Auto) Instrumentation for your Java-based application running in Kubernetes. Experience real-time monitoring and troubleshooting to help you maximize application behavior with end-to-end visibility."><meta property="og:type" content="website"><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.38/en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><title>Workshop using the Java microservices Pet Clinic demo (Kubernetes based). :: Splunk Observability Cloud Workshops</title><link href=https://splunk.github.io/observability-workshop/v5.38/en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/index.html rel=canonical type=text/html title="Workshop using the Java microservices Pet Clinic demo (Kubernetes based). :: Splunk Observability Cloud Workshops"><link href=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/index.xml rel=alternate type=application/rss+xml title="Workshop using the Java microservices Pet Clinic demo (Kubernetes based). :: Splunk Observability Cloud Workshops"><link href=../../../../images/favicon.ico?1706259254 rel=icon type=image/x-icon sizes=any><link href=../../../../css/fontawesome-all.min.css?1706259260 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fontawesome-all.min.css?1706259260 rel=stylesheet></noscript><link href=../../../../css/nucleus.css?1706259260 rel=stylesheet><link href=../../../../css/auto-complete.css?1706259260 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/auto-complete.css?1706259260 rel=stylesheet></noscript><link href=../../../../css/perfect-scrollbar.min.css?1706259260 rel=stylesheet><link href=../../../../css/fonts.css?1706259260 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../../../../css/fonts.css?1706259260 rel=stylesheet></noscript><link href=../../../../css/theme.css?1706259260 rel=stylesheet><link href=../../../../css/theme-splunk-light.css?1706259260 rel=stylesheet id=R-variant-style><link href=../../../../css/variant.css?1706259260 rel=stylesheet><link href=../../../../css/print.css?1706259260 rel=stylesheet media=print><link href=../../../../css/format-print.css?1706259260 rel=stylesheet><link href=../../../../css/ie.css?1706259260 rel=stylesheet><script src=../../../../js/url.js?1706259260></script>
<script src=../../../../js/variant.js?1706259260></script>
<script>window.index_js_url="../../../../en/index.search.js";var root_url="../../../../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://splunk.github.io/observability-workshop/v5.38/",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script>
<script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script>
<script>SplunkRum.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rum",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g",app:"observability-workshop",version:"1",environment:"observability-workshop-env"}),SplunkSessionRecorder.init({beaconUrl:"https://rum-ingest.eu0.signalfx.com/v1/rumreplay",rumAuth:"EDIbCJR4LlxWdXMLjkYX1g"})</script><style>@media screen and (min-width:1000px){#R-body .flex-block-wrapper{margin-left:auto;margin-right:auto;max-width:1400px;width:100%}}:root{--MENU-WIDTH-L:22.5rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)">
<i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/other/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=../../../../en/other/3-auto-instrumentation/index.html><span itemprop=name>Auto-Instrumentation Workshops</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Workshop using the Java microservices Pet Clinic demo (Kubernetes based).</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=workshop-using-the-java-microservices-pet-clinic-demo-kubernetes-based>Workshop using the Java microservices Pet Clinic demo (Kubernetes based).</h1><p>The goal of this workshop is to introduce the features of Splunk&rsquo;s Opentelemetry Java Auto instrumentation.
First we walk through the basic steps to enable auto-instrumentation for an existing Java application running in Kubernetes so it will start sending Opentelemetry signals to <strong>Splunk Observability Cloud</strong> platform and enable the following components:</p><ul><li>Splunk Infrastructure Monitoring (IM)</li><li>Splunk Auto Instrumentation for Java (APM)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li><li>Splunk Real User Monitoring (RUM)</li><li>RUM to APM Correlation</li><li>Splunk Log Observer (LO)</li></ul><p>We will show the steps about how to clone (download) a sample microservices Java application (Spring PetClinic), as well as how to compile, package and deploy/run the application.</p><p>Once the application is up and running, and auto instrumentation is enabled we will instantly start seeing metrics and traces via the <strong>Auto Instrumentation</strong> for Java that will be used by the <strong>Splunk APM</strong> product.</p><p>We also will examine Alwayson Profiling and Database Query performance.</p><p>After that, we will instrument PetClinic&rsquo;s end user interface (HTML pages rendered by the application) with the <strong>Splunk OpenTelemetry Javascript Libraries (RUM)</strong> that will generate RUM traces around all the individual clicks and page loads executed by an end user.</p><p>Lastly, we will configure the Spring PetClinic application to write application logs to the filesystem and also configure the Splunk OpenTelemetry Collector to read (tail) the logs and send them to <strong>Splunk Cloud</strong>.</p><p><div class="box notices cstyle primary"><div class=box-label><i class="fa-fw fas fa-info"></i> Prerequisites</div><div class=box-content><ul><li>Outbound SSH access to port <code>2222</code>.</li><li>Outbound HTTP access to port <code>81</code>.</li><li>Familiarity with the <code>bash</code> shell and <code>vi/vim/nano</code> editor.</li></ul></div></div><a href=#R-image-3c41381cfe9de72591df16dac86cf3ae class=lightbox-link><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/images/auto-instrumentation-java-diagram.png alt="Splunk Otel Architecture" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3c41381cfe9de72591df16dac86cf3ae><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/images/auto-instrumentation-java-diagram.png alt="Splunk Otel Architecture" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><hr><p>Based on the <a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/examples/enable-operator-and-auto-instrumentation/spring-petclinic-java.md target=_blank>example</a> <strong>Josh Voravong</strong> has created.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Workshop using the Java microservices Pet Clinic demo (Kubernetes based).</h1><article class=default><header class=headline></header><h1 id=preparation-of-the-pet-clinic-application>Preparation of the Pet Clinic application.</h1><h2 id=1-validate-the-settings-for-your-workshop>1. Validate the settings for your workshop</h2><p>To ensure your instance is configured correctly, we need to confirm that the required environment variables for this workshop are set correctly. In your terminal run the following command:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/check_env.sh</span></span></code></pre></div><p>In the output check the following environment variables are present and have values set:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ACCESS_TOKEN
</span></span><span class=line><span class=cl>REALM 
</span></span><span class=line><span class=cl>RUM_TOKEN 
</span></span><span class=line><span class=cl>HEC_TOKEN
</span></span><span class=line><span class=cl>HEC_URL
</span></span><span class=line><span class=cl>INSTANCE</span></span></code></pre></div><p>Please make a note of the <code>INSTANCE</code> environment variable value as this is the reference to you workshop instance and we will need it to filter the data in the <strong>Splunk Observability Suite</strong> UI.</p><p>For this workshop, <strong>all</strong> of the above are required. If any are missing, please contact your instructor.</p><h2 id=2-deploying-the-prebuilt-containers-into-kubernetes>2. Deploying the prebuilt containers into Kubernetes</h2><p>The second thing we need to do, well &mldr;, is to set up our application. The first deployment of our application will be using prebuilt containers to give us the base scenario: a regular Java microservices-based application running in Kubernetes.</p><p>So let&rsquo;s deploy our application:<div class=tab-panel data-tab-group=ee663fe93a5b202a280aed5e71712d58><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-apply class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("ee663fe93a5b202a280aed5e71712d58","kubectl-apply")'>
<span class=tab-nav-text>kubectl apply</span></button>
<button data-tab-item=kubectl-apply-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("ee663fe93a5b202a280aed5e71712d58","kubectl-apply-output")'>
<span class=tab-nav-text>kubectl apply Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-apply class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/petclinic-deploy.yaml</span></span></code></pre></div></div></div><div data-tab-item=kubectl-apply-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server created
</span></span><span class=line><span class=cl>service/config-server created
</span></span><span class=line><span class=cl>deployment.apps/discovery-server created
</span></span><span class=line><span class=cl>service/discovery-server created
</span></span><span class=line><span class=cl>deployment.apps/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway-external created
</span></span><span class=line><span class=cl>deployment.apps/customers-service created
</span></span><span class=line><span class=cl>service/customers-service created
</span></span><span class=line><span class=cl>deployment.apps/vets-service created
</span></span><span class=line><span class=cl>service/vets-service created
</span></span><span class=line><span class=cl>deployment.apps/visits-service created
</span></span><span class=line><span class=cl>service/visits-service created
</span></span><span class=line><span class=cl>deployment.apps/admin-server created
</span></span><span class=line><span class=cl>service/admin-server created
</span></span><span class=line><span class=cl>service/petclinic-db created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-db created
</span></span><span class=line><span class=cl>configmap/petclinic-db-initdb-config created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-loadgen-deployment created
</span></span><span class=line><span class=cl>configmap/scriptfile created</span></span></code></pre></div></div></div></div></div></p><p>At this point we can verify the deployment by checking if the Pods are running:<div class=tab-panel data-tab-group=8ddf7542510bfcae038d8d4b74c67181><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("8ddf7542510bfcae038d8d4b74c67181","kubectl-get-pods")'>
<span class=tab-nav-text>kubectl get pods</span></button>
<button data-tab-item=kubectl-get-pods-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("8ddf7542510bfcae038d8d4b74c67181","kubectl-get-pods-output")'>
<span class=tab-nav-text>kubectl get pods Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=kubectl-get-pods-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                           READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>config-server-7645d4449f-kdwh6                 1/1     Running   0          86s
</span></span><span class=line><span class=cl>petclinic-db-64d998bb66-n2464                  1/1     Running   0          85s
</span></span><span class=line><span class=cl>discovery-server-6f4c756dff-nx8tl              1/1     Running   0          86s
</span></span><span class=line><span class=cl>admin-server-8f67bdf56-tcpkl                   1/1     Running   0          85s
</span></span><span class=line><span class=cl>customers-service-74f5cf6d6f-nhkxh             1/1     Running   0          86s
</span></span><span class=line><span class=cl>vets-service-6869959674-nb67v                  1/1     Running   0          86s
</span></span><span class=line><span class=cl>visits-service-6f9d987c85-4476j                1/1     Running   0          85s
</span></span><span class=line><span class=cl>api-gateway-6ddcf94c5f-k2ccg                   1/1     Running   0          86s
</span></span><span class=line><span class=cl>petclinic-loadgen-deployment-994b69695-8rd9k   1/1     Running   0          85s</span></span></code></pre></div></div></div></div></div></p><p>Make sure the output of get pods matches the output as shown above. This may take a minute or so, try again until all services are shown as <strong>RUNNING</strong>.</p><p>Once they are running, the application will take a few minutes to fully start up, create the database and synchronize all the services, so let&rsquo;s get the actual source code for the application downloaded in the mean-time.</p><h2 id=2-downloading-the-spring-microservices-petclinic-application>2. Downloading the Spring Microservices PetClinic Application</h2><p>For this exercise, we will use the Spring microservices PetClinic application. This is a very popular sample Java application built with the Spring framework (Springboot) and we are using a version witch actual microservices.</p><p>First, clone the PetClinic GitHub repository, as we will need this later in the workshop to compile, build, package and containerize the application:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~
</span></span><span class=line><span class=cl>git clone https://github.com/hagen-p/spring-petclinic-microservices.git</span></span></code></pre></div><p>Change into the <code>spring-petclinic</code> directory:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/spring-petclinic-microservices</span></span></code></pre></div><p>Next, lets test the download and run the script that will use the <code>maven</code> command to compile/build the PetClinic microservices:<div class=tab-panel data-tab-group=dc96f728c15c6377013a392402f6978c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=running-maven class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("dc96f728c15c6377013a392402f6978c","running-maven")'>
<span class=tab-nav-text>Running maven</span></button>
<button data-tab-item=maven-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("dc96f728c15c6377013a392402f6978c","maven-output")'>
<span class=tab-nav-text>Maven Output</span></button></div><div class=tab-content-container><div data-tab-item=running-maven class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw clean install -DskipTests</span></span></code></pre></div></div></div><div data-tab-item=maven-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Reactor Summary:
</span></span><span class=line><span class=cl>[INFO]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-microservices 0.0.1 ............... SUCCESS [  0.552 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-admin-server ...................... SUCCESS [ 16.125 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-customers-service ................. SUCCESS [  6.204 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-vets-service ...................... SUCCESS [  1.791 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-visits-service .................... SUCCESS [  1.696 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-config-server ..................... SUCCESS [  1.466 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-discovery-server .................. SUCCESS [  1.797 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-api-gateway 0.0.1 ................. SUCCESS [ 13.999 s]
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] BUILD SUCCESS
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Total time: 45.431 s
</span></span><span class=line><span class=cl>[INFO] Finished at: 2024-01-10T13:56:53Z
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------</span></span></code></pre></div></div></div></div></div></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>This will take a few minutes the first time you run, <code>maven</code> will download a lot of dependencies before it compiles the application. Future builds will be a lot quicker.</p></div></div><h2 id=3-set-up-a-local-docker-repository>3. Set up a local Docker Repository</h2><p>Once we have our Auto instrumentation up and running with the existing containers, we are going to use show some of the additional instrumentation features of Opentelemetry Java. That will be the first time we will touch the source code and add some annotations to it to get even more valuable data from our Java application. Kubernetes will need to pull these new images from somewhere, so let&rsquo;s setup a local repository, so Kubernetes can pull those local images.</p><div class=tab-panel data-tab-group=adb90ac7780b520fbf533ae0a71b8ea5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=install-docker-repository class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("adb90ac7780b520fbf533ae0a71b8ea5","install-docker-repository")'>
<span class=tab-nav-text>Install Docker Repository</span></button>
<button data-tab-item=docker-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("adb90ac7780b520fbf533ae0a71b8ea5","docker-output")'>
<span class=tab-nav-text>Docker Output</span></button></div><div class=tab-content-container><div data-tab-item=install-docker-repository class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -p 5000:5000 --restart<span class=o>=</span>always --name registry registry:2 </span></span></code></pre></div></div></div><div data-tab-item=docker-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Unable to find image &#39;registry:2&#39; locally
</span></span><span class=line><span class=cl>2: Pulling from library/registry
</span></span><span class=line><span class=cl>c926b61bad3b: Pull complete 
</span></span><span class=line><span class=cl>5501dced60f8: Pull complete 
</span></span><span class=line><span class=cl>e875fe5e6b9c: Pull complete 
</span></span><span class=line><span class=cl>21f4bf2f86f9: Pull complete 
</span></span><span class=line><span class=cl>98513cca25bb: Pull complete 
</span></span><span class=line><span class=cl>Digest: sha256:0a182cb82c93939407967d6d71d6caf11dcef0e5689c6afe2d60518e3b34ab86
</span></span><span class=line><span class=cl>Status: Downloaded newer image for registry:2
</span></span><span class=line><span class=cl>a7d52001836504cf1724e9817ad6167a4458a9e73d33a82f11f33681fe2d6c3e</span></span></code></pre></div></div></div></div></div><p>We can see if the repository is up and running by checking the inventory with the below command, it should return an empty list
<strong>{&ldquo;repositories&rdquo;:[]}</strong></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> curl -X GET http://localhost:5000/v2/_catalog </span></span></code></pre></div><h2 id=4-check-the-petshop-website>4. Check the Petshop Website</h2><p>To test the application you need to obtain the public IP address of the instance you are running on. You can do this by running the following command:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl ifconfig.me</span></span></code></pre></div><p>You will see an IP address returned, make a note of this as we will need it to validate that the application is running.</p><p>You can validate if the application is running by visiting <code>http://&lt;IP_ADDRESS>:81</code> (replace <code>&lt;IP_ADDRESS></code> with the IP address you obtained earlier). You should see the PetClinic application running.</p><p><a href=#R-image-2faf4a8a79c9820c813b25aebac203d6 class=lightbox-link><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/10-preparation/../images/petclinic.png alt="Pet shop" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2faf4a8a79c9820c813b25aebac203d6><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/10-preparation/../images/petclinic.png alt="Pet shop" class="lightbox-image noborder lightbox noshadow" loading=lazy></a>
Make sure the application is working correctly by visiting the <strong>All Owners</strong> and <strong>Veterinarians</strong> tabs, you should get a list of names in each case. If your familiar with the Standard version, you will notice a slightly longer response time due to the architecture used.</p><p>We now have our application running in Kubernetes, without an OpenTelemetry Collector deployed, so there is no Observability data in <strong>Splunk Observability Cloud</strong> yet.
Lets go and fix that.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=installing-the-opentelemetry-collector>Installing the OpenTelemetry Collector</h1><h2 id=1-introduction>1. Introduction</h2><p>The Splunk OpenTelemetry Collector is the core component of instrumenting infrastructure and applications. Its role is to collect and send:</p><ul><li>Infrastructure metrics (disk, CPU, memory, etc)</li><li>Application Performance Monitoring (APM) traces</li><li>Profiling data</li><li>Host and Application logs</li></ul><p>To get Observability signals into the <strong>Splunk Observability Cloud</strong> we need to add an OpenTelemetry Collector to our Kubernetes cluster.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Delete any existing OpenTelemetry Collectors</div><div class=box-content><p>If you have completed a Splunk Observability workshop using this EC2 instance, please ensure you have deleted the collector running in Kubernetes before continuing with this workshop. This can be done by running the following command:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></div><h2 id=2-install-the-opentelemetry-collector-using-helm>2. Install the OpenTelemetry Collector using Helm</h2><p>We are going to install the Splunk distribution of the OpenTelemetry Collector in Operator mode using the Splunk Kubernetes Helm Chart for the Opentelemetry collector. First, we need to add the Splunk Helm chart repository to Helm and update so it knows where to find it:</p><div class=tab-panel data-tab-group=a64a7af65b0d5e1527d16701f8958329><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-repo-add class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("a64a7af65b0d5e1527d16701f8958329","helm-repo-add")'>
<span class=tab-nav-text>Helm Repo Add</span></button>
<button data-tab-item=helm-repo-add-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("a64a7af65b0d5e1527d16701f8958329","helm-repo-add-output")'>
<span class=tab-nav-text>Helm Repo Add Output</span></button></div><div class=tab-content-container><div data-tab-item=helm-repo-add class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span class=o>&amp;&amp;</span> helm repo update</span></span></code></pre></div></div></div><div data-tab-item=helm-repo-add-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>Hang tight while we grab the latest from your chart repositories...
</span></span><span class=line><span class=cl>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span class=line><span class=cl>Update Complete. ⎈Happy Helming!⎈</span></span></code></pre></div></div></div></div></div><p>Splunk Observability Cloud offers wizards in the <strong>Splunk Observability Suite</strong> UI to walk you through the setup of the Collector on your infrastructure including Kubernetes, but in interest of time, we will use a setup created earlier. As we want the auto instrumentation to be available, we will install the OpenTelemetry Collector with the OpenTelemetry Collector Helm chart with some additional options:</p><ul><li>&ndash;set=&ldquo;operator.enabled=true&rdquo; - this will install the Opentelemetry operator, that will be used to handle auto instrumentation</li><li>&ndash;set=&ldquo;certmanager.enabled=true&rdquo; - This will install the required certificate manager for the operator.</li><li>&ndash;set=&ldquo;splunkObservability.profilingEnabled=true&rdquo; - This enabled Code profiling via the operator</li></ul><p>To install the collector run the following commands, do <strong>NOT</strong> edit this:</p><div class=tab-panel data-tab-group=1476e3bcf63581d707af29824693a7fc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-install class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("1476e3bcf63581d707af29824693a7fc","helm-install")'>
<span class=tab-nav-text>Helm Install</span></button>
<button data-tab-item=helm-install-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("1476e3bcf63581d707af29824693a7fc","helm-install-output")'>
<span class=tab-nav-text>Helm Install Output</span></button></div><div class=tab-content-container><div data-tab-item=helm-install class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;operator.enabled=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;certmanager.enabled=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.logsEnabled=false&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;logsEngine=otel&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.profilingEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;environment=</span><span class=nv>$INSTANCE</span><span class=s2>-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml</span></span></code></pre></div></div></div><div data-tab-item=helm-install-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Tue Jan  2 13:46:16 2024
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: 1
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Platform endpoint &#34;https://http-inputs-o11y-suite-eu0.stg.splunkcloud.com:443/services/collector/event&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm eu0.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[INFO] You&#39;ve enabled the operator&#39;s auto-instrumentation feature (operator.enabled=true), currently considered ALPHA.
</span></span><span class=line><span class=cl>- Instrumentation library maturity varies (e.g., Java is more mature than Go). For library stability, visit: https://opentelemetry.io/docs/instrumentation/#status-and-releases
</span></span><span class=line><span class=cl>  - Some libraries may be enabled by default. For current status, see: https://github.com/open-telemetry/opentelemetry-operator#controlling-instrumentation-capabilities
</span></span><span class=line><span class=cl>  - Splunk provides best-effort support for native OpenTelemetry libraries, and full support for Splunk library distributions. For used libraries, refer to the values.yaml under &#34;operator.instrumentation.spec&#34;.</span></span></code></pre></div></div></div></div></div><p>You can monitor the progress of the deployment by running <code>kubectl get pods</code> which should typically report a new pod is up and running after about 30 seconds.</p><p>Ensure the status is reported as <strong>Running</strong> before continuing.</p><div class=tab-panel data-tab-group=e32b4f047234b7540c4815136f30ccbb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("e32b4f047234b7540c4815136f30ccbb","kubectl-get-pods")'>
<span class=tab-nav-text>Kubectl Get Pods</span></button>
<button data-tab-item=kubectl-get-pods-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("e32b4f047234b7540c4815136f30ccbb","kubectl-get-pods-output")'>
<span class=tab-nav-text>Kubectl Get Pods Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods<span class=p>|</span>grep splunk-otel </span></span></code></pre></div></div></div><div data-tab-item=kubectl-get-pods-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>splunk-otel-collector-certmanager-cainjector-5c5dc4ff8f-95z49   1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-6d95596898-vjxss              1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-webhook-69f4ff754c-nghxz      1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-6bd5567d95-5f8cj     1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-tspd2                               1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-69d476cb7-j7zwd                  2/2     Running   0          10m</span></span></code></pre></div></div></div></div></div><p>Ensure there are no errors by tailing the logs from the OpenTelemetry Collector pod. The output should look similar to the log output shown in the Output tab below.</p><p>Use the label set by the <code>helm</code> install to tail logs (You will need to press <code>ctrl + c</code> to exit). Or use the installed <code>k9s</code> terminal UI for bonus points!</p><div class=tab-panel data-tab-group=e78593514e84d00c0bc48b6a47b46875><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-logs class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("e78593514e84d00c0bc48b6a47b46875","kubectl-logs")'>
<span class=tab-nav-text>Kubectl Logs</span></button>
<button data-tab-item=kubectl-logs-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("e78593514e84d00c0bc48b6a47b46875","kubectl-logs-output")'>
<span class=tab-nav-text>Kubectl Logs Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-logs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector -f --container otel-collector</span></span></code></pre></div></div></div><div data-tab-item=kubectl-logs-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    service/service.go:364  Starting receivers...
</span></span><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/watcher.go:195       Configured Kubernetes MetadataExporter  {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;, &#34;exporter_name&#34;: &#34;signalfx&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    healthcheck/handler.go:128      Health Check state change       {&#34;component_kind&#34;: &#34;extension&#34;, &#34;component_type&#34;: &#34;health_check&#34;, &#34;component_name&#34;: &#34;health_check&#34;, &#34;status&#34;: &#34;ready&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    service/service.go:267  Everything is ready. Begin running and processing data.
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:59       Starting shared informers and wait for initial cache sync.      {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.281Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:75       Completed syncing shared informer caches.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Deleting a failed installation</div><div class=box-content><p>If you make an error installing the OpenTelemetry Collector you can start over by deleting the installation using:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></div><h2 id=3-verify-the-installation-by-checking-metrics-and-logs>3. Verify the installation by checking Metrics and Logs</h2><p>Once the installation is completed, you can login into the <strong>Splunk Observability Cloud</strong> with the URL provided by the Instructor.
First, Navigate to <strong>Kubernetes Navigator</strong> in the <strong>Infrastructure</strong><a href=#R-image-520030093f24945dfa7dfb1eb999ad97 class=lightbox-link><img src="../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/20-otel-collector/../images/infra-icon.png?classes=inline&amp;height=25px" alt=infra class="figure-image noborder inline lightbox noshadow" style=height:25px;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-520030093f24945dfa7dfb1eb999ad97><img src="../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/20-otel-collector/../images/infra-icon.png?classes=inline&amp;height=25px" alt=infra class="lightbox-image noborder inline lightbox noshadow" loading=lazy></a> section to see the metrics from your cluster in the <strong>K8s nodes</strong> pane. Change the <em>Time</em> filter to the last 15 Minutes (-15m) to focus on the lates data.</p><p>Use the regular filter option at the top of the Navigator and select <code>k8s.cluster.name</code> <strong>(1)</strong> and type or select the cluster name of your workshop instance (you can get the unique part from your cluster name by using the <code>INSTANCE</code> from the output from the shell script you run earlier). (You can also select you cluster by clicking on on its image in the cluster pane.)</p><p>You should see metrics <strong>(3)</strong> & log events <strong>(4)</strong> related to your cluster. Also a <code>Mysql</code> pane <strong>(5)</strong> should appear,when you click on that pane, you can see the MySQL related metrics from you database.</p><p><a href=#R-image-c24ae2cbd9ad75eb1b5b16fde1a788db class=lightbox-link><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/20-otel-collector/../images/navigator.png alt=Navigator class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c24ae2cbd9ad75eb1b5b16fde1a788db><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/20-otel-collector/../images/navigator.png alt=Navigator class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Once you see data flowing for your host, we are then ready to get started with the auto instrumentation component.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=setting-up-zero-configuration-auto-instrumentation-for-apm>Setting up Zero configuration Auto instrumentation for APM</h1><p>In the previous chapter, we enabled the OpenTelemetry Collector for Kubernetes on our cluster and configured it to send metrics both Kubernetes and Mysql metrics to the <strong>Splunk Observability Cloud</strong>. The next step is to enable auto-instrumentation for our Java apps running in the pods in our cluster.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Zero Config Auto Instrumentation</div><div class=box-content><p>It is important to understand that Zero Config Auto instrumentation is designed to get Trace/Span & Profiling data out of your existing application, without requiring you to change your code or requiring to rebuild.</p></div></div><p>For this workshop we will be using the Zero config option of the Opentelemetry Collector in Kubernetes.
This means that the Collector monitors you pods running in Kubernetes, and if they match certain criteria, they will en able auto instrumentation on the pod.</p><p>For Java it is looking for the Kubernetes TAG <code>instrumentation.opentelemetry.io/inject-java\</code> set to <code>true</code></p><h2 id=1-setting-up-java-auto-instrumentation-on-the-first-pod>1. Setting up Java auto instrumentation on the first pod</h2><p>If you enable Zero configuration for a pod, the Collector will attach an initContainer to your existing pod, and restart the pod to activate it.</p><p>To show what happens when you enable Auto instrumentation, lets do a For & After of the content of a pod, the <code>api-gateway</code> in this case:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>The resulting output should say:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div><p>This container is pulled from a remote repository <code>quay.io</code> and was not build to send traces to the <strong>Splunk Observability Cloud</strong></p><p>Lets enable the Java auto instrumentation on the api-gateway service first by adding the <code>inject-java</code> tag to kubernetes with the <code>kubectl patch deployment</code> command.<div class=tab-panel data-tab-group=2234b74f8ea7edfc2a33c9f6baf63c52><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-api-gateway-service class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("2234b74f8ea7edfc2a33c9f6baf63c52","patch-api-gateway-service")'>
<span class=tab-nav-text>Patch api-gateway service</span></button>
<button data-tab-item=kubectl-patch-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2234b74f8ea7edfc2a33c9f6baf63c52","kubectl-patch-output")'>
<span class=tab-nav-text>kubectl patch Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-api-gateway-service class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl patch deployment api-gateway -p <span class=s1>&#39;{&#34;spec&#34;: {&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;instrumentation.opentelemetry.io/inject-java&#34;:&#34;true&#34;}}}} }&#39;</span></span></span></code></pre></div></div></div><div data-tab-item=kubectl-patch-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/api-gateway patched</span></span></code></pre></div></div></div></div></div></p><p>Lets recheck the container(s) in your pod for the after look:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>Next to the original pod from before, you should see an initContainer named <strong>opentelemetry-auto-instrumentation</strong>. ( If you get two api-gateway containers, the original one is still terminating, so give ity a few seconds):</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.30.0
</span></span><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div><h2 id=2-check-the-result-in-splunk-apm>2. Check the result in Splunk APM</h2><p>Once the container is patched it will be restarted, let&rsquo;s go back to the <strong>Splunk Observability Cloud</strong> with the URL provided by the Instructor to check our service.</p><p>First, Navigate to the <strong>APM</strong> <a href=#R-image-3ff6483b48f64834b4551ed0ae935bc6 class=lightbox-link><img src="../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/apm-icon.png?classes=inline&amp;height=25px" alt=APM class="figure-image noborder inline lightbox noshadow" style=height:25px;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3ff6483b48f64834b4551ed0ae935bc6><img src="../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/apm-icon.png?classes=inline&amp;height=25px" alt=APM class="lightbox-image noborder inline lightbox noshadow" loading=lazy></a> section to see the traces from your service in the <strong>Explore</strong> Pane. Use the filter option and change the <em>environment</em> filter <strong>(1)</strong> and search for the name of your workshop instance in the drop down box, it should be the [INSTANCE]-workshop. (where <code>INSTANCE</code> is the value from the shell script you run earlier). Make sure it is the only one selected.
<a href=#R-image-3b2a61ccaefefa85b2cd526fa88288fc class=lightbox-link><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/apm-api-gateway-overview.png alt=apm class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3b2a61ccaefefa85b2cd526fa88288fc><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/apm-api-gateway-overview.png alt=apm class="lightbox-image noborder lightbox noshadow" loading=lazy></a>
You should see the name <strong>(2)</strong> of the service and metrics in the Latency and Request & Errors charts. (You can ignore the Critical Alert, Its caused by the sudden request increase generated by the load generator, It will become the norm in a bit and go away).</p><p>Next, click on <strong>Explore</strong> <strong>(3)</strong> to see the api-gateway service in the automatically generated dependency map and select the api-gateway service.
<a href=#R-image-e2505927804c019e8359c53d7ea2ceb1 class=lightbox-link><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/api-gateway-map.png alt="apm map" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e2505927804c019e8359c53d7ea2ceb1><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/api-gateway-map.png alt="apm map" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><h2 id=3-enable-java-auto-instrumentation-on-all-pods>3. Enable Java auto instrumentation on all pods</h2><p>The above single service, will provide you <em>full fidelity</em> information on the interactions that are happening inside that one single service, something that can be useful, if you are 100% sure the issue you are trying to identify is only happening inside that specific service, independent of any relating services.</p><p>However, the more common scenario is that you need to see the full interaction between all services. So lets patch all the deployments (labeled with <code>app.kubernetes.io/part-of=spring-petclinic</code>) to add the inject annotation.
remember: <strong>This automatically causes pods to restart.</strong></p><p>Note, there will be no change for the <em>api-gateway</em> as we patched it earlier.</p><div class=tab-panel data-tab-group=8621afadeebbaab93b8b05fa04e3300e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-all-petclinic-services class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("8621afadeebbaab93b8b05fa04e3300e","patch-all-petclinic-services")'>
<span class=tab-nav-text>Patch all Petclinic services</span></button>
<button data-tab-item=kubectl-patch-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("8621afadeebbaab93b8b05fa04e3300e","kubectl-patch-output")'>
<span class=tab-nav-text>kubectl patch Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-all-petclinic-services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments -l app.kubernetes.io/part-of<span class=o>=</span>spring-petclinic -o name <span class=p>|</span> xargs -I % kubectl patch % -p <span class=s2>&#34;{\&#34;spec\&#34;: {\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;instrumentation.opentelemetry.io/inject-java\&#34;:\&#34;true\&#34;}}}}}&#34;</span></span></span></code></pre></div></div></div><div data-tab-item=kubectl-patch-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server patched
</span></span><span class=line><span class=cl>deployment.apps/admin-server patched
</span></span><span class=line><span class=cl>deployment.apps/customers-service patched
</span></span><span class=line><span class=cl>deployment.apps/visits-service patched
</span></span><span class=line><span class=cl>deployment.apps/discovery-server patched
</span></span><span class=line><span class=cl>deployment.apps/vets-service patched
</span></span><span class=line><span class=cl>deployment.apps/api-gateway patched (no change)</span></span></code></pre></div></div></div></div></div><p>It will take the Petclinic Microservice application a few minutes to start up and fully synchronise.
Lets monitor the load generator container until its capable to generate load as show in the output tab.</p><div class=tab-panel data-tab-group=79721cf85ff4b2205df20b7e6ab90c8a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=tail-log class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("79721cf85ff4b2205df20b7e6ab90c8a","tail-log")'>
<span class=tab-nav-text>Tail Log</span></button>
<button data-tab-item=tail-log-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("79721cf85ff4b2205df20b7e6ab90c8a","tail-log-output")'>
<span class=tab-nav-text>Tail Log Output</span></button></div><div class=tab-content-container><div data-tab-item=tail-log class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/tail_logs.sh</span></span></code></pre></div></div></div><div data-tab-item=tail-log-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;Welcome Text = &#34;Welcome to Petclinic&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@ALL&#34;
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@owner details page&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@pet details page&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@add pet page&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@veterinarians page&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;cookies was&#34;}</span></span></code></pre></div></div></div></div></div><p>Once the services are fully initialized, you now should see all the different services appear in Splunk APM:
<a href=#R-image-bd520a1ea2f80f28c2fcd6f74699f71d class=lightbox-link><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/apm-full-service.png alt="all services" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bd520a1ea2f80f28c2fcd6f74699f71d><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/apm-full-service.png alt="all services" class="lightbox-image noborder lightbox noshadow" loading=lazy></a>
Of course, we want to check the Dependency map by clicking Explore:
<a href=#R-image-01a478eb03113afcd65b58a1a10034a3 class=lightbox-link><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/apm-map-full.png alt="full map" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-01a478eb03113afcd65b58a1a10034a3><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/30-auto-instrumentation/../images/apm-map-full.png alt="full map" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=log-observer>Log Observer</h1><h2 id=1-introduction>1. Introduction</h2><p>Until this point, we have not touched or changed our code, yet we did receive Trace & Profiling/DB Query performance information.
If we want to get more out of our Java application, we can introduce a small change to our application log setup.</p><p>This change will configure the Spring PetClinic application to use an Otel Based format to write logs, This will allow the (Auto)-instrumentation to add Otel relevant information into the logs.</p><p>The Splunk Log Observer component is used to view the logs and with this information can automatically relate logs information with APM Services and Traces. This feature called <strong>Related Content</strong> will also work with Infra structure.</p><h2 id=2-update-logback-config-for-the-services>2. Update Logback config for the services</h2><p>The Spring PetClinic application can be configured to use several different Java logging libraries. In this scenario, the application is using <code>logback</code>. To make sure we get the otel information in the logs we need to update a file named <code>logback.xml</code> with the log structure, and add an Otel dependency to the <code>pom.xml</code> of each of the services in the petclinic microservices folders.</p><p>First lets set the Log Structure/Format:</p><p>Spring boot will allow you to set a global template, but for ease of use, we will replace the existing content of the <code>logback-spring.xml</code> files of each service with the following XML content using a prepared script:
Note the following entries that will be added:</p><ul><li>trace_id</li><li>span_id</li><li>trace_flags</li><li>service.name</li><li>deployment.environment</li></ul><p>These fields allows the <strong>Splunk Observability Cloud Suite</strong> to display <strong>Related Content</strong>:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;include</span> <span class=na>resource=</span><span class=s>&#34;org/springframework/boot/logging/logback/base.xml&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- Required for Loglevel management into the Spring Petclinic Admin Server--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;jmxConfigurator/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;appender</span> <span class=na>name=</span><span class=s>&#34;CONSOLE&#34;</span> <span class=na>class=</span><span class=s>&#34;ch.qos.logback.core.ConsoleAppender&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;encoder&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;pattern&gt;</span>
</span></span><span class=line><span class=cl>            %d{yyyy-MM-dd HH:mm:ss} - %logger{36} - %msg trace_id=%X{trace_id} span_id=%X{span_id} trace_flags=%X{trace_flags} %n service.name=%property{otel.resource.service.name}, deployment.environment=%property{otel.resource.deployment.environment}: %m%n
</span></span><span class=line><span class=cl>          <span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/encoder&gt;</span> 
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/appender&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- Just wrap your logging appender, for example ConsoleAppender, with OpenTelemetryAppender --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;appender</span> <span class=na>name=</span><span class=s>&#34;OTEL&#34;</span> <span class=na>class=</span><span class=s>&#34;io.opentelemetry.instrumentation.logback.mdc.v1_0.OpenTelemetryAppender&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;appender-ref</span> <span class=na>ref=</span><span class=s>&#34;CONSOLE&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/appender&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=c>&lt;!-- Use the wrapped &#34;OTEL&#34; appender instead of the original &#34;CONSOLE&#34; one --&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;root</span> <span class=na>level=</span><span class=s>&#34;INFO&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>       <span class=nt>&lt;appender-ref</span> <span class=na>ref=</span><span class=s>&#34;OTEL&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;/root&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span></span></span></code></pre></div><p>So lets run the script that will update our log structure with the format above:</p><div class=tab-panel data-tab-group=837eb4f0af156beacee277429a2f482e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=update-logback-files class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("837eb4f0af156beacee277429a2f482e","update-logback-files")'>
<span class=tab-nav-text>Update Logback files</span></button>
<button data-tab-item=replace-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("837eb4f0af156beacee277429a2f482e","replace-output")'>
<span class=tab-nav-text>Replace Output</span></button></div><div class=tab-content-container><div data-tab-item=update-logback-files class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/update_logback.sh</span></span></code></pre></div></div></div><div data-tab-item=replace-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Overwritten /home/ubuntu/spring-petclinic-microservices/spring-petclinic-admin-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/ubuntu/spring-petclinic-microservices/spring-petclinic-api-gateway/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/ubuntu/spring-petclinic-microservices/spring-petclinic-config-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/ubuntu/spring-petclinic-microservices/spring-petclinic-customers-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/ubuntu/spring-petclinic-microservices/spring-petclinic-discovery-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/ubuntu/spring-petclinic-microservices/spring-petclinic-vets-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/ubuntu/spring-petclinic-microservices/spring-petclinic-visits-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Script execution completed.</span></span></code></pre></div></div></div></div></div><p>We can verify if the replacement has been successful by examining the spring-logback.xml file from one of the services</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /home/ubuntu/spring-petclinic-microservices/spring-petclinic-customers-service/src/main/resources/logback-spring.xml</span></span></code></pre></div><h2 id=3-reconfigure-and-build-the-services-locally>3. Reconfigure and build the services locally</h2><p>Before we can build the new services with the updated log format we need to add the dependency to the <code>Pom.xml</code>:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/add_otel.sh</span></span></code></pre></div><p>The Services are now ready to be build, so run the script that will use the <code>maven</code> command to compile/build/package the PetClinic microservices (Note the -P buildDocker, this will build the new containers):<div class=tab-panel data-tab-group=1cf4c7fa34addbcead1095f032c28dc3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=running-maven class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("1cf4c7fa34addbcead1095f032c28dc3","running-maven")'>
<span class=tab-nav-text>Running maven</span></button>
<button data-tab-item=maven-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("1cf4c7fa34addbcead1095f032c28dc3","maven-output")'>
<span class=tab-nav-text>Maven Output</span></button></div><div class=tab-content-container><div data-tab-item=running-maven class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw clean install -D skipTests -P buildDocker</span></span></code></pre></div></div></div><div data-tab-item=maven-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Successfully tagged quay.io/phagen/spring-petclinic-api-gateway:latest
</span></span><span class=line><span class=cl>[INFO] Built quay.io/phagen/spring-petclinic-api-gateway
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Reactor Summary:
</span></span><span class=line><span class=cl>[INFO] 
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-microservices 0.0.1 ............... SUCCESS [  0.770 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-admin-server ...................... SUCCESS [01:03 min]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-customers-service ................. SUCCESS [ 29.031 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-vets-service ...................... SUCCESS [ 22.145 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-visits-service .................... SUCCESS [ 20.451 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-config-server ..................... SUCCESS [ 12.260 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-discovery-server .................. SUCCESS [ 14.174 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-api-gateway 0.0.1 ................. SUCCESS [ 29.832 s]
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] BUILD SUCCESS
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Total time: 03:14 min
</span></span><span class=line><span class=cl>[INFO] Finished at: 2024-01-02T12:43:20Z
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------</span></span></code></pre></div></div></div></div></div></p><p>Given that Kubernetes needs to pull these freshly build images from somewhere, we are going to store them in the repository we set up earlier. To do this, run the script that will push the newly build containers into our local repository:</p><div class=tab-panel data-tab-group=4e3025f81313a3a7b53508c4534eceec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=pushing-containers class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("4e3025f81313a3a7b53508c4534eceec","pushing-containers")'>
<span class=tab-nav-text>pushing Containers</span></button>
<button data-tab-item=docker-push-output-partial class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("4e3025f81313a3a7b53508c4534eceec","docker-push-output-partial")'>
<span class=tab-nav-text>Docker Push Output (partial)</span></button></div><div class=tab-content-container><div data-tab-item=pushing-containers class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/push_docker.sh </span></span></code></pre></div></div></div><div data-tab-item=docker-push-output-partial class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The push refers to repository [localhost:5000/spring-petclinic-vets-service]
</span></span><span class=line><span class=cl>0391386bcb2a: Preparing 
</span></span><span class=line><span class=cl>bbb67f51a186: Preparing 
</span></span><span class=line><span class=cl>105351d0ada3: Preparing 
</span></span><span class=line><span class=cl>49cfeae6cb9f: Preparing 
</span></span><span class=line><span class=cl>b4da5101fcde: Preparing 
</span></span><span class=line><span class=cl>49cfeae6cb9f: Pushed 
</span></span><span class=line><span class=cl>e742c14be110: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>540aa741fede: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>a1dfe59d4939: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>1e99e92c46bf: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>f5aa38537736: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>d2210512edb4: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>8e87ff28f1b5: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>local: digest: sha256:42337b2a4ff7d0ac9b7c2cf3c70aa20b7b52d092f1e05d351e031dd7fad956fc size: 3040
</span></span><span class=line><span class=cl>The push refers to repository [localhost:5000/spring-petclinic-customers-service]
</span></span><span class=line><span class=cl>15d54d9adca8: Preparing 
</span></span><span class=line><span class=cl>886f6def5b35: Preparing 
</span></span><span class=line><span class=cl>1575ae90e858: Preparing 
</span></span><span class=line><span class=cl>ccc884d92d18: Preparing 
</span></span><span class=line><span class=cl>b4da5101fcde: Preparing 
</span></span><span class=line><span class=cl>ccc884d92d18: Pushed 
</span></span><span class=line><span class=cl>e742c14be110: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>540aa741fede: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>a1dfe59d4939: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>1e99e92c46bf: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>f5aa38537736: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>d2210512edb4: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>8e87ff28f1b5: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>local: digest: sha256:3601c6e7f58224001946058fb0400483fbb8f1b0ea8a6dbaf403c62b4c1908be size: 3042</span></span></code></pre></div></div></div></div></div><p>The containers should now be stored in the local repository, lets confirm by checking the catalog,</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> curl -X GET http://localhost:5000/v2/_catalog </span></span></code></pre></div><p>The result should be :</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{&#34;repositories&#34;:[&#34;spring-petclinic-admin-server&#34;,&#34;spring-petclinic-api-gateway&#34;,&#34;spring-petclinic-config-server&#34;,&#34;spring-petclinic-customers-service&#34;,&#34;spring-petclinic-discovery-server&#34;,&#34;spring-petclinic-vets-service&#34;,&#34;spring-petclinic-visits-service&#34;]}</span></span></code></pre></div><h2 id=5-deploy-new-services-to-kubernetes>5. Deploy new services to kubernetes</h2><p>To see the changes in effect, we need to redeploy the services, First let change the location of the images from the external repo to the local one by running the following script:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/set_local.sh</span></span></code></pre></div><p>The result is a new file on disk called <strong>petclinic-local.yaml</strong>
Let switch to the local version by applying the local version of the deployment yaml.
First delete the old deplyment with</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete -f ~/workshop/petclinic/petclinic-local.yaml</span></span></code></pre></div><p>followed by</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/petclinic-local.yaml</span></span></code></pre></div><p>This will cause the containers to be replaced with the local version, you can verify this by checking the containers:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>The resulting output should say ( again if you see double, its the old container being terminated, give it a few seconds):</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.30.0
</span></span><span class=line><span class=cl>  Image:         localhost:5000/spring-petclinic-api-gateway:local</span></span></code></pre></div><h2 id=6-view-logs>6. View Logs</h2><p>First give the service time to get back into sync and lets tail the load generator log again<div class=tab-panel data-tab-group=5d6486d2e9689d3c40b6d0cd412ebca4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=tail-log class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("5d6486d2e9689d3c40b6d0cd412ebca4","tail-log")'>
<span class=tab-nav-text>Tail Log</span></button>
<button data-tab-item=tail-log-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("5d6486d2e9689d3c40b6d0cd412ebca4","tail-log-output")'>
<span class=tab-nav-text>Tail Log Output</span></button></div><div class=tab-content-container><div data-tab-item=tail-log class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/tail_logs.sh</span></span></code></pre></div></div></div><div data-tab-item=tail-log-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;Welcome Text = &#34;Welcome to Petclinic&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@ALL&#34;
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@owner details page&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@pet details page&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@add pet page&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;@veterinarians page&#34;}
</span></span><span class=line><span class=cl>{&#34;severity&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;cookies was&#34;}</span></span></code></pre></div></div></div></div></div></p><p>From the left-hand menu click on <strong>Log Observer</strong> and ensure <strong>Index</strong> is set to <strong>splunk4rookies-workshop</strong>.</p><p>Next, click <strong>Add Filter</strong> search for the field <code>service_name</code> select the value <code>&lt;INSTANCE>-petclinic-service</code> and click <code>=</code> (include). You should now see only the log messages from your PetClinic application.</p><p><a href=#R-image-caf86cade894b878b71c46d8002534f7 class=lightbox-link><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/60-log-observer-connect/../images/log-observer.png alt="Log Observer" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-caf86cade894b878b71c46d8002534f7><img src=../../../../en/other/3-auto-instrumentation/3-java-microservices-pet-clinic/60-log-observer-connect/../images/log-observer.png alt="Log Observer" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><h2 id=7-summary>7. Summary</h2><p>This is the end of the workshop and we have certainly covered a lot of ground. At this point, you should have metrics, traces (APM & RUM), logs, database query performance and code profiling being reported into Splunk Observability Cloud.</p><p><strong>Congratulations!</strong></p><p>docker system prune -a &ndash;volumes</p><p>81 . ~/workshop/petclinic/scripts/add_otel.sh
82 . ~/workshop/petclinic/scripts/update_logback.sh
83 ./mvnw clean install -DskipTests -P buildDocker
84 . ~/workshop/petclinic/scripts/push_docker.sh
85 . ~/workshop/petclinic/scripts/set_local.sh
86 kubectl apply -f ~/workshop/petclinic/petclinic-local.yaml
87 k9s
88 kubectl delete -f ~/workshop/petclinic/petclinic-local.yaml
89 kubectl apply -f ~/workshop/petclinic/petclinic-local.yaml
90 k9s
91 kubectl delete -f ~/workshop/petclinic/petclinic-local.yaml
92 kubectl apply -f ~/workshop/petclinic/petclinic-local.yaml
93 k9s
94 kubectl get deployments -l app.kubernetes.io/part-of=spring-petclinic -o name | xargs -I % kubectl patch % -p &ldquo;{"spec": {"template":{"metadata":{"annotations":{"instrumentation.opentelemetry.io/inject-java":"true"}}}}}&rdquo;</p><footer class=footline></footer></article></section></div></main></div><script src=../../../../js/clipboard.min.js?1706259261 defer></script>
<script src=../../../../js/perfect-scrollbar.min.js?1706259261 defer></script>
<script src=../../../../js/theme.js?1706259261 defer></script></body></html>